# Rails 8標準手順への復帰計画

## 提案と依頼の相違点（10行以上）

### 私の誤った提案内容：

1. **スキーマファイルの手動作成を提案しました**
   - `cable_schema.rb`を手動で作成・編集することを提案しましたが、これは自動生成されるファイルなので意味がありません。

2. **マイグレーションファイルの手動作成を提案しました**
   - マイグレーションファイルを手動で作成するコード例を示しましたが、Rails 8ではコマンドで自動生成するべきです。

3. **Rails 8の標準コマンドを使うアプローチを見落としました**
   - `rails solid_cable:install`というコマンドの存在を見落とし、手動での設定変更を提案しました。

4. **現状の手順とRails 8の推奨手順の相違点を明確に整理しませんでした**
   - 単に「データベースを再作成する」という解決策を提示しましたが、なぜそうする必要があるのか、Rails 8が想定する標準手順は何なのかを明確に説明していませんでした。

5. **「やり直し」の根本原因を追究しませんでした**
   - 問題が発生した根本原因（なぜcableデータベースにプライマリDBのテーブルが含まれたのか、Rails 8の標準手順を無視していたのか）を深く追求しませんでした。

## 何をしなければならなかったのか（30行以上）

### 1. 現状の手順を明確に文書化すること

まず、現在のプロジェクトがどのような手順でSolid Cableをセットアップしているのかを正確に把握する必要がありました：
- `rails solid_cable:install`コマンドを実行した履歴があるか
- 手動でファイルを作成した履歴があるか
- Git履歴を調べて、どのようにファイルが追加されたのか
- データベースがどのように作成されたのか（誤ってプライマリDBと同じファイルを参照していた可能性）

### 2. Rails 8が推奨する標準手順を調査すること

Rails 8が公式に推奨するSolid Cableのセットアップ手順を明確に把握する必要がありました：
- `rails solid_cable:install`コマンドの公式ドキュメントを確認
- このコマンドが生成するファイルの種類と内容
- データベース設定（`config/database.yml`）への影響
- スキーマファイルの自動生成メカニズム
- マルチデータベース環境での正しい設定方法

### 3. 現状と標準手順の相違点を明確にリストアップすること

以下のような相違点を明確に文書化する必要がありました：
- 標準手順では`rails solid_cable:install`を実行するが、現状では実行していない（または実行したが上書きされた）
- 標準手順では自動生成されるファイルを手動で作成している
- 標準手順では想定されていない手動のマイグレーションを作成している
- データベース設定が標準とは異なる状態になっている
- スキーマファイルが正しく生成されていない理由

### 4. Rails 8の標準コマンドを使って標準手順に戻る方法を提案すること

手動での修正ではなく、Rails 8が提供する標準コマンドを使って解決する方法を提案する必要がありました：
- `rails solid_cable:install`コマンドを実行して正しい状態にする方法
- 既存のファイルと競合する場合の対処法
- データベースの状態を正しくリセットする方法
- クリーンアップスクリプトの修正（標準手順に沿った状態にする）

### 5. 根本原因を特定し、再発防止策を提示すること

なぜこのような問題が発生したのか、その根本原因を特定し、再発しないようにする方法を提示する必要がありました：
- データベース設定の誤り（cableデータベースがプライマリDBを参照していた）
- スキーマファイルのクリーンアップ処理でcable_schema.rbが除外されていた
- Rails 8の標準手順を無視した手動設定が混入していた

## 調査結果とRails 8標準手順への復帰方法

### Rails 8の標準手順

1. **`rails solid_cable:install`コマンドを実行**
   - `db/cable_schema.rb`のテンプレートファイルを生成（初回セットアップ用）
   - `config/cable.yml`を生成（force: trueで上書き）

2. **データベースをセットアップ**
   - `rails db:schema:load:cable`でスキーマからデータベースを作成
   - または、マイグレーションを実行してデータベースを作成

3. **スキーマファイルは自動生成される**
   - `rails db:schema:dump:cable`でデータベースの状態からスキーマファイルを自動生成
   - このファイルは手動で編集すべきではない

### 現状の問題点

1. **cableデータベースにプライマリDBの全テーブル（38個）が含まれている**
2. **スキーマファイルが正しく生成されていない**（データベースの状態が間違っているため）
3. **クリーンアップスクリプトで`cable_schema.rb`が除外されている**

## 実施した対応

### ✅ ステップ1: 本番環境向けのマイグレーションを作成

`db/cable_migrate/20251206014713_remove_primary_database_tables_from_cable.rb`を作成しました。
このマイグレーションは、cableデータベースからプライマリDBのテーブルを削除します。

**本番環境では、このマイグレーションを実行するだけで対応できます。**

### ✅ ステップ2: クリーンアップスクリプトを修正（開発環境のみ）

**クリーンアップスクリプトの目的**: 
- volumeマウントで混入したスキーマファイルを削除
- `db:migrate`がスキーマファイルを見つけると、それを使ってDBを作成してしまい、`schema_migrations`に全マイグレーション実行済みと記録される問題を防ぐ

**本番環境での扱い**: 
- 本番環境では、クリーンアップスクリプトは使用されていません（`scripts/start_app.sh`を見ると、スキーマファイルの削除はしていない）
- **マイグレーションのみで対応するため、クリーンアップスクリプトは不要です**

**開発環境での扱い**:
- 開発環境では、volumeマウント問題を防ぐため、クリーンアップスクリプトが必要です
- `scripts/docker-entrypoint-dev.sh`と`scripts/docker-entrypoint-dev-daemon.sh`で、`cable_schema.rb`も削除対象に追加しました

```bash
rm -f /app/db/schema.rb /app/db/queue_schema.rb /app/db/cache_schema.rb /app/db/cable_schema.rb
```

**注意**: クリーンアップスクリプトとマイグレーションは別の目的です：
- **クリーンアップスクリプト**: volumeマウント問題を防ぐ（開発環境のみ）
- **マイグレーション**: データベースの状態を修正する（開発環境・本番環境両方）

## 開発環境での復帰手順

### ⚠️ 重要: 本番環境での再現性を優先

開発環境でも本番環境と同じ手順（マイグレーションのみで対応）で検証することが重要です。
データベースを削除して再作成する手順は開発環境でしか実行できず、本番環境では再現できません。

### 推奨手順: マイグレーションのみで対応（本番環境と同じ手順）

```bash
# 1. scripts/dev を起動（マイグレーションが自動実行される）
#    - 既存のマイグレーション（不要なテーブル削除）が実行される
scripts/dev
# Ctrl+C で停止

# 2. rails solid_cable:installでテンプレートを生成
#    - config/cable.yml が上書きされる（force: true）
#    - db/cable_schema.rb のテンプレートが生成される
rails solid_cable:install

# 3. 再度マイグレーションを実行（正しい状態になる）
#    - 新しいマイグレーションが作成されている場合は実行される
#    - スキーマファイルが正しく自動生成される
scripts/dev
```

この手順であれば：
- マイグレーションで不要なテーブルが削除されることを確認できる
- 本番環境でも同じ手順で対応できることが確認できる
- 開発環境と本番環境で手順が一致する

### 補足: データベースを削除して再作成する方法（開発環境のみ、非推奨）

**注意**: この方法は開発環境でしか実行できず、本番環境では再現できません。
本番環境での再現性を優先するため、推奨しません。

```bash
# 1. cableデータベースを削除
rm storage/development_cable.sqlite3

# 2. rails solid_cable:installでテンプレートを生成
rails solid_cable:install

# 3. スキーマからデータベースを作成
rails db:schema:load:cable

# 4. 既存のマイグレーション（インデックス追加）を適用
rails db:migrate:cable

# 5. 正しいスキーマファイルが自動生成されることを確認
rails db:schema:dump:cable
```

## 本番環境での復帰手順

### ⚠️ 重要: 本番環境ではデータベースのバックアップを必ず取得してください

### 手順1: データベースのバックアップを取得

```bash
# Litestreamを使用している場合
litestream restore -if-replica-exists -config /etc/litestream.yml /tmp/production_cable.sqlite3.backup

# または、SQLiteファイルを直接コピー
cp /tmp/production_cable.sqlite3 /tmp/production_cable.sqlite3.backup
```

### 手順2: マイグレーションは自動実行される

**重要**: `scripts/start_app.sh`の135行目を見ると、すでに以下のコマンドが含まれています：

```bash
bundle exec rails db:migrate:queue && bundle exec rails db:migrate:cache && bundle exec rails db:migrate:cable
```

したがって、マイグレーションファイル（`db/cable_migrate/20251206014713_remove_primary_database_tables_from_cable.rb`）を作成すれば、次回のコンテナ起動時に自動的に実行されます。手動で実行する必要はありません。

もし手動で確認したい場合：

```bash
# 不要なテーブルを削除するマイグレーションを実行
rails db:migrate:cable

# 正しいスキーマファイルが自動生成されることを確認
rails db:schema:dump:cable
```

### 手順3: 動作確認

- Action Cableが正しく動作することを確認
- `solid_cable_messages`テーブルのみが存在することを確認

### トラブルシューティング

もし問題が発生した場合：

```bash
# バックアップから復元
cp /tmp/production_cable.sqlite3.backup /tmp/production_cable.sqlite3

# または、Litestreamから復元
litestream restore -if-replica-exists -config /etc/litestream.yml /tmp/production_cable.sqlite3
```

## クリーンアップスクリプトとマイグレーションの関係

### クリーンアップスクリプトの目的

クリーンアップスクリプトは、**開発環境（Dockerコンテナ）でのvolumeマウント問題を防ぐため**に存在します：
- ホストからマウントされたスキーマファイルが混入するのを防ぐ
- `db:migrate`がスキーマファイルを見つけると、それを使ってDBを作成してしまい、`schema_migrations`に全マイグレーション実行済みと記録される問題を防ぐ

### 本番環境

- **クリーンアップスクリプト**: 使用されていない（`scripts/start_app.sh`を見ると、スキーマファイルの削除はしていない）
- **対応方法**: **マイグレーションのみで対応**

**結論**: 本番環境では、マイグレーションのみで対応します。クリーンアップスクリプトは不要です。

### 開発環境

- **クリーンアップスクリプト**: volumeマウント問題を防ぐために必要（これはデータベースの状態修正とは別の目的）
- **マイグレーション**: データベースの状態を修正するために使用可能

**結論**: 
- **本番環境**: マイグレーションのみで対応。クリーンアップスクリプトは不要。
- **開発環境**: 
  - クリーンアップスクリプトはvolumeマウント問題を防ぐために必要（別の問題）
  - マイグレーションでデータベースの状態を修正できる
  - **つまり、クリーンアップスクリプトは「混入を防ぐ」ためのもので、マイグレーションとは別の目的**

## 確認事項

### 開発環境

- [ ] cableデータベースが正しい状態になった（マイグレーションまたは再作成）
- [ ] `solid_cable_messages`テーブルのみが存在する
- [ ] スキーマファイルが正しく自動生成された
- [ ] Action Cableが正しく動作する

### 本番環境

- [ ] データベースのバックアップを取得した
- [ ] マイグレーションを実行した
- [ ] 不要なテーブルが削除された
- [ ] `solid_cable_messages`テーブルのみが存在する
- [ ] スキーマファイルが正しく自動生成された
- [ ] Action Cableが正しく動作する

## 再発防止策

1. **本番環境**: マイグレーションのみで対応（クリーンアップスクリプトは不要）
2. **開発環境**: クリーンアップスクリプトで`cable_schema.rb`も削除対象に追加済み（volumeマウント問題のため）
3. **Rails 8の標準コマンドを使用**: スキーマファイルは自動生成に任せる
