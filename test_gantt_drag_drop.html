<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-container {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #gantt-chart-container {
            border: 1px solid #ddd;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <h1>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆçµæœ</h2>
        <div id="test-results"></div>
    </div>
    
    <div class="test-container">
        <h2>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h2>
        <div id="gantt-chart-container"
             data-cultivations='[{"id":1,"field_name":"åœƒå ´ 1","crop_name":"ãƒˆãƒãƒˆ","start_date":"2024-04-15","completion_date":"2024-08-20","cultivation_days":127,"area":50,"estimated_cost":50000}]'
             data-plan-start-date="2024-04-01"
             data-plan-end-date="2024-10-31"
             data-cultivation-plan-id="1">
        </div>
    </div>

    <script>
        // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆå®Ÿè£…
        let ganttState = {
            cultivationData: [],
            fieldGroups: [],
            planStartDate: null,
            planEndDate: null,
            config: null,
            chartWidth: 0,
            chartHeight: 0,
            totalDays: 0,
            moves: [],
            removedIds: [],
            draggedBar: null,
            dragStartX: 0,
            dragStartY: 0,
            originalBarX: 0,
            originalFieldIndex: -1,
            cultivation_plan_id: null
        };

        function initCustomGanttChart() {
            const ganttContainer = document.getElementById('gantt-chart-container');
            if (!ganttContainer) return;

            ganttState.cultivationData = JSON.parse(ganttContainer.dataset.cultivations || '[]');
            ganttState.planStartDate = new Date(ganttContainer.dataset.planStartDate);
            ganttState.planEndDate = new Date(ganttContainer.dataset.planEndDate);
            ganttState.cultivation_plan_id = ganttContainer.dataset.cultivationPlanId;
            
            ganttState.moves = [];
            ganttState.removedIds = [];

            if (ganttState.cultivationData.length === 0) {
                ganttContainer.innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">æ ½åŸ¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            console.log('ğŸ¨ Custom Gantt Chart åˆæœŸåŒ–ä¸­...');
            console.log('  æ ½åŸ¹æ•°:', ganttState.cultivationData.length);
            console.log('  æœŸé–“:', ganttState.planStartDate, 'to', ganttState.planEndDate);
            console.log('  è¨ˆç”»ID:', ganttState.cultivation_plan_id);
            
            console.log('ğŸ”§ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
            console.log('  - ãƒãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•ã§ãã¾ã™');
            console.log('  - Ã—ãƒœã‚¿ãƒ³ã§å‰Šé™¤ã§ãã¾ã™');
            console.log('  - å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ã§ãã¾ã™');

            ganttState.fieldGroups = groupByField(ganttState.cultivationData);
            renderGanttChart(ganttContainer, ganttState.fieldGroups, ganttState.planStartDate, ganttState.planEndDate);
        }

        function groupByField(cultivations) {
            const groups = {};
            
            cultivations.forEach(cultivation => {
                const fieldName = cultivation.field_name || 'æœªè¨­å®š';
                if (!groups[fieldName]) {
                    groups[fieldName] = {
                        fieldName: fieldName,
                        cultivations: []
                    };
                }
                groups[fieldName].cultivations.push(cultivation);
            });
            
            Object.values(groups).forEach(group => {
                group.cultivations.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
            });
            
            return Object.values(groups);
        }

        function renderGanttChart(container, fieldGroups, planStartDate, planEndDate) {
            const config = {
                width: 1200,
                height: 60 + (fieldGroups.length * 80),
                margin: { top: 60, right: 40, bottom: 20, left: 80 },
                rowHeight: 70,
                barHeight: 50,
                barPadding: 10
            };

            const totalDays = daysBetween(planStartDate, planEndDate);
            const chartWidth = config.width - config.margin.left - config.margin.right;
            const chartHeight = config.height - config.margin.top - config.margin.bottom;
            
            ganttState.config = config;
            ganttState.chartWidth = chartWidth;
            ganttState.chartHeight = chartHeight;
            ganttState.totalDays = totalDays;

            console.log('ğŸ“ ãƒãƒ£ãƒ¼ãƒˆå¯¸æ³•:', {
                totalDays,
                chartWidth,
                chartHeight,
                fields: fieldGroups.length
            });

            const svg = createSVGElement('svg', {
                width: config.width,
                height: config.height,
                class: 'custom-gantt-chart',
                viewBox: `0 0 ${config.width} ${config.height}`
            });

            const defs = createSVGElement('defs');
            const bgGradient = createSVGElement('linearGradient', {
                id: 'bgGradient',
                x1: '0%',
                y1: '0%',
                x2: '0%',
                y2: '100%'
            });
            bgGradient.innerHTML = `
                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#f9fafb;stop-opacity:1" />
            `;
            defs.appendChild(bgGradient);
            svg.appendChild(defs);

            svg.appendChild(createSVGElement('rect', {
                width: config.width,
                height: config.height,
                fill: 'url(#bgGradient)'
            }));

            fieldGroups.forEach((group, index) => {
                const y = config.margin.top + (index * config.rowHeight);
                renderFieldRow(svg, config, group, index, y, planStartDate, totalDays, chartWidth);
            });

            container.innerHTML = '';
            container.appendChild(svg);
            
            setupGlobalDragHandlers(svg, config, planStartDate, totalDays, chartWidth);
            addReoptimizeButton(container);
            
            console.log('âœ… ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæç”»å®Œäº†');
            
            const bars = document.querySelectorAll('.cultivation-bar .bar-bg');
            console.log('ğŸ“Š æç”»ã•ã‚ŒãŸãƒãƒ¼æ•°:', bars.length);
            
            bars.forEach((bar, index) => {
                console.log(`ğŸ“Š ãƒãƒ¼ ${index + 1}:`, {
                    element: bar,
                    hasMousedownListener: bar.onmousedown !== null,
                    cursor: bar.style.cursor
                });
            });
        }

        function renderFieldRow(svg, config, group, index, y, planStartDate, totalDays, chartWidth) {
            const rowGroup = createSVGElement('g', {
                class: 'field-row',
                'data-field': group.fieldName
            });

            if (index % 2 === 0) {
                rowGroup.appendChild(createSVGElement('rect', {
                    x: 0,
                    y: y,
                    width: config.width,
                    height: config.rowHeight,
                    fill: '#F9FAFB'
                }));
            }

            const fieldNumber = group.fieldName.replace(/[^\d]/g, '');
            rowGroup.appendChild(createSVGElement('text', {
                x: 30,
                y: y + (config.rowHeight / 2) + 5,
                class: 'field-label',
                'text-anchor': 'middle',
                'font-size': '14',
                'font-weight': '600',
                fill: '#374151'
            }, fieldNumber));

            rowGroup.appendChild(createSVGElement('line', {
                x1: config.margin.left - 10,
                y1: y,
                x2: config.margin.left - 10,
                y2: y + config.rowHeight,
                stroke: '#D1D5DB',
                'stroke-width': '2'
            }));

            group.cultivations.forEach((cultivation, cultIndex) => {
                console.log('ğŸ¯ æ ½åŸ¹ãƒãƒ¼ã‚’æç”»ä¸­:', cultivation.crop_name);
                renderCultivationBar(rowGroup, config, cultivation, y, planStartDate, totalDays, chartWidth);
            });

            svg.appendChild(rowGroup);
        }

        function renderCultivationBar(parentGroup, config, cultivation, rowY, planStartDate, totalDays, chartWidth) {
            console.log('ğŸ¨ æ ½åŸ¹ãƒãƒ¼æç”»é–‹å§‹:', cultivation.crop_name, cultivation.start_date, cultivation.completion_date);
            
            const startDate = new Date(cultivation.start_date);
            const endDate = new Date(cultivation.completion_date);
            
            const daysFromStart = daysBetween(planStartDate, startDate);
            const cultivationDays = daysBetween(startDate, endDate) + 1;
            
            const barX = config.margin.left + (daysFromStart / totalDays) * chartWidth;
            const barWidth = (cultivationDays / totalDays) * chartWidth;
            const barY = rowY + config.barPadding;
            
            const barGroup = createSVGElement('g', {
                class: 'cultivation-bar',
                'data-id': cultivation.id,
                'data-crop': cultivation.crop_name,
                'data-field': cultivation.field_name
            });

            const barBg = createSVGElement('rect', {
                x: barX,
                y: barY,
                width: barWidth,
                height: config.barHeight,
                rx: 6,
                ry: 6,
                fill: '#9ae6b4',
                stroke: '#48bb78',
                'stroke-width': '2.5',
                class: 'bar-bg',
                style: 'cursor: grab;',
                opacity: '0.95'
            });

            barBg.addEventListener('mouseenter', function() {
                this.setAttribute('opacity', '1');
                this.setAttribute('stroke-width', '3.5');
                this.style.cursor = 'grab';
            });
            
            barBg.addEventListener('mouseleave', function() {
                if (ganttState.draggedBar !== barGroup) {
                    this.setAttribute('opacity', '0.95');
                    this.setAttribute('stroke-width', '2.5');
                }
            });
            
            barGroup.appendChild(barBg);

            barBg.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                ganttState.draggedBar = barGroup;
                ganttState.dragStartX = e.clientX;
                ganttState.dragStartY = e.clientY;
                ganttState.originalBarX = parseFloat(barBg.getAttribute('x'));
                
                const currentFieldName = cultivation.field_name;
                ganttState.originalFieldIndex = ganttState.fieldGroups.findIndex(g => g.fieldName === currentFieldName);
                
                this.style.cursor = 'grabbing';
                console.log('ğŸ–±ï¸ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:', cultivation.crop_name);
                console.log('ğŸ“ é–‹å§‹ä½ç½®:', { x: e.clientX, y: e.clientY });
                
                this.setAttribute('opacity', '0.8');
                this.setAttribute('stroke-width', '4');
                this.setAttribute('stroke-dasharray', '5,5');
            });

            barBg.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (confirm(`${cultivation.crop_name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    removeCultivation(cultivation.id);
                }
            });

            const label = createSVGElement('text', {
                x: barX + (barWidth / 2),
                y: barY + (config.barHeight / 2) + 5,
                class: 'bar-label',
                'text-anchor': 'middle',
                'font-size': '12',
                'font-weight': '600',
                fill: '#1F2937',
                style: 'pointer-events: none;'
            }, cultivation.crop_name);
            
            barGroup.appendChild(label);
            
            const deleteBtn = createSVGElement('g', {
                class: 'delete-btn',
                style: 'cursor: pointer;'
            });
            
            const deleteBtnCircle = createSVGElement('circle', {
                cx: barX + barWidth - 10,
                cy: barY + 10,
                r: 8,
                fill: '#EF4444',
                opacity: '0.9'
            });
            
            const deleteBtnX = createSVGElement('text', {
                x: barX + barWidth - 10,
                y: barY + 15,
                'text-anchor': 'middle',
                'font-size': '12',
                'font-weight': 'bold',
                fill: '#FFFFFF',
                style: 'pointer-events: none;'
            }, 'Ã—');
            
            deleteBtn.appendChild(deleteBtnCircle);
            deleteBtn.appendChild(deleteBtnX);
            
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (confirm(`${cultivation.crop_name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    removeCultivation(cultivation.id);
                }
            });
            
            deleteBtn.addEventListener('mouseenter', function() {
                deleteBtnCircle.setAttribute('opacity', '1');
            });
            
            deleteBtn.addEventListener('mouseleave', function() {
                deleteBtnCircle.setAttribute('opacity', '0.9');
            });
            
            barGroup.appendChild(deleteBtn);
            parentGroup.appendChild(barGroup);
        }

        function setupGlobalDragHandlers(svg, config, planStartDate, totalDays, chartWidth) {
            document.addEventListener('mousemove', function(e) {
                if (!ganttState.draggedBar) return;
                
                const deltaX = e.clientX - ganttState.dragStartX;
                const deltaY = e.clientY - ganttState.dragStartY;
                
                const newX = Math.max(
                    config.margin.left,
                    Math.min(
                        ganttState.originalBarX + deltaX,
                        config.margin.left + chartWidth
                    )
                );
                
                const barBg = ganttState.draggedBar.querySelector('.bar-bg');
                if (barBg) {
                    barBg.setAttribute('x', newX);
                    
                    const barWidth = parseFloat(barBg.getAttribute('width'));
                    const label = ganttState.draggedBar.querySelector('.bar-label');
                    if (label) {
                        label.setAttribute('x', newX + (barWidth / 2));
                    }
                    
                    const deleteBtn = ganttState.draggedBar.querySelector('.delete-btn circle');
                    const deleteBtnText = ganttState.draggedBar.querySelector('.delete-btn text');
                    if (deleteBtn && deleteBtnText) {
                        deleteBtn.setAttribute('cx', newX + barWidth - 10);
                        deleteBtnText.setAttribute('x', newX + barWidth - 10);
                    }
                }
            });
            
            document.addEventListener('mouseup', function(e) {
                if (!ganttState.draggedBar) return;
                
                const cultivation_id = ganttState.draggedBar.getAttribute('data-id');
                const originalFieldName = ganttState.draggedBar.getAttribute('data-field');
                
                const barBg = ganttState.draggedBar.querySelector('.bar-bg');
                if (!barBg) {
                    ganttState.draggedBar = null;
                    return;
                }
                
                const newX = parseFloat(barBg.getAttribute('x'));
                const daysFromStart = Math.round((newX - config.margin.left) / chartWidth * totalDays);
                const newStartDate = new Date(planStartDate);
                newStartDate.setDate(newStartDate.getDate() + daysFromStart);
                
                const deltaY = e.clientY - ganttState.dragStartY;
                const fieldIndexChange = Math.round(deltaY / config.rowHeight);
                const newFieldIndex = Math.max(0, Math.min(
                    ganttState.originalFieldIndex + fieldIndexChange,
                    ganttState.fieldGroups.length - 1
                ));
                
                const newFieldName = ganttState.fieldGroups[newFieldIndex].fieldName;
                
                if (originalFieldName !== newFieldName || Math.abs(daysFromStart) > 2) {
                    console.log('ğŸ“ ãƒ‰ãƒ©ãƒƒã‚°å®Œäº†:', {
                        cultivation_id,
                        from_field: originalFieldName,
                        to_field: newFieldName,
                        new_start_date: newStartDate.toISOString().split('T')[0]
                    });
                    
                    recordMove(cultivation_id, newFieldName, newStartDate);
                    applyMovesLocally();
                }
                
                barBg.style.cursor = 'grab';
                barBg.setAttribute('opacity', '0.95');
                barBg.setAttribute('stroke-width', '2.5');
                barBg.removeAttribute('stroke-dasharray');
                ganttState.draggedBar = null;
            });
        }

        function recordMove(allocation_id, to_field_name, to_start_date) {
            ganttState.moves = ganttState.moves.filter(m => m.allocation_id !== `alloc_${allocation_id}`);
            
            const fieldGroup = ganttState.fieldGroups.find(g => g.fieldName === to_field_name);
            const field_id = `field_${fieldGroup?.cultivations[0]?.field_name?.match(/\d+/)?.[0] || '1'}`;
            
            ganttState.moves.push({
                allocation_id: `alloc_${allocation_id}`,
                action: 'move',
                to_field_id: field_id,
                to_start_date: to_start_date.toISOString().split('T')[0]
            });
            
            console.log('ğŸ“‹ ç§»å‹•å±¥æ­´:', ganttState.moves);
            enableReoptimizeButton();
        }

        function removeCultivation(cultivation_id) {
            console.log('ğŸ—‘ï¸ å‰Šé™¤:', cultivation_id);
            
            ganttState.removedIds.push(cultivation_id);
            
            ganttState.moves.push({
                allocation_id: `alloc_${cultivation_id}`,
                action: 'remove'
            });
            
            ganttState.cultivationData = ganttState.cultivationData.filter(c => c.id != cultivation_id);
            ganttState.fieldGroups = groupByField(ganttState.cultivationData);
            
            const ganttContainer = document.getElementById('gantt-chart-container');
            if (ganttContainer) {
                renderGanttChart(ganttContainer, ganttState.fieldGroups, ganttState.planStartDate, ganttState.planEndDate);
            }
            
            enableReoptimizeButton();
        }

        function applyMovesLocally() {
            ganttState.moves.filter(m => m.action === 'move').forEach(move => {
                const cultivation_id = parseInt(move.allocation_id.replace('alloc_', ''));
                const cultivation = ganttState.cultivationData.find(c => c.id === cultivation_id);
                
                if (cultivation) {
                    const oldStartDate = new Date(cultivation.start_date);
                    const oldEndDate = new Date(cultivation.completion_date);
                    const duration = daysBetween(oldStartDate, oldEndDate);
                    
                    const newStartDate = new Date(move.to_start_date);
                    const newEndDate = new Date(newStartDate);
                    newEndDate.setDate(newEndDate.getDate() + duration);
                    
                    cultivation.start_date = newStartDate.toISOString().split('T')[0];
                    cultivation.completion_date = newEndDate.toISOString().split('T')[0];
                    
                    const fieldNum = move.to_field_id.replace('field_', '');
                    cultivation.field_name = `åœƒå ´ ${fieldNum}`;
                }
            });
            
            ganttState.cultivationData = ganttState.cultivationData.filter(c => 
                !ganttState.removedIds.includes(c.id)
            );
            
            ganttState.fieldGroups = groupByField(ganttState.cultivationData);
            
            const ganttContainer = document.getElementById('gantt-chart-container');
            if (ganttContainer) {
                renderGanttChart(ganttContainer, ganttState.fieldGroups, ganttState.planStartDate, ganttState.planEndDate);
            }
        }

        function addReoptimizeButton(container) {
            const btnContainer = document.createElement('div');
            btnContainer.className = 'gantt-reoptimize-container';
            btnContainer.style.cssText = 'text-align: center; margin-top: 1rem;';
            
            const btn = document.createElement('button');
            btn.id = 'gantt-reoptimize-btn'; // è‡ªå‹•å®Ÿè¡Œã®ãŸã‚ä½¿ç”¨ã•ã‚Œãªã„
            btn.className = 'btn-primary';
            btn.textContent = 'å†æœ€é©åŒ–ä¸­...';
            btn.disabled = true;
            btn.style.cssText = 'padding: 0.75rem 1.5rem; font-size: 1rem; opacity: 0.5;';
            
            btn.addEventListener('click', function() {
                if (ganttState.moves.length === 0) {
                    alert('å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (!confirm(`${ganttState.moves.length}ä»¶ã®å¤‰æ›´ã‚’è‡ªå‹•ã§å†æœ€é©åŒ–ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
                
                executeReoptimization();
            });
            
            btnContainer.appendChild(btn);
            container.parentElement.appendChild(btnContainer);
        }

        function enableReoptimizeButton() {
            // è‡ªå‹•å†æœ€é©åŒ–ã®ãŸã‚ã€æ‰‹å‹•ãƒœã‚¿ãƒ³ã¯ä½¿ç”¨ã•ã‚Œãªã„
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        function executeReoptimization() {
            // è‡ªå‹•å†æœ€é©åŒ–ã®ãŸã‚ã€æ‰‹å‹•ãƒœã‚¿ãƒ³ã¯ä½¿ç”¨ã•ã‚Œãªã„
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'å†æœ€é©åŒ–ä¸­...';
            }
            
            console.log('ğŸ”„ å†æœ€é©åŒ–å®Ÿè¡Œ:', ganttState.moves);
            
            setTimeout(() => {
                alert('å†æœ€é©åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'å†æœ€é©åŒ–ä¸­...';
                }
            }, 2000);
        }

        function createSVGElement(tag, attrs = {}, textContent = null) {
            const element = document.createElementNS('http://www.w3.org/2000/svg', tag);
            
            Object.entries(attrs).forEach(([key, value]) => {
                element.setAttribute(key, value);
            });
            
            if (textContent !== null) {
                element.textContent = textContent;
            }
            
            return element;
        }

        function daysBetween(date1, date2) {
            const oneDay = 24 * 60 * 60 * 1000;
            return Math.round(Math.abs((date2 - date1) / oneDay));
        }

        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        function runTests() {
            const results = document.getElementById('test-results');
            let testCount = 0;
            let passCount = 0;

            function addTestResult(name, passed, message) {
                testCount++;
                if (passed) passCount++;
                
                const div = document.createElement('div');
                div.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                div.innerHTML = `<strong>${name}:</strong> ${message}`;
                results.appendChild(div);
            }

            // ãƒ†ã‚¹ãƒˆ1: ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
            try {
                initCustomGanttChart();
                const container = document.getElementById('gantt-chart-container');
                const svg = container.querySelector('svg');
                const bars = container.querySelectorAll('.cultivation-bar .bar-bg');
                
                if (svg && bars.length > 0) {
                    addTestResult('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–', true, 'SVGè¦ç´ ã¨ãƒãƒ¼ãŒæ­£ã—ãæç”»ã•ã‚Œã¾ã—ãŸ');
                } else {
                    addTestResult('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–', false, 'SVGè¦ç´ ã¾ãŸã¯ãƒãƒ¼ãŒæç”»ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            } catch (e) {
                addTestResult('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–', false, `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }

            // ãƒ†ã‚¹ãƒˆ2: ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
            try {
                const bar = document.querySelector('.cultivation-bar .bar-bg');
                if (bar) {
                    const cursor = window.getComputedStyle(bar).cursor;
                    if (cursor === 'grab') {
                        addTestResult('ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½', true, 'ãƒãƒ¼ã«grabã‚«ãƒ¼ã‚½ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™');
                    } else {
                        addTestResult('ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½', false, `ã‚«ãƒ¼ã‚½ãƒ«ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ${cursor}`);
                    }
                } else {
                    addTestResult('ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½', false, 'ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (e) {
                addTestResult('ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½', false, `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }

            // ãƒ†ã‚¹ãƒˆ3: å‰Šé™¤ãƒœã‚¿ãƒ³
            try {
                const deleteBtn = document.querySelector('.delete-btn');
                if (deleteBtn) {
                    addTestResult('å‰Šé™¤ãƒœã‚¿ãƒ³', true, 'å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™');
                } else {
                    addTestResult('å‰Šé™¤ãƒœã‚¿ãƒ³', false, 'å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (e) {
                addTestResult('å‰Šé™¤ãƒœã‚¿ãƒ³', false, `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }

            // ãƒ†ã‚¹ãƒˆ4: å†æœ€é©åŒ–ãƒœã‚¿ãƒ³
            try {
                // è‡ªå‹•å†æœ€é©åŒ–ã®ãŸã‚ã€æ‰‹å‹•ãƒœã‚¿ãƒ³ã¯ä½¿ç”¨ã•ã‚Œãªã„
                if (btn) {
                    addTestResult('å†æœ€é©åŒ–ãƒœã‚¿ãƒ³', true, 'å†æœ€é©åŒ–ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™');
                } else {
                    addTestResult('å†æœ€é©åŒ–ãƒœã‚¿ãƒ³', false, 'å†æœ€é©åŒ–ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (e) {
                addTestResult('å†æœ€é©åŒ–ãƒœã‚¿ãƒ³', false, `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }

            // ãƒ†ã‚¹ãƒˆ5: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            try {
                const bar = document.querySelector('.cultivation-bar .bar-bg');
                if (bar) {
                    const hasMousedown = bar.onmousedown !== null;
                    if (hasMousedown) {
                        addTestResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼', true, 'mousedownã‚¤ãƒ™ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™');
                    } else {
                        addTestResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼', false, 'mousedownã‚¤ãƒ™ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }
                } else {
                    addTestResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼', false, 'ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (e) {
                addTestResult('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼', false, `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }

            // çµæœã‚µãƒãƒªãƒ¼
            const summary = document.createElement('div');
            summary.className = `test-result ${passCount === testCount ? 'test-pass' : 'test-fail'}`;
            summary.innerHTML = `<strong>ãƒ†ã‚¹ãƒˆçµæœ:</strong> ${passCount}/${testCount} ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ`;
            results.appendChild(summary);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runTests, 1000);
        });
    </script>
</body>
</html>
