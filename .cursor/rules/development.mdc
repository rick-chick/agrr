---
alwaysApply: true
---
# 開発ルール

## タスク開始前の必須手順

### 呼び出し階層確認と影響調査

各タスクを始める前に、必ず以下の手順を実行すること：

#### 1. 呼び出し元の特定
- どのコンポーネントから呼び出されているかを確認
- パラメータの受け渡し方法を把握
- 呼び出し条件とタイミングを理解

#### 2. データフローの追跡
- 入力パラメータの流れを追跡
- 戻り値や副作用の影響範囲を特定
- 状態変更の波及効果を分析

#### 3. 依存関係の調査
- 他のコンポーネントへの影響範囲を特定
- 直接的な依存関係と間接的な依存関係を区別
- 循環依存の有無を確認

#### 4. 責任範囲の明確化
- 各コンポーネントの責務と境界を理解
- 単一責任の原則に従っているかを確認
- 責任の重複や曖昧さがないかを検証

#### 5. 変更影響の評価
- 修正による波及効果を事前に分析
- 破壊的変更の可能性を評価
- 後方互換性への影響を考慮

## 実装例

### ❌ 悪い例（責任範囲が曖昧）
```ruby
# FetchWeatherDataJobが次のジョブのことを知っている
if farm.weather_data_status == 'completed'
  cultivation_plan.phase_optimizing!(channel_class)  # 次のジョブの責任
end
```

### ✅ 良い例（責任範囲が明確）
```ruby
# FetchWeatherDataJobは自分の仕事のみに集中
if farm.weather_data_status == 'completed'
  Rails.logger.info "Weather data completed, next job will handle phase transition"
end
```

## チェックリスト

- [ ] 呼び出し元を特定した
- [ ] データフローを追跡した
- [ ] 依存関係を調査した
- [ ] 責任範囲を明確化した
- [ ] 変更影響を評価した
- [ ] 単一責任の原則に従っている
- [ ] 他のコンポーネントの責務を侵していない