# CLI版 vs Daemon版 - ファイル対応表

## 新規追加ファイル（Daemon版サポート）

### 実装ファイル

| ファイル | 用途 | 説明 |
|---------|------|------|
| `Dockerfile.with-agrr-daemon` | Daemon版Dockerfile | agrr daemonを含むプロダクションイメージ |
| `scripts/start_app_with_agrr_daemon.sh` | Daemon版起動スクリプト | Litestreamパターンでdaemon自動起動 |

### ドキュメント

| ファイル | 説明 |
|---------|------|
| `README_DAEMON.md` | Daemon版クイックスタート |
| `docs/DEPLOYMENT_VARIANTS.md` | 詳細な使い分けガイド |
| `docs/AGRR_DAEMON_INTEGRATION.md` | 実装手順とトラブルシューティング |
| `docs/DAEMON_CLOUDRUN_ANALYSIS.md` | 技術分析（更新済み） |
| `docs/DAEMON_SUMMARY.md` | 要約 |

### 既存ファイルの変更

| ファイル | 変更内容 |
|---------|---------|
| `docker-compose.yml` | `web-daemon`サービスを追加（profileで分離） |

## 既存ファイル（CLI版、そのまま維持）

| ファイル | 用途 | 変更 |
|---------|------|------|
| `Dockerfile` | CLI版Dockerfile | **変更なし** ✅ |
| `Dockerfile.production` | CLI版プロダクション | **変更なし** ✅ |
| `scripts/start_app.sh` | CLI版起動スクリプト | **変更なし** ✅ |

## 使い分け

### CLI版（デフォルト、推奨）

```bash
# 開発
docker compose up web

# 本番（CloudRun）
docker build -t agrr-app:cli .
gcloud run deploy agrr-app --image ...

# 本番（CloudRun）
docker build -t agrr-app:cli .
gcloud run deploy agrr-app --image gcr.io/.../agrr-app:cli
```

### Daemon版（高頻度アクセス向け）

```bash
# 開発（テスト用）
docker compose --profile daemon up web-daemon

# 本番（CloudRun）
docker build -f Dockerfile.with-agrr-daemon -t agrr-app:daemon .
gcloud run deploy agrr-app-daemon --image ... --min-instances=1

# 本番（CloudRun）
docker build -f Dockerfile.with-agrr-daemon -t agrr-app:daemon .
gcloud run deploy agrr-app-daemon --image gcr.io/.../agrr-app:daemon --min-instances=1
```

## ファイル構成図

```
agrr/
├── Dockerfile                              ← CLI版（デフォルト）
├── Dockerfile.production                   ← CLI版プロダクション
├── Dockerfile.with-agrr-daemon            ← Daemon版 🆕
├── README.md                               ← メインドキュメント
├── README_DAEMON.md                        ← Daemon版クイックスタート 🆕
├── docker-compose.yml                      ← web + web-daemon（更新）
│
├── scripts/
│   ├── start_app.sh                       ← CLI版起動
│   └── start_app_with_agrr_daemon.sh     ← Daemon版起動 🆕
│
├── docs/
│   ├── DEPLOYMENT_VARIANTS.md             ← 使い分けガイド 🆕
│   ├── AGRR_DAEMON_INTEGRATION.md         ← 実装詳細 🆕
│   ├── DAEMON_CLOUDRUN_ANALYSIS.md        ← 技術分析 🆕
│   └── DAEMON_SUMMARY.md                  ← 要約 🆕
│
└── lib/core/
    └── agrr                                ← agrr binary（要ビルド）
```

## 重要なポイント

### ✅ 既存のCLI版は完全に保持

- `Dockerfile` → そのまま
- `scripts/start_app.sh` → そのまま

### 🆕 Daemon版は新規ファイルとして追加

- `Dockerfile.with-agrr-daemon`
- `scripts/start_app_with_agrr_daemon.sh`

### 🔄 いつでも切り替え可能

- ファイルが独立しているため、いつでも切り替え可能
- 両方を同時にデプロイすることも可能
- データベースなどは共通

### 📊 推奨

**ほとんどのケースでCLI版（デフォルト）を使用してください。**

Daemon版は以下を**すべて満たす**特殊ケースのみ：
- 最小インスタンス=1で運用
- 高頻度アクセス（1時間10回以上）
- agrr実行が頻繁
- コスト増が許容できる

詳細: [docs/DEPLOYMENT_VARIANTS.md](docs/DEPLOYMENT_VARIANTS.md)

