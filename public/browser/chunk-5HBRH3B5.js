import{b as $,c as L,d as z}from"./chunk-U557IDSH.js";import{j as B}from"./chunk-NXFG3DMW.js";import{$ as G,$a as _,Aa as o,Gb as F,Hb as V,Ia as H,Ma as P,Wa as s,Xa as w,Ya as x,_ as D,_a as C,aa as m,eb as d,fb as l,gb as u,hb as O,ma as S,mb as T,nb as c,ob as I,pb as M,qb as E,tb as k,vb as f,xb as p}from"./chunk-OVGF36KA.js";var N=["container"],Y=["svg"],A=(a,e)=>e.date.getTime(),Q=(a,e)=>e.fieldId,X=(a,e)=>e.id;function q(a,e){if(a&1&&(m(),d(0,"text",13),f(1),l()),a&2){let t=c().$implicit;s("x",t.x+t.width/2),o(),p(" ",t.year,"\u5E74 ")}}function W(a,e){if(a&1&&(m(),d(0,"text",12),f(1),l(),w(2,q,2,2,":svg:text",13),u(3,"line",14)),a&2){let t=e.$implicit,n=c();s("x",t.x+t.width/2),o(),p(" ",t.label," "),o(),x(t.showYear?2:-1),o(),s("x1",t.x)("x2",t.x)("y2",n.config.height)}}function j(a,e){if(a&1){let t=O();m(),d(0,"g",18),T("mousedown",function(i){D(t);let r=c().$implicit,g=c(2);return G(g.onMouseDown(i,r))}),u(1,"rect",19),d(2,"text",20),f(3),l()()}if(a&2){let t=e,n=c().$implicit,i=c(2);k("dragging",(i.draggedCultivation==null?null:i.draggedCultivation.id)===n.id),s("data-id",n.id),o(),s("x",t.x)("y",i.config.barPadding)("width",t.width)("height",i.config.barHeight)("fill",i.getCropColor(n.crop_name))("stroke",i.getCropStrokeColor(n.crop_name)),o(),s("x",t.x+t.width/2)("y",i.config.barPadding+i.config.barHeight/2+5),o(),p(" ",n.crop_name," ")}}function J(a,e){if(a&1&&w(0,j,4,12,":svg:g",17),a&2){let t,n=e.$implicit,i=c(2);x((t=i.getBarParams(n))?0:-1,t)}}function K(a,e){if(a&1&&(m(),d(0,"g",11)(1,"text",15),f(2),l(),u(3,"line",16),C(4,J,1,1,null,null,X),l()),a&2){let t=e.$implicit,n=e.$index,i=c();s("transform","translate(0, "+(i.config.margin.top+n*i.config.rowHeight)+")"),o(),s("y",i.config.rowHeight/2+5),o(),p(" ",t.fieldName," "),o(),s("x1",i.config.margin.left-10)("x2",i.config.margin.left-10)("y2",i.config.rowHeight),o(),_(t.cultivations)}}var R=class a{constructor(e){this.translate=e}data=null;container;svgElement;config={margin:{top:60,right:20,bottom:12,left:80},rowHeight:68,barHeight:48,barPadding:8,width:1200,height:500};fieldGroups=[];months=[];isDragging=!1;draggedCultivation=null;dragStartX=0;dragStartY=0;globalMouseMoveHandler;globalMouseUpHandler;ngOnInit(){this.data&&this.updateChart()}ngOnChanges(e){e.data&&this.data&&this.updateChart()}ngAfterViewInit(){setTimeout(()=>this.updateDimensions(),0),window.addEventListener("resize",this.onResize)}ngOnDestroy(){window.removeEventListener("resize",this.onResize),this.removeGlobalListeners()}onResize=()=>{this.updateDimensions()};updateDimensions(){if(this.container){let e=this.container.nativeElement.getBoundingClientRect().width;this.config.width=Math.max(e,800),this.data&&this.updateChart()}}updateChart(){if(!this.data)return;let e=this.data.data.fields,t=this.data.data.cultivations;this.fieldGroups=e.map(n=>({fieldName:n.name,fieldId:n.id,cultivations:t.filter(i=>i.field_id===n.id)})),this.config.height=this.config.margin.top+this.fieldGroups.length*this.config.rowHeight+this.config.margin.bottom,this.calculateMonths()}calculateMonths(){if(!this.data)return;let e=new Date(this.data.data.planning_start_date),t=new Date(this.data.data.planning_end_date),n=this.daysBetween(e,t),i=this.config.width-this.config.margin.left-this.config.margin.right;this.months=[];let r=new Date(e),g=this.config.margin.left;for(;r<=t;){let v=r.getFullYear(),h=r.getMonth()+1,b=new Date(v,h,0).getDate()/n*i;this.months.push({date:new Date(r),year:v,month:h,label:`${h}\u6708`,showYear:h===1||this.months.length===0,x:g,width:b}),g+=b,r.setMonth(r.getMonth()+1)}}getBarParams(e){if(!this.data)return null;let t=new Date(this.data.data.planning_start_date),n=new Date(this.data.data.planning_end_date),i=new Date(e.start_date),r=new Date(e.completion_date),g=this.daysBetween(t,n),v=this.config.width-this.config.margin.left-this.config.margin.right,h=this.daysBetween(t,i),y=this.daysBetween(i,r)+1,b=this.config.margin.left+h/g*v,U=y/g*v;return{x:b,width:U}}daysBetween(e,t){return Math.floor((t.getTime()-e.getTime())/(1e3*60*60*24))}getCropColor(e){let t=["#9ae6b4","#fbd38d","#90cdf4","#c6f6d5","#feebc8","#feb2b2"],n=e.split("").reduce((i,r)=>i+r.charCodeAt(0),0);return t[n%t.length]}getCropStrokeColor(e){let t=["#48bb78","#f6ad55","#4299e1","#2f855a","#dd6b20","#fc8181"],n=e.split("").reduce((i,r)=>i+r.charCodeAt(0),0);return t[n%t.length]}onMouseDown(e,t){e.button===0&&(e.preventDefault(),this.isDragging=!0,this.draggedCultivation=t,this.dragStartX=e.clientX,this.dragStartY=e.clientY,this.globalMouseMoveHandler=n=>this.onMouseMove(n),this.globalMouseUpHandler=n=>this.onMouseUp(n),document.addEventListener("mousemove",this.globalMouseMoveHandler),document.addEventListener("mouseup",this.globalMouseUpHandler))}onMouseMove(e){!this.isDragging||this.draggedCultivation}onMouseUp(e){this.isDragging&&(this.isDragging=!1,this.draggedCultivation=null,this.removeGlobalListeners())}removeGlobalListeners(){this.globalMouseMoveHandler&&(document.removeEventListener("mousemove",this.globalMouseMoveHandler),this.globalMouseMoveHandler=null),this.globalMouseUpHandler&&(document.removeEventListener("mouseup",this.globalMouseUpHandler),this.globalMouseUpHandler=null)}static \u0275fac=function(t){return new(t||a)(H($))};static \u0275cmp=P({type:a,selectors:[["app-gantt-chart"]],viewQuery:function(t,n){if(t&1&&I(N,5)(Y,5),t&2){let i;M(i=E())&&(n.container=i.first),M(i=E())&&(n.svgElement=i.first)}},inputs:{data:"data"},features:[S],decls:18,vars:7,consts:[["container",""],["svg",""],[1,"gantt-container"],[1,"gantt-scroll-area"],[1,"custom-gantt-chart"],["id","bgGradient","x1","0%","y1","0%","x2","0%","y2","100%"],["offset","0%",2,"stop-color","#ffffff","stop-opacity","1"],["offset","100%",2,"stop-color","#f9fafb","stop-opacity","1"],["fill","url(#bgGradient)",1,"gantt-background"],[1,"timeline-header"],["x","20","y","30","font-size","14","font-weight","bold","fill","#374151",1,"header-label"],[1,"field-row"],["y","30","text-anchor","middle","font-size","13","font-weight","600","fill","#1F2937",1,"month-label"],["y","15","text-anchor","middle","font-size","12","font-weight","bold","fill","#6B7280",1,"year-label"],["y1","40","stroke","#E5E7EB","stroke-width","1"],["x","30","text-anchor","middle","font-size","14","font-weight","600","fill","#374151",1,"field-label"],["y1","0","stroke","#D1D5DB","stroke-width","2"],[1,"cultivation-bar",3,"dragging"],[1,"cultivation-bar",3,"mousedown"],["rx","6","ry","6","stroke-width","2.5",1,"bar-bg",2,"cursor","grab"],["text-anchor","middle","font-size","12","font-weight","600","fill","#1F2937",1,"bar-label",2,"pointer-events","none"]],template:function(t,n){t&1&&(d(0,"div",2,0)(2,"div",3),m(),d(3,"svg",4,1)(5,"defs")(6,"linearGradient",5),u(7,"stop",6)(8,"stop",7),l()(),u(9,"rect",8),d(10,"g",9)(11,"text",10),f(12),F(13,"translate"),l(),C(14,W,4,6,null,null,A),l(),C(16,K,6,6,":svg:g",11,Q),l()()()),t&2&&(o(3),s("width",n.config.width)("height",n.config.height),o(6),s("width",n.config.width)("height",n.config.height),o(3),p(" ",V(13,5,"shared.navbar.farms")," "),o(2),_(n.months),o(2),_(n.fieldGroups))},dependencies:[B,z,L],styles:[".gantt-container[_ngcontent-%COMP%]{width:100%;overflow:hidden;background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);margin-bottom:var(--space-5)}.gantt-scroll-area[_ngcontent-%COMP%]{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}.custom-gantt-chart[_ngcontent-%COMP%]{display:block;-webkit-user-select:none;user-select:none}.gantt-background[_ngcontent-%COMP%]{pointer-events:all}.field-row[_ngcontent-%COMP%]{transition:transform var(--transition-fast)}.cultivation-bar[_ngcontent-%COMP%]{cursor:grab;transition:opacity var(--transition-fast)}.cultivation-bar[_ngcontent-%COMP%]:hover{opacity:.8}.cultivation-bar.dragging[_ngcontent-%COMP%]{cursor:grabbing;opacity:.6}.month-label[_ngcontent-%COMP%], .year-label[_ngcontent-%COMP%], .header-label[_ngcontent-%COMP%], .field-label[_ngcontent-%COMP%]{pointer-events:none}"]})};export{R as a};
