#!/usr/bin/env ruby
# frozen_string_literal: true

# å‚ç…§è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆJMAç‰ˆï¼‰
#
# ä½¿ç”¨æ–¹æ³•:
#   bin/fetch_reference_weather_data                           # å…¨å‚ç…§è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
#   bin/fetch_reference_weather_data --farm-name "åŒ—æµ·é“"       # ç‰¹å®šã®è¾²å ´ã®ã¿
#
# å‰ææ¡ä»¶:
#   - rails db:seed ãŒå®Ÿè¡Œæ¸ˆã¿ï¼ˆå‚ç…§è¾²å ´ãŒDBã«å­˜åœ¨ã™ã‚‹ï¼‰
#   - agrrãƒã‚¤ãƒŠãƒªãŒ lib/core/agrr ã«å­˜åœ¨ã™ã‚‹
#
# å‡¦ç†å†…å®¹:
#   1. DBã‹ã‚‰å‚ç…§è¾²å ´ã‚’å–å¾—
#   2. å„è¾²å ´ã«ã¤ã„ã¦ agrrã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦JMAã‹ã‚‰å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
#   3. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’db/fixtures/reference_weather.json ã«ä¿å­˜

require 'fileutils'
require 'json'
require 'open3'

require_relative '../config/environment'

# ãƒ­ã‚°å‡ºåŠ›ç”¨ã®ã‚«ãƒ©ãƒ¼å®šç¾©
class ColorLogger
  COLORS = {
    red: "\e[31m",
    green: "\e[32m",
    yellow: "\e[33m",
    blue: "\e[34m",
    reset: "\e[0m"
  }

  def self.log(message, color = :reset)
    puts "#{COLORS[color]}#{message}#{COLORS[:reset]}"
  end

  def self.info(message)
    log("â„¹ï¸  #{message}", :blue)
  end

  def self.success(message)
    log("âœ… #{message}", :green)
  end

  def self.warning(message)
    log("âš ï¸  #{message}", :yellow)
  end

  def self.error(message)
    log("âŒ #{message}", :red)
  end
end

# agrr daemon clientã§JMAã‹ã‚‰å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
def fetch_weather_from_jma(latitude, longitude)
  agrr_client_path = Rails.root.join('bin', 'agrr_client').to_s
  
  unless File.exist?(agrr_client_path)
    ColorLogger.error("agrr clientãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: #{agrr_client_path}")
    return nil
  end
  
  # 2000å¹´1æœˆ1æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  start_date = Date.new(2000, 1, 1)
  end_date = Date.today
  
  command = [
    agrr_client_path,
    'weather',
    '--location', "#{latitude},#{longitude}",
    '--start-date', start_date.to_s,
    '--end-date', end_date.to_s,
    '--data-source', 'jma',
    '--json'
  ]
  
  ColorLogger.info("å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: #{command.join(' ')}")
  
  stdout, stderr, status = Open3.capture3(*command)
  
  unless status.success?
    ColorLogger.error("agrrã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: #{stderr}")
    return nil
  end
  
  JSON.parse(stdout)
rescue JSON::ParserError => e
  ColorLogger.error("JSONè§£æã‚¨ãƒ©ãƒ¼: #{e.message}")
  nil
rescue => e
  ColorLogger.error("å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: #{e.message}")
  nil
end

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
farm_name_filter = nil

ARGV.each_with_index do |arg, i|
  case arg
  when '--farm-name'
    farm_name_filter = ARGV[i + 1] if ARGV[i + 1]
  end
end

# ãƒ˜ãƒƒãƒ€ãƒ¼
ColorLogger.log("\n" + "=" * 60, :blue)
ColorLogger.log("å‚ç…§è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆJMAç‰ˆï¼‰", :blue)
ColorLogger.log("=" * 60, :blue)
puts ""

# 1. DBã‹ã‚‰å‚ç…§è¾²å ´ã‚’å–å¾—
ColorLogger.info("å‚ç…§è¾²å ´ã‚’æ¤œç´¢ä¸­...")
farms = Farm.where(is_reference: true)
farms = farms.where(name: farm_name_filter) if farm_name_filter

if farms.empty?
  ColorLogger.error("å‚ç…§è¾²å ´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã« 'rails db:seed' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")
  exit 1
end

ColorLogger.success("#{farms.count}ä»¶ã®å‚ç…§è¾²å ´ã‚’ç™ºè¦‹ã—ã¾ã—ãŸ")
puts ""

# 2. å„è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
output = {}

farms.each_with_index do |farm, index|
  ColorLogger.log("\n[#{index + 1}/#{farms.count}] å‡¦ç†ä¸­: #{farm.name}", :blue)
  puts "  ä½ç½®: #{farm.latitude}, #{farm.longitude}"
  
  # JMAã‹ã‚‰å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆ2000å¹´1æœˆ1æ—¥ã€œä»Šæ—¥ã¾ã§ï¼‰
  weather_result = fetch_weather_from_jma(farm.latitude, farm.longitude)
  
  if weather_result.nil?
    ColorLogger.warning("  ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰")
    next
  end
  
  # ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
  location_data = weather_result['location']
  weather_data_raw = weather_result['data']
  
  if weather_data_raw.nil? || weather_data_raw.empty?
    ColorLogger.warning("  ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰")
    next
  end
  
  # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
  weather_data = weather_data_raw.map do |daily|
    {
      'date' => daily['time'],
      'temperature_max' => daily['temperature_2m_max'],
      'temperature_min' => daily['temperature_2m_min'],
      'temperature_mean' => daily['temperature_2m_mean'],
      'precipitation' => daily['precipitation_sum'],
      'sunshine_hours' => daily['sunshine_hours'],
      'wind_speed' => daily['wind_speed_10m'],
      'weather_code' => daily['weather_code']
    }
  end
  
  output[farm.name] = {
    'name' => farm.name,
    'latitude' => farm.latitude,
    'longitude' => farm.longitude,
    'is_reference' => farm.is_reference,
    'weather_location' => {
      'latitude' => location_data['latitude'],
      'longitude' => location_data['longitude'],
      'elevation' => location_data['elevation'],
      'timezone' => location_data['timezone']
    },
    'weather_data' => weather_data
  }
  
  ColorLogger.success("  #{weather_data.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ")
end

if output.empty?
  ColorLogger.error("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
  exit 1
end

# 3. ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
fixture_path = Rails.root.join('db/fixtures/reference_weather.json')
FileUtils.mkdir_p(File.dirname(fixture_path))
File.write(fixture_path, JSON.pretty_generate(output))

puts ""
ColorLogger.log("=" * 60, :green)
ColorLogger.success("å®Œäº†ï¼")
ColorLogger.log("=" * 60, :green)
puts ""
puts "ğŸ“„ ä¿å­˜å…ˆ: #{fixture_path}"
puts "ğŸ“Š è¾²å ´æ•°: #{output.keys.count}"
puts "ğŸ“Š ç·å¤©æ°—ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: #{output.values.sum { |v| v['weather_data'].count }}"
puts ""
ColorLogger.info("æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
puts "  1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª: cat #{fixture_path} | head -n 50"
puts "  2. Gitã«ã‚³ãƒŸãƒƒãƒˆ: git add #{fixture_path}"
puts "  3. ä»¥å¾Œã¯ 'rails db:seed' ã§é«˜é€Ÿã«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ãŒå¯èƒ½ã«ãªã‚Šã¾ã™"
puts ""
