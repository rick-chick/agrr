#!/usr/bin/env ruby
# frozen_string_literal: true

# å‚ç…§è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆAPIç‰ˆï¼‰
#
# ä½¿ç”¨æ–¹æ³•:
#   bin/fetch_reference_weather_data                           # å…¨å‚ç…§è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
#   bin/fetch_reference_weather_data --farm-name "åŒ—æµ·é“ãƒ»æœ­å¹Œ"  # ç‰¹å®šã®è¾²å ´ã®ã¿
#   bin/fetch_reference_weather_data --api-url http://localhost:3000  # ã‚«ã‚¹ã‚¿ãƒ API URL
#
# å‰ææ¡ä»¶:
#   - rails db:seed ãŒå®Ÿè¡Œæ¸ˆã¿ï¼ˆå‚ç…§è¾²å ´ãŒDBã«å­˜åœ¨ã™ã‚‹ï¼‰
#   - Webã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ï¼ˆdocker compose up web ã¾ãŸã¯ rails serverï¼‰
#   - Solid Queue ãŒèµ·å‹•ã—ã¦ã„ã‚‹ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–å‡¦ç†ç”¨ï¼‰
#
# å‡¦ç†å†…å®¹:
#   1. DBã‹ã‚‰å‚ç…§è¾²å ´ã‚’å–å¾—
#   2. å„è¾²å ´ã«ã¤ã„ã¦ APIçµŒç”±ã§å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹
#   3. ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…æ©Ÿï¼ˆé€²æ—è¡¨ç¤ºï¼‰
#   4. DBã‹ã‚‰å…¨å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šã€JSONã«å‡ºåŠ›
#   5. db/fixtures/reference_weather.json ã«ä¿å­˜

require 'fileutils'
require 'json'

# Railsã®ç’°å¢ƒã‚’èª­ã¿è¾¼ã‚€å‰ã«net/httpã‚’ãƒ­ãƒ¼ãƒ‰
require 'net/http'
require 'uri'

require_relative '../config/environment'

# ãƒ­ã‚°å‡ºåŠ›ç”¨ã®ã‚«ãƒ©ãƒ¼å®šç¾©
class ColorLogger
  COLORS = {
    red: "\e[31m",
    green: "\e[32m",
    yellow: "\e[33m",
    blue: "\e[34m",
    reset: "\e[0m"
  }

  def self.log(message, color = :reset)
    puts "#{COLORS[color]}#{message}#{COLORS[:reset]}"
  end

  def self.info(message)
    log("â„¹ï¸  #{message}", :blue)
  end

  def self.success(message)
    log("âœ… #{message}", :green)
  end

  def self.warning(message)
    log("âš ï¸  #{message}", :yellow)
  end

  def self.error(message)
    log("âŒ #{message}", :red)
  end
end

# API Client
class AgrrApiClient
  def initialize(base_url)
    @base_url = base_url
  end

  def fetch_weather_data(farm_id)
    uri = URI("#{@base_url}/api/v1/internal/farms/#{farm_id}/fetch_weather_data")
    request = Net::HTTP::Post.new(uri)
    request['Content-Type'] = 'application/json'
    
    response = Net::HTTP.start(uri.hostname, uri.port, use_ssl: uri.scheme == 'https') do |http|
      http.request(request)
    end
    
    JSON.parse(response.body)
  rescue => e
    { 'error' => e.message }
  end

  def weather_status(farm_id)
    uri = URI("#{@base_url}/api/v1/internal/farms/#{farm_id}/weather_status")
    response = Net::HTTP.get(uri)
    JSON.parse(response)
  rescue => e
    { 'error' => e.message }
  end

  def get_weather_data(farm_id)
    uri = URI("#{@base_url}/api/v1/internal/farms/#{farm_id}/weather_data")
    response = Net::HTTP.get(uri)
    JSON.parse(response)
  rescue => e
    { 'error' => e.message }
  end
end

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
farm_name_filter = nil
api_url = 'http://localhost:3000'

ARGV.each_with_index do |arg, i|
  case arg
  when '--farm-name'
    farm_name_filter = ARGV[i + 1] if ARGV[i + 1]
  when '--api-url'
    api_url = ARGV[i + 1] if ARGV[i + 1]
  end
end

# ãƒ˜ãƒƒãƒ€ãƒ¼
ColorLogger.log("\n" + "=" * 60, :blue)
ColorLogger.log("å‚ç…§è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆAPIç‰ˆï¼‰", :blue)
ColorLogger.log("=" * 60, :blue)
puts ""
ColorLogger.info("API URL: #{api_url}")
puts ""

# APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
api_client = AgrrApiClient.new(api_url)

# 1. DBã‹ã‚‰å‚ç…§è¾²å ´ã‚’å–å¾—
ColorLogger.info("å‚ç…§è¾²å ´ã‚’æ¤œç´¢ä¸­...")
farms = Farm.where(is_reference: true)
farms = farms.where(name: farm_name_filter) if farm_name_filter

if farms.empty?
  ColorLogger.error("å‚ç…§è¾²å ´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã« 'rails db:seed' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")
  exit 1
end

ColorLogger.success("#{farms.count}ä»¶ã®å‚ç…§è¾²å ´ã‚’ç™ºè¦‹ã—ã¾ã—ãŸ")
puts ""

# 2. å„è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
farms.each_with_index do |farm, index|
  ColorLogger.log("\n[#{index + 1}/#{farms.count}] å‡¦ç†ä¸­: #{farm.name} (ID: #{farm.id})", :blue)
  puts "  ä½ç½®: #{farm.latitude}, #{farm.longitude}"
  
  # APIçµŒç”±ã§å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹
  result = api_client.fetch_weather_data(farm.id)
  
  if result['error']
    ColorLogger.error("  APIã‚¨ãƒ©ãƒ¼: #{result['error']}")
    next
  end
  
  if result['message'] == 'Weather data already exists'
    ColorLogger.success("  å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿ (#{result['weather_data_count']}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰)")
    next
  end
  
  ColorLogger.info("  å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­ï¼ˆæ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰...")
  
  # ã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
  last_progress = -1
  loop do
    sleep 2
    
    status_result = api_client.weather_status(farm.id)
    
    if status_result['error']
      ColorLogger.error("  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: #{status_result['error']}")
      break
    end
    
    status = status_result['status']
    progress = status_result['progress']
    
    # é€²æ—ãŒå¤‰ã‚ã£ãŸæ™‚ã®ã¿è¡¨ç¤º
    if progress != last_progress
      print "\r  é€²æ—: #{progress}% (#{status_result['fetched_blocks']}/#{status_result['total_blocks']} ãƒ–ãƒ­ãƒƒã‚¯) [#{status}]"
      last_progress = progress
    end
    
    break if status == 'completed'
    
    if status == 'failed'
      puts ""
      ColorLogger.error("  å¤±æ•—: #{status_result['last_error']}")
      ColorLogger.warning("  ã“ã®è¾²å ´ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
      break
    end
  end
  
  puts ""
  
  if status_result && status_result['status'] == 'completed'
    weather_count = status_result['weather_data_count'] || 0
    ColorLogger.success("  å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: #{weather_count}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰")
  end
end

puts ""
ColorLogger.log("=" * 60, :blue)

# 3. APIçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦JSONã«å¤‰æ›
ColorLogger.info("ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...")
output = {}

farms.reload.each do |farm|
  data_result = api_client.get_weather_data(farm.id)
  
  if data_result['error']
    ColorLogger.warning("  #{farm.name}: #{data_result['error']}ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰")
    next
  end
  
  unless data_result['success']
    ColorLogger.warning("  #{farm.name}: ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰")
    next
  end
  
  output[farm.name] = {
    name: farm.name,
    latitude: farm.latitude,
    longitude: farm.longitude,
    is_reference: farm.is_reference,
    weather_location: data_result['weather_location'],
    weather_data: data_result['weather_data']
  }
  
  ColorLogger.success("  #{farm.name}: #{data_result['count']}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
end

if output.empty?
  ColorLogger.error("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
  exit 1
end

# 4. ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
fixture_path = Rails.root.join('db/fixtures/reference_weather.json')
FileUtils.mkdir_p(File.dirname(fixture_path))
File.write(fixture_path, JSON.pretty_generate(output))

puts ""
ColorLogger.log("=" * 60, :green)
ColorLogger.success("å®Œäº†ï¼")
ColorLogger.log("=" * 60, :green)
puts ""
puts "ğŸ“„ ä¿å­˜å…ˆ: #{fixture_path}"
puts "ğŸ“Š è¾²å ´æ•°: #{output.keys.count}"
puts "ğŸ“Š ç·å¤©æ°—ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: #{output.values.sum { |v| v[:weather_data].count }}"
puts ""
ColorLogger.info("æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
puts "  1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª: cat #{fixture_path} | head -n 50"
puts "  2. Gitã«ã‚³ãƒŸãƒƒãƒˆ: git add #{fixture_path}"
puts "  3. ä»¥å¾Œã¯ 'rails db:seed' ã§é«˜é€Ÿã«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ãŒå¯èƒ½ã«ãªã‚Šã¾ã™"
puts ""
