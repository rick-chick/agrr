#!/bin/bash

# Development server startup script
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§rails serverã‚’èµ·å‹•ã™ã‚‹ã¾ã§ã®æº–å‚™ã‚’è‡ªå‹•åŒ–

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ï¼ˆCtrl+Cã§çµ‚äº†ã—ãŸã¨ãã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
cleanup() {
    exit 0
}

trap cleanup SIGINT SIGTERM

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•
cd "$(dirname "$0")/.."

# æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
print_status "Checking for existing processes..."

# ãƒãƒ¼ãƒˆ3000ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
# ã¾ãšãƒãƒ¼ãƒˆ3000ã‚’ç›´æ¥ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€ã‚‚ç¢ºå®Ÿãªæ–¹æ³•ï¼‰
PORT_PID=$(lsof -ti:3000 2>/dev/null | head -1 || ss -tlnp 2>/dev/null | grep :3000 | awk '{print $6}' | cut -d, -f2 | cut -d= -f2 | head -1 || true)

# lsofãŒä½¿ãˆãªã„å ´åˆã€ssã‹ã‚‰PIDã‚’å–å¾—
if [ -z "$PORT_PID" ]; then
    PORT_INFO=$(ss -tlnp 2>/dev/null | grep :3000 | head -1 || true)
    if [ -n "$PORT_INFO" ]; then
        PORT_PID=$(echo "$PORT_INFO" | grep -oP 'pid=\K\d+' | head -1 || true)
    fi
fi

# ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
if [ -n "$PORT_PID" ] && [ "$PORT_PID" != "" ]; then
    if ps -p "$PORT_PID" > /dev/null 2>&1; then
        PROC_NAME=$(ps -p "$PORT_PID" -o comm= 2>/dev/null || echo "unknown")
        PROC_ARGS=$(ps -p "$PORT_PID" -o args= 2>/dev/null || echo "")
        print_warning "Port 3000 is already in use by process $PORT_PID ($PROC_NAME)"
        if echo "$PROC_ARGS" | grep -qE "(puma|rails|ruby|rack)" 2>/dev/null || echo "$PROC_NAME" | grep -qE "(puma|ruby)" 2>/dev/null; then
            print_warning "Stopping process $PORT_PID..."
            kill "$PORT_PID" 2>/dev/null || true
            sleep 2
            # å†ç¢ºèª
            if lsof -ti:3000 > /dev/null 2>&1 || ss -tlnp 2>/dev/null | grep -q :3000; then
                print_error "Port 3000 is still in use. Please manually stop the process or use a different port."
                exit 1
            fi
        else
            print_error "Port 3000 is in use by $PROC_NAME. Please stop it manually or use a different port."
            exit 1
        fi
    fi
fi

# Puma/Railsãƒ—ãƒ­ã‚»ã‚¹ã‚’ç›´æ¥ç¢ºèªï¼ˆè¿½åŠ ãƒã‚§ãƒƒã‚¯ï¼‰
PUMA_PIDS=$(pgrep -f "puma\|rails server" 2>/dev/null || true)
if [ -n "$PUMA_PIDS" ]; then
    for PID in $PUMA_PIDS; do
        if ps -p "$PID" > /dev/null 2>&1; then
            PROC_ARGS=$(ps -p "$PID" -o args= 2>/dev/null || echo "")
            # ãƒãƒ¼ãƒˆ3000ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèª
            if echo "$PROC_ARGS" | grep -qE "3000|tcp://.*:3000" 2>/dev/null || lsof -p "$PID" 2>/dev/null | grep -q ":3000"; then
                print_warning "Found Puma/Rails process $PID using port 3000, stopping it..."
                kill "$PID" 2>/dev/null || true
                sleep 1
            fi
        fi
    done
    sleep 1
fi

if [ -f tmp/pids/server.pid ]; then
    OLD_PID=$(cat tmp/pids/server.pid)
    if kill -0 "$OLD_PID" 2>/dev/null; then
        print_warning "Found existing Rails server (PID: $OLD_PID), stopping it..."
        kill "$OLD_PID" 2>/dev/null || true
        sleep 1
    fi
    rm -f tmp/pids/server.pid
fi

# æ—¢å­˜ã®Pumaãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
if pgrep -f "puma\|rails server" > /dev/null 2>&1; then
    print_warning "Found existing Puma/Rails server processes, stopping them..."
    pkill -f "puma\|rails server" 2>/dev/null || true
    sleep 1
fi

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
if [ -d "log" ]; then
    LOG_FILE="log/development.log"
    CURRENT_USER=$(whoami)
    LOG_WRITABLE=false
    
    # logãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ãƒã‚§ãƒƒã‚¯
    if [ ! -w "log" ]; then
        LOG_DIR_OWNER=$(stat -c '%U' "log" 2>/dev/null || stat -f '%Su' "log" 2>/dev/null || echo "")
        print_warning "Log directory 'log' is not writable (owned by: ${LOG_DIR_OWNER:-unknown})"
        print_warning "This will cause Rails startup errors."
    fi
    
    if [ -f "$LOG_FILE" ]; then
        LOG_OWNER=$(stat -c '%U' "$LOG_FILE" 2>/dev/null || stat -f '%Su' "$LOG_FILE" 2>/dev/null || echo "")
        if [ -n "$LOG_OWNER" ] && [ "$LOG_OWNER" != "$CURRENT_USER" ]; then
            print_warning "Log file $LOG_FILE is owned by $LOG_OWNER, but current user is $CURRENT_USER"
            
            # ã¾ãšæ¨©é™ã‚’å¤‰æ›´ã—ã¦ã¿ã‚‹
            if chmod 666 "$LOG_FILE" 2>/dev/null && [ -w "$LOG_FILE" ]; then
                print_status "âœ“ Log file permissions updated"
                LOG_WRITABLE=true
            # å‰Šé™¤ã—ã¦å†ä½œæˆã‚’è©¦ã¿ã‚‹
            elif rm -f "$LOG_FILE" 2>/dev/null && touch "$LOG_FILE" 2>/dev/null; then
                chmod 664 "$LOG_FILE" 2>/dev/null || true
                print_status "âœ“ Log file recreated with correct permissions"
                LOG_WRITABLE=true
            else
                LOG_WRITABLE=false
            fi
            
            if [ "$LOG_WRITABLE" = false ]; then
                print_error ""
                print_error "âš ï¸  Cannot fix log file permissions automatically."
                print_error ""
                print_error "Please run the following commands to fix:"
                print_error "  sudo chown -R $CURRENT_USER:$CURRENT_USER log/"
                print_error "  sudo chmod -R 775 log/"
                print_error ""
                print_error "Or if you prefer to keep the old log:"
                print_error "  sudo mv log/development.log log/development.log.backup"
                print_error "  sudo touch log/development.log"
                print_error "  sudo chown $CURRENT_USER:$CURRENT_USER log/development.log"
                print_error ""
                print_warning "Continuing anyway, but Rails may fail to start..."
            fi
        elif [ ! -w "$LOG_FILE" ]; then
            # æ›¸ãè¾¼ã¿æ¨©é™ãŒãªã„å ´åˆ
            print_warning "Log file $LOG_FILE is not writable, attempting to fix..."
            if chmod 664 "$LOG_FILE" 2>/dev/null && [ -w "$LOG_FILE" ]; then
                print_status "âœ“ Log file permissions fixed"
                LOG_WRITABLE=true
            else
                print_warning "Cannot change permissions, but continuing..."
                LOG_WRITABLE=false
            fi
        else
            LOG_WRITABLE=true
        fi
    else
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if touch "$LOG_FILE" 2>/dev/null; then
            chmod 664 "$LOG_FILE" 2>/dev/null || true
            LOG_WRITABLE=true
        else
            print_warning "Cannot create log file $LOG_FILE (permission denied)"
            LOG_WRITABLE=false
        fi
    fi
fi

print_step "ğŸš€ Starting development server setup..."

# 1. ç’°å¢ƒãƒã‚§ãƒƒã‚¯
print_step "1/6 Checking environment..."

if ! command -v ruby &> /dev/null; then
    print_error "Ruby is not installed. Please install Ruby 3.3.10."
    exit 1
fi

RUBY_VERSION=$(ruby -v | cut -d' ' -f2 | cut -d'p' -f1)
if [[ "$RUBY_VERSION" != "3.3.10" ]]; then
    print_warning "Ruby version $RUBY_VERSION detected. Expected 3.3.10."
fi

if ! command -v node &> /dev/null; then
    print_error "Node.js is not installed. Please install Node.js 20.x or later."
    exit 1
fi

NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt "20" ]; then
    print_warning "Node.js version $(node -v) detected. Recommended: Node.js 20.x or later."
fi

if ! command -v npm &> /dev/null; then
    print_error "npm is not installed. Please install npm."
    exit 1
fi

print_status "âœ“ Ruby $(ruby -v)"
print_status "âœ“ Node.js $(node -v)"

# 2. Bundlerãƒã‚§ãƒƒã‚¯
print_step "2/6 Checking Bundler..."
if ! command -v bundle &> /dev/null; then
    print_status "Installing Bundler..."
    gem install bundler
fi

# 3. Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
print_step "3/6 Installing gems..."
if bundle check &> /dev/null; then
    print_status "âœ“ Gems are already installed"
else
    print_status "Installing gems..."
    bundle install
fi

# 4. npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
print_step "4/6 Installing npm packages..."
if [ -d "node_modules" ] && [ -f "node_modules/.package-lock.json" ]; then
    print_status "âœ“ npm packages are already installed"
else
    print_status "Installing npm packages..."
    npm install
fi

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
print_step "5/6 Setting up database..."
if [ -f "storage/development.sqlite3" ]; then
    print_status "âœ“ Database exists"
    print_status "Running migrations..."
    bundle exec rails db:migrate || true
else
    print_status "Creating database..."
    bundle exec rails db:create || true
    bundle exec rails db:migrate || true
fi

# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p storage tmp/storage

# 6. application.jsã®ãƒ“ãƒ«ãƒ‰
print_step "6/6 Building JavaScript assets..."

# application.jsãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯å¤ã„å ´åˆã¯ãƒ“ãƒ«ãƒ‰
if [ ! -f "app/assets/builds/application.js" ]; then
    print_status "Building application.js..."
    npm run build
    print_status "âœ“ application.js built"
else
    print_status "âœ“ application.js already exists"
    print_status "  (Run 'npm run build' manually to rebuild after changes)"
fi
print_status "âœ“ Setup complete!"
print_status ""
print_warning "âš ï¸  Press Ctrl+C to stop the server"
print_status ""
print_status "Server will be available at: http://localhost:3000"
print_status "Note: Run 'npm run build' manually to rebuild JavaScript assets after changes"
print_status ""

# Railsã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
exec bundle exec rails server

