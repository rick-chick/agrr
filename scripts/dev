#!/bin/bash

# Development server startup script
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§rails serverã‚’èµ·å‹•ã™ã‚‹ã¾ã§ã®æº–å‚™ã‚’è‡ªå‹•åŒ–

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ï¼ˆCtrl+Cã§çµ‚äº†ã—ãŸã¨ãã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
cleanup() {
    exit 0
}

trap cleanup SIGINT SIGTERM

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•
cd "$(dirname "$0")/.."

# æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
print_status "Checking for existing processes..."
if [ -f tmp/pids/server.pid ]; then
    OLD_PID=$(cat tmp/pids/server.pid)
    if kill -0 "$OLD_PID" 2>/dev/null; then
        print_warning "Found existing Rails server (PID: $OLD_PID), stopping it..."
        kill "$OLD_PID" 2>/dev/null || true
        sleep 1
    fi
    rm -f tmp/pids/server.pid
fi

# æ—¢å­˜ã®Pumaãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
if pgrep -f "puma\|rails server" > /dev/null 2>&1; then
    print_warning "Found existing Puma/Rails server processes, stopping them..."
    pkill -f "puma\|rails server" 2>/dev/null || true
    sleep 1
fi

print_step "ğŸš€ Starting development server setup..."

# 1. ç’°å¢ƒãƒã‚§ãƒƒã‚¯
print_step "1/6 Checking environment..."

if ! command -v ruby &> /dev/null; then
    print_error "Ruby is not installed. Please install Ruby 3.3.10."
    exit 1
fi

RUBY_VERSION=$(ruby -v | cut -d' ' -f2 | cut -d'p' -f1)
if [[ "$RUBY_VERSION" != "3.3.10" ]]; then
    print_warning "Ruby version $RUBY_VERSION detected. Expected 3.3.10."
fi

if ! command -v node &> /dev/null; then
    print_error "Node.js is not installed. Please install Node.js 20.x or later."
    exit 1
fi

NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt "20" ]; then
    print_warning "Node.js version $(node -v) detected. Recommended: Node.js 20.x or later."
fi

if ! command -v npm &> /dev/null; then
    print_error "npm is not installed. Please install npm."
    exit 1
fi

print_status "âœ“ Ruby $(ruby -v)"
print_status "âœ“ Node.js $(node -v)"

# 2. Bundlerãƒã‚§ãƒƒã‚¯
print_step "2/6 Checking Bundler..."
if ! command -v bundle &> /dev/null; then
    print_status "Installing Bundler..."
    gem install bundler
fi

# 3. Gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
print_step "3/6 Installing gems..."
if bundle check &> /dev/null; then
    print_status "âœ“ Gems are already installed"
else
    print_status "Installing gems..."
    bundle install
fi

# 4. npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
print_step "4/6 Installing npm packages..."
if [ -d "node_modules" ] && [ -f "node_modules/.package-lock.json" ]; then
    print_status "âœ“ npm packages are already installed"
else
    print_status "Installing npm packages..."
    npm install
fi

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
print_step "5/6 Setting up database..."
if [ -f "storage/development.sqlite3" ]; then
    print_status "âœ“ Database exists"
    print_status "Running migrations..."
    bundle exec rails db:migrate || true
else
    print_status "Creating database..."
    bundle exec rails db:create || true
    bundle exec rails db:migrate || true
fi

# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p storage tmp/storage

# 6. application.jsã®ãƒ“ãƒ«ãƒ‰
print_step "6/6 Building JavaScript assets..."

# application.jsãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯å¤ã„å ´åˆã¯ãƒ“ãƒ«ãƒ‰
if [ ! -f "app/assets/builds/application.js" ]; then
    print_status "Building application.js..."
    npm run build
    print_status "âœ“ application.js built"
else
    print_status "âœ“ application.js already exists"
    print_status "  (Run 'npm run build' manually to rebuild after changes)"
fi
print_status "âœ“ Setup complete!"
print_status ""
print_warning "âš ï¸  Press Ctrl+C to stop the server"
print_status ""
print_status "Server will be available at: http://localhost:3000"
print_status "Note: Run 'npm run build' manually to rebuild JavaScript assets after changes"
print_status ""

# Railsã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
exec bundle exec rails server

