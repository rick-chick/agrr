# ドラッグアンドドロップ処理のパフォーマンス分析結果

## 調査日時
2025-10-19 06:18:23 UTC

## 測定データ

### 環境
- 計画ID: 21
- 圃場数: 2
- 栽培数: 3
- 計画期間: 2025-10-19 ~ 2026-12-31

### 処理時間の内訳

```
⏱️ [PERF] === 合計処理時間 ===
⏱️ [PERF] 全体: 6925.08ms (約7秒)
⏱️ [PERF] - DB読み込み: 122.03ms (1.8%)
⏱️ [PERF] - データ構築: 248.01ms (3.6%)
⏱️ [PERF] - agrr adjust実行: 6492.79ms (93.8%) ★★★
⏱️ [PERF] - DB保存: 62.04ms (0.9%)
```

#### データ構築の詳細内訳
```
⏱️ [PERF] 割り当てデータ構築: 28.94ms
⏱️ [PERF] 圃場設定構築: 0.27ms
⏱️ [PERF] 作物設定構築: 114.05ms
⏱️ [PERF] 交互作用ルール構築: 8.23ms
```

#### Gateway層の詳細
```
⏱️ [PERF Gateway] ファイル作成完了: 9.39ms
⏱️ [PERF Gateway] Python実行: （約6483ms）← 計算値
⏱️ [PERF Gateway] 結果パース: （推定 < 10ms）
```

## ボトルネック特定

### 🎯 **最大のボトルネック: Pythonコマンド実行（agrr optimize adjust）**

**所要時間**: 6492.79ms（約6.5秒）
**全体の占める割合**: 93.8%
**内訳**:
- ファイル作成: 9.39ms
- Python実行: 約6483ms ★★★
- 結果パース: 推定10ms未満

### 分析

1. **Pythonコマンドが圧倒的なボトルネック**
   - 全処理時間の93.8%を占める
   - 他の処理（DB読み込み、データ構築、DB保存）は合計で432ms（6.2%）と軽量

2. **データ構築は問題なし**
   - 248ms（3.6%）と十分高速
   - N+1クエリなどの問題は見られない

3. **DB操作も問題なし**
   - 読み込み: 122ms、保存: 62ms と高速

## Pythonコマンドの実行内容

実行されたコマンド:
```bash
/app/lib/core/agrr optimize adjust \
  --current-allocation /tmp/current_allocation*.json \
  --moves /tmp/moves*.json \
  --fields-file /tmp/fields*.json \
  --crops-file /tmp/crops*.json \
  --planning-start 2025-10-19 \
  --planning-end 2026-12-31 \
  --weather-file /tmp/weather*.json \
  --format json \
  --interaction-rules-file /tmp/interaction_rules*.json
```

このコマンド内で行われている処理（推測）:
1. 各種JSONファイルの読み込みとパース
2. 気象データの処理
3. GDD（成長度日）計算
4. 制約条件の検証（休閑期間、圃場の重複など）
5. 最適化アルゴリズムの実行
6. 結果のJSON生成

## 推奨対策

### 即時対応（今すぐできる）

1. **ユーザーフィードバックの改善**
   ```javascript
   // ドラッグ中にローディング表示
   - ドラッグ完了時に「最適化中...」のメッセージ表示
   - プログレスバーやスピナーの追加
   - 「約7秒かかります」の目安時間表示
   ```

2. **タイムアウト設定**
   ```ruby
   # AdjustGateway に max_time オプションを追加
   max_time: 10  # 10秒でタイムアウト
   ```

### 短期対応（1-2週間）

1. **楽観的UI更新**
   ```javascript
   // location.reload() を削除して部分更新
   - ドラッグ直後に画面上のバーを移動
   - APIレスポンス受信後にガントチャートのみ再描画
   - エラー時のみロールバック
   ```
   
   **効果**: ページリロード時間（推定1-3秒）を削減
   **ユーザー体験**: ドラッグ後即座に反映されたように見える

2. **キャッシュの活用**
   ```ruby
   # 気象データをキャッシュ
   Rails.cache.fetch("weather_data_#{farm_id}_#{period}", expires_in: 1.hour) do
     # 気象データ取得
   end
   ```

### 中期対応（1-2ヶ月）

1. **Pythonコマンドのプロファイリング**
   ```python
   # agrr optimize adjustコマンド内でプロファイリング
   import cProfile
   # ボトルネック箇所を特定
   ```

2. **最適化アルゴリズムの改善**
   - 不要な計算の削減
   - 並列処理の活用
   - 早期終了条件の追加

3. **GDD計算のキャッシュ**
   ```python
   # 作物・期間ごとのGDD計算結果をキャッシュ
   ```

4. **バックグラウンドジョブ化**
   ```ruby
   # Solid Queueでバックグラウンド処理
   AdjustJob.perform_later(cultivation_plan_id, moves)
   
   # WebSocketでリアルタイム通知
   ActionCable.server.broadcast("cultivation_plan_#{id}", {status: 'completed'})
   ```
   
   **効果**: ユーザーは待たずに他の作業ができる

### 長期対応（3ヶ月以上）

1. **Python→Rustへの移植**
   - 最適化アルゴリズムを高速なRustで実装
   - 10-100倍の高速化が期待できる

2. **インクリメンタル最適化**
   - 全体を再最適化せず、移動したバー周辺のみを再計算
   - データ量に依存しない一定時間での処理

## 結論

### 問題の所在
**Pythonコマンド（agrr optimize adjust）の実行に約6.5秒かかっており、これが全処理時間の93.8%を占めている。**

### 即効性のある対策
1. ローディングインジケーター追加（今すぐ）
2. 楽観的UI更新（1-2週間）
3. バックグラウンドジョブ化（1-2ヶ月）

### 根本的な対策
1. Pythonコマンドのプロファイリングとボトルネック特定
2. 最適化アルゴリズムの改善
3. 必要に応じてRustへの移植

## 次のステップ

### 優先度1（今すぐ）
- [ ] ローディングインジケーター追加
- [ ] プログレスバー追加
- [ ] 「約7秒かかります」のメッセージ表示

### 優先度2（1週間以内）
- [ ] Pythonコマンドのプロファイリング実施
- [ ] ボトルネック箇所の特定
- [ ] 楽観的UI更新の実装検討

### 優先度3（1ヶ月以内）
- [ ] 最適化アルゴリズムの改善
- [ ] キャッシュ機構の実装
- [ ] バックグラウンドジョブ化の検討

---

**作成日**: 2025-10-19
**更新日**: 2025-10-19
**分析者**: AI Agent

