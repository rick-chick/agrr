# Region機能 - シードデータ設定

## 現在の状況

### 日本（region: "jp"）の参照データ ✅ 完了

AGRRのシードデータ（`db/seeds.rb`）は、日本の参照データとして以下を提供しています。

#### 1. 参照農場（Farms）
- **件数**: 47都道府県
- **地域**: 北海道（緯度43.06）〜 沖縄（緯度26.21）
- **region**: `"jp"`
- **特徴**: 
  - 日本全国の主要都市の気候データ
  - 442,501件の天気データレコード（2000年〜現在）
  - 緯度降順（北から南）にソート済み

#### 2. 参照作物（Crops）
- **件数**: 15種類
- **region**: `"jp"`
- **作物例**: 
  - トマト、ジャガイモ、玉ねぎ、キャベツ、ニンジン
  - ナス、ピーマン、キュウリ、レタス、大根
  - ブロッコリー、白菜、ほうれん草、長ネギ、ゴボウ
- **作物グループ**: 8科（ナス科、ウリ科、アブラナ科、キク科、セリ科、ネギ科、ヒユ科、イネ科）
- **生育ステージ**: 54段階（AI生成データ）

#### 3. サンプル圃場（Fields）
- **件数**: 12件
- **region**: `"jp"`
- **総面積**: 14,100㎡
- **特徴**: 日本の主要参照農場に紐づくサンプル圃場

#### 4. 輪作ルール（InteractionRules）
- **件数**: 16ルール
- **region**: `"jp"`
- **対象**: 8つの作物グループ
- **平均影響係数**: 78.1%
- **内容**: 日本の気候条件（高温多湿）を反映した連作障害データ

| 作物グループ | 影響係数 | 説明 |
|-------------|---------|------|
| ナス科 | 0.6 | 非常に強い連作障害（40%減収） |
| ウリ科 | 0.65 | 非常に強い連作障害（35%減収） |
| アブラナ科 | 0.75 | 強い連作障害（25%減収） |
| キク科 | 0.75 | 強い連作障害（25%減収） |
| セリ科 | 0.8 | 中程度の連作障害（20%減収） |
| ネギ科 | 0.85 | 軽い連作障害（15%減収） |
| ヒユ科 | 0.9 | 軽い連作障害（10%減収） |
| イネ科 | 0.95 | ほとんど連作障害なし（5%減収） |

## シードデータの実行

### 初回実行

```bash
# 開発環境
docker compose exec web bin/rails db:seed

# 本番環境
docker compose -f docker-compose.prod.yml exec web bin/rails db:seed
```

### データの確認

```bash
docker compose exec web bin/rails runner "
puts 'Farms (JP): ' + Farm.reference.by_region('jp').count.to_s
puts 'Crops (JP): ' + Crop.reference.by_region('jp').count.to_s
puts 'Fields (JP): ' + Field.by_region('jp').count.to_s
puts 'Rules (JP): ' + InteractionRule.reference.by_region('jp').count.to_s
"
```

### 既存データの更新

既存のデータベースに`region`カラムを追加した場合、シードを再実行することで自動的に`region: "jp"`が設定されます。

```bash
# マイグレーション実行後
docker compose exec web bin/rails db:migrate

# シード再実行（既存データを更新）
docker compose exec web bin/rails db:seed
```

## 今後の予定

### アメリカ（region: "us"）の参照データ

以下のデータセットを作成予定：

#### 参照農場
- **主要地域**: 
  - アイオワ（トウモロコシベルト）
  - カリフォルニア（セントラルバレー）
  - テキサス（パンハンドル）
  - ネブラスカ、カンザス、イリノイ
- **気候**: 大陸性気候、乾燥した内陸部
- **特徴**: 大規模農業に適した気候データ

#### 参照作物
- **主要作物**:
  - Field Corn（飼料用トウモロコシ）
  - Soybean（大豆）
  - Winter Wheat（冬小麦）
  - Cotton（綿花）
  - Alfalfa（アルファルファ）
- **特徴**: 
  - 大規模栽培（1.0ha/単位以上）
  - 機械化を前提とした設定
  - 作物グループは英語科名（Poaceae, Fabaceae等）

#### 輪作ルール
- **主要パターン**:
  - Corn-Soybean Rotation（コーン・大豆輪作）
  - Wheat-Fallow（小麦・休閑）
- **影響係数**: 
  - 日本より軽微（乾燥気候で病害リスク低）
  - 例：Solanaceae 0.8（20%減収）vs 日本0.6（40%減収）

### シード構造の拡張

将来的に`db/seeds/`ディレクトリを作成し、地域別にシードファイルを分離：

```
db/
  seeds.rb                    # メインシード（共通処理）
  seeds/
    japan.rb                  # 日本の参照データ
    united_states.rb          # アメリカの参照データ
    europe.rb                 # ヨーロッパの参照データ（将来）
```

### データ生成スクリプト

地域別のデータ生成スクリプトを作成予定：

```bash
# 日本の参照データ生成
bin/generate_reference_data --region jp

# アメリカの参照データ生成
bin/generate_reference_data --region us
```

## データ品質

### 日本の参照データ
- ✅ 実際の都道府県の緯度経度を使用
- ✅ Open-Meteo APIから取得した実測天気データ（2000年〜現在）
- ✅ AI（GPT-4o）が生成した作物要件データ
- ✅ 農業知識に基づいた連作障害データ

### データソース
- **気候データ**: Open-Meteo Historical Weather API
- **作物データ**: GPT-4o + 農業知識ベース
- **輪作ルール**: 農業文献・実践知識

## まとめ

| 項目 | 日本（jp） | アメリカ（us） |
|------|-----------|---------------|
| **Farms** | ✅ 47件 | 📝 計画中 |
| **Crops** | ✅ 15件 | 📝 計画中 |
| **Fields** | ✅ 12件 | 📝 計画中 |
| **InteractionRules** | ✅ 16件 | 📝 計画中 |
| **気候データ** | ✅ 442K件 | 📝 計画中 |

現在、日本の参照データセットは完全に実装されており、本番環境で使用可能です。アメリカの参照データセットは次フェーズで実装予定です。

