# 計画表の列数問題の分析

## ソースコードの実装（schedule.html.erb 82-162行目）

### データ準備（82-100行目）

```erb
<% 
  # 各圃場について、各栽培情報がどの期間にまたがるかを事前に計算
  field_cultivation_data = @selected_fields.map do |field|
    field_id = field[:id]
    cultivations = @cultivations_by_field[field_id] || []
    cultivation_periods = cultivations.map do |c|
      spanning_periods = @periods.select do |p|
        c[:start_date] <= p[:end_date] && c[:completion_date] >= p[:start_date]
      end
      start_period_index = spanning_periods.any? ? @periods.index(spanning_periods.first) : nil
      {
        cultivation: c,
        periods: spanning_periods,
        start_period_index: start_period_index,
        rowspan: spanning_periods.size
      }
    end
    { field: field, field_id: field_id, cultivation_periods: cultivation_periods }
  end
%>
```

### 各行の描画（102-162行目）

```erb
<% @periods.each_with_index do |period, period_index| %>
  <tr>
    <td class="schedule-table-period-cell">
      <%= period[:label] %>
    </td>
    <% field_cultivation_data.each do |field_data| %>
      <% 
        field = field_data[:field]
        cultivation_periods = field_data[:cultivation_periods]
        
        # この期間に開始する栽培情報を取得
        starting_cultivations = cultivation_periods.select do |cp|
          cp[:start_period_index] == period_index
        end
        
        # この期間に継続している栽培情報（前の期間から続いているもの）を取得
        continuing_cultivations = cultivation_periods.select do |cp|
          cp[:start_period_index] != nil &&
          cp[:start_period_index] < period_index && 
          cp[:periods].any? { |p| p == period }
        end
        
        display_cultivations = starting_cultivations
      %>
      <% if display_cultivations.any? %>
        <% 
          # 最初の栽培情報にrowspanを設定
          first_cp = display_cultivations.first
        %>
        <td class="schedule-table-cell" rowspan="<%= first_cp[:rowspan] %>" ...>
          <div class="cultivation-items">
            <% display_cultivations.each do |cp| %>
              ... すべての栽培情報を表示 ...
            <% end %>
          </div>
        </td>
      <% elsif continuing_cultivations.any? %>
        <%# 継続中の栽培情報は前の期間のrowspanで表示されるため、ここではセルをスキップ %>
      <% else %>
        <td class="schedule-table-cell">...</td>
      <% end %>
    <% end %>
  </tr>
<% end %>
```

## 現状の問題（ユーザー報告による）

**データ:**
- ほうれん草: 1ほ場、Q1内のみ（1月15日〜3月15日、rowspan=1）
- トマト: 1ほ場、Q1からQ2にまたがる（3月1日〜6月30日、rowspan=2）
- 両方とも同じ1ほ場で開始

**実際の表示（ユーザー報告）:**

```
【現状（問題あり）- 1ほ場のみ選択の場合】
┌────────┬──────────┐
│ 期間   │ 1ほ場    │
├────────┼──────────┤
│ Q1     │ ほうれん草│ ← 問題: トマトが表示されていない
│        │          │    同じ期間（Q1）に開始するはずなのに
├────────┼──────────┤
│ Q2     │ （空白）  │ ← 問題: トマトが継続表示されていない
│        │          │    rowspan=2で表示されるべき
└────────┴──────────┘

【現状（問題あり）- 1ほ場と2ほ場を選択した場合】
┌────────┬──────────┬──────────┐
│ 期間   │ 1ほ場    │ 2ほ場    │
├────────┼──────────┼──────────┤
│ Q1     │ ほうれん草│ トマト   │ ← 問題: トマトが2ほ場に表示されている
│        │          │          │    実際は1ほ場の栽培情報のはず
├────────┼──────────┼──────────┤
│ Q2     │ （空白）  │ トマト   │ ← 問題: トマトがQ2でも2ほ場に表示されている
│        │          │          │    （継続表示として）
└────────┴──────────┴──────────┘
```

**問題の原因分析:**

1. Q1の行:
   - 1ほ場のループ（`field_cultivation_data.each`）:
     - `starting_cultivations`にほうれん草とトマトの両方が含まれる（両方とも`start_period_index == period_index`）
     - `display_cultivations.any?`がtrue
     - `first_cp = display_cultivations.first` → ほうれん草（rowspan=1）が選ばれる
     - `<td rowspan="1">`でセルを作成し、ほうれん草とトマトの両方を表示するはず...
   
   **しかし、実際には:**
   - 1ほ場のセルにはほうれん草だけが表示される
   - トマトは2ほ場のセルに表示される
   
   **推測される原因:**
   - `@cultivations_by_field[field_id]`で1ほ場のデータを取得する際、トマトが取得されていない可能性
   - または、トマトが2ほ場のデータとして誤って分類されている可能性
   - または、`field_cultivation_data`の作成時に、トマトが別のほ場にマッピングされている可能性

2. Q2の行:
   - 1ほ場のループ:
     - `starting_cultivations`は空（トマトはQ1で開始しているため）
     - `continuing_cultivations`にトマトが含まれるはず（Q1から継続）
     - しかし、Q1のセルがrowspan=1（ほうれん草のみ）なので、トマトは継続表示されない
     - 結果として、空白セルが表示される
   
   - 2ほ場のループ:
     - トマトが2ほ場のデータとして認識されている場合、Q1で開始したセル（rowspan=2）が継続表示される

## あるべき姿（1ほ場の場合）

```
【あるべき姿（1ほ場の場合）】
┌────────┬──────────────────────────┐
│ 期間   │ 1ほ場                    │
├────────┼──────────────────────────┤
│ Q1     │ ┌──────────────┐         │ ← セル1: rowspan=2（最も長いrowspan=トマトの2）
│        │ │ ほうれん草   │         │    Q1で開始するすべての栽培情報を含む
│        │ │ トマト       │         │
├────────┼─┤              │         │ ← トマトが継続表示
│ Q2     │ │              │         │
│        │ └──────────────┘         │
└────────┴──────────────────────────┘
```

## あるべき姿（2ほ場の場合）

```
【あるべき姿（2ほ場の場合）】
┌────────┬──────────┬──────────┐
│ 期間   │ 1ほ場    │ 2ほ場    │
├────────┼──────────┼──────────┤
│ Q1     │ ┌──────┐ │ （空白）  │ ← 1ほ場: rowspan=2（最も長いrowspan=トマトの2）
│        │ │ほうれ│ │          │    Q1で開始するすべての栽培情報を含む
│        │ │ん草  │ │          │
│        │ │トマト│ │          │
├────────┼─┤      │─┼──────────┤
│ Q2     │ │      │ │ （空白）  │ ← 1ほ場のトマトが継続表示
│        │ └──────┘ │          │    2ほ場は継続中ではないので空白
└────────┴──────────┴──────────┘
```

## 推測される原因

1. **データマッピングの問題:**
   - `@cultivations_by_field[field_id]`で各ほ場の栽培情報を取得する際、トマトが1ほ場ではなく2ほ場のデータとして分類されている可能性

2. **rowspanの計算問題:**
   - 同じ期間に開始する複数の栽培情報がある場合、最初の栽培情報（ほうれん草）のrowspan=1が使われる
   - しかし、トマトはrowspan=2が必要なため、Q2で正しく継続表示されない

3. **セル描画のロジック問題:**
   - `display_cultivations.each`で複数の栽培情報を表示するが、rowspanが最初の栽培情報の値しか使われない
   - そのため、トマトがQ2で表示されない（または別のセルが必要になる）

## 現在の実装では表現できないパターン

現在の実装（`schedule.html.erb`）では、**同じ行（期間）に開始する複数の栽培情報は1つのセルにまとめて表示**し、**最初の栽培情報のrowspan**を使用しています。

そのため、以下のような表現は**実現できません**：

### パターン1: 同じほ場で、同じ期間に開始するが、異なるrowspanを持つ栽培情報を別々のセルで表現

```
【表現したい姿（しかし現在の実装では不可）】
┌────────┬──────────┐
│ 期間   │ 1ほ場    │
├────────┼──────────┤
│ Q1     │ ┌──────┐ │ ← ほうれん草: rowspan=1（独立したセル）
│        │ │ほうれ│ │
│        │ │ん草  │ │
│        │ └──────┘ │
│        │ ┌──────┐ │ ← トマト: rowspan=2（独立したセル）
│        │ │トマト│ │   しかし、同じ行に2つのセルがあるため、
├────────┼─┤      │ │   これはHTMLテーブルの構造上不可能
│ Q2     │ │      │ │
│        │ └──────┘ │
└────────┴──────────┘
```

**理由:**
- HTMLテーブルでは、同じ行（`<tr>`）内で、同じほ場（列）に対して複数のセル（`<td>`）を持つことはできません
- 1つの`<tr>`内では、各列（ほ場）につき1つの`<td>`しか持てません
- そのため、同じ行に開始する複数の栽培情報は、必ず1つのセル内にまとめる必要があります

### パターン2: ガントチャート風の表現（横方向に並べる）

```
【表現したい姿（ガントチャート風、しかし計画表ではない）】
┌────────┬──────────────────────────────────┐
│ 期間   │ 1ほ場                            │
├────────┼──────────────────────────────────┤
│ Q1     │ ほうれん草[━━━] トマト[━━━━━━━━]│ ← 横方向に並べる
│        │                                  │
├────────┼──────────────────────────────────┤
│ Q2     │            トマト[━━━━━━━━]     │ ← 継続表示
└────────┴──────────────────────────────────┘
```

**理由:**
- 計画表はガントチャートではないため、横方向に時間軸を表現する形式ではありません
- 計画表は、期間を行、ほ場を列とするテーブル形式です
- 各セル内に栽培情報を縦方向に並べて表示します

## 現在の実装で実現できる表現

現在の実装では、以下のような表現が可能です：

### パターン1: 同じ期間に開始する複数の栽培情報を1つのセルにまとめる（最も長いrowspanを使用）

```
【実現可能な表現（あるべき姿）】
┌────────┬──────────────────────────┐
│ 期間   │ 1ほ場                    │
├────────┼──────────────────────────┤
│ Q1     │ ┌──────────────┐         │ ← セル1: rowspan=2（最も長いrowspan=トマトの2）
│        │ │ ほうれん草   │         │    Q1で開始するすべての栽培情報を含む
│        │ │ トマト       │         │    同じセル内に縦方向に並べて表示
├────────┼─┤              │         │ ← トマトが継続表示
│ Q2     │ │              │         │    （ほうれん草はQ1で終了しているが、セル全体はrowspan=2）
│        │ └──────────────┘         │
└────────┴──────────────────────────┘
```

**実装方法:**
- 同じ期間に開始する複数の栽培情報がある場合、**最も長いrowspan**を使用
- そのセル内に、すべての栽培情報を縦方向に並べて表示
- rowspanが長いため、Q2でもセルが継続表示される

**注意点:**
- ほうれん草はQ1で終了しているが、セル全体はrowspan=2なので、Q2でもセルは表示される
- ただし、ほうれん草の表示はQ1のみで、Q2では空白（またはトマトのみ）になる

### パターン2: 1つの栽培情報のみのセル

```
【実現可能な表現】
┌────────┬──────────┐
│ 期間   │ 1ほ場    │
├────────┼──────────┤
│ Q1     │ ┌──────┐ │ ← ほうれん草のみ: rowspan=1
│        │ │ほうれ│ │
│        │ │ん草  │ │
│        │ └──────┘ │
├────────┼──────────┤
│ Q2     │ ┌──────┐ │ ← 別の栽培情報: rowspan=1
│        │ │キャベツ│ │
│        │ └──────┘ │
└────────┴──────────┘
```

**実装方法:**
- 各期間に開始する栽培情報ごとに、独立したセルを作成
- 各セルのrowspanは、その栽培情報の期間に応じて設定

## 確認すべきポイント

1. `@cultivations_by_field`のデータ構造を確認
2. `get_cultivations_for_field`が正しくほ場名でフィルタリングしているか確認
3. 同じ期間に開始する複数の栽培情報がある場合、**最も長いrowspanを使用**する必要があるか確認
4. 同じセル内に複数の栽培情報を表示する際、rowspanが最も長いものに合わせる必要がある
