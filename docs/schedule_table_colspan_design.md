# 計画表のcolspanベース実装設計

## 要件

1. **基本的にcolspan=2で1列を表現する**
   - 各ほ場の列は、内部的に2つのセル（colspan=1）に分割される
   - デフォルトでは、colspan=2で1つのセルとして描画

2. **QnとQn-1にまたがる作付とQnのみの作付があるQnはcolspan=1を2つ描画**
   - Qnで開始する期間内のみの作付（colspan=1）と、Qn-1から継続する作付（colspan=2）が同時に存在する場合
   - この場合は、colspan=1を2つ描画して、それぞれに異なる作付を表示

3. **そうでない限りはcolspan=2で作付を描画**
   - 期間またぎの作付は常にcolspan=2
   - 期間内のみの作付も、特に問題がない場合はcolspan=2

4. **期間またぎは載せる際はcolspan=1, 2のうち2に統一するように決め打ち**
   - 期間またぎの作付は常にcolspan=2を使用

## テーブル構造

### ヘッダー

```
┌────────┬──────────────────────────────────────┐
│ 期間   │ 1ほ場（colspan=2）                  │
│        │ ┌─────────┬─────────┐              │
│        │ │ セル1   │ セル2   │              │
│        │ │(col=1)  │(col=1)  │              │
│        │ └─────────┴─────────┘              │
└────────┴──────────────────────────────────────┘
```

### ボディ（基本パターン）

#### パターン1: 期間またぎの作付のみ（colspan=2）

```
┌────────┬──────────────────────────────────────┐
│ Q1     │ ┌─────────────────────────────────┐ │
│        │ │ トマト（Q1→Q2、colspan=2）      │ │
│        │ └─────────────────────────────────┘ │
├────────┼─┤                                  │ │
│ Q2     │ │                                  │ │
│        │ └──────────────────────────────────┘ │
└────────┴──────────────────────────────────────┘
```

#### パターン2: 期間内のみの作付（colspan=2）

```
┌────────┬──────────────────────────────────────┐
│ Q1     │ ┌─────────────────────────────────┐ │
│        │ │ ほうれん草（Q1のみ、colspan=2） │ │
│        │ └─────────────────────────────────┘ │
├────────┼──────────────────────────────────────┤
│ Q2     │ （空白）                              │
└────────┴──────────────────────────────────────┘
```

#### パターン3: 期間またぎと期間内のみが同時（colspan=1を2つ）

```
┌────────┬──────────────────────────────────────┐
│ Q1     │ ┌─────────┐ ┌───────────────────┐ │
│        │ │ほうれん草│ │ トマト（Q1→Q2）   │ │
│        │ │(Q1のみ) │ │ (colspan=2)       │ │
│        │ │colspan=1│ │                   │ │
│        │ └─────────┘ │                   │ │
├────────┼─────────────┼───────────────────┤ │
│ Q2     │ （空白）     │                   │ │
│        │             │                   │ │
│        │             └───────────────────┘ │
└────────┴──────────────────────────────────────┘
```

## 実装方針

### 1. ヘッダーの変更

各ほ場のヘッダーを2列に分割（内部的には見えないが、colspan=2のセルを描画）

### 2. データ準備ロジック

各ほ場について、各期間で：
- その期間に開始する栽培情報を取得
- その期間に継続する栽培情報を取得
- colspanを決定：
  - 期間またぎの作付がある場合: 常にcolspan=2
  - 期間内のみの作付と期間またぎの作付が同時にある場合: colspan=1を2つ
  - 期間内のみの作付のみの場合: colspan=2（またはcolspan=1も可能だが、colspan=2を推奨）

### 3. セル描画ロジック

```ruby
# 疑似コード
for each period:
  for each field:
    starting_spanning = 期間またぎの作付（開始するもの）
    starting_contained = 期間内のみの作付（開始するもの）
    continuing_spanning = 期間またぎの作付（継続するもの）
    
    if starting_spanning.any? && starting_contained.any?
      # colspan=1を2つ描画
      <td colspan="1">期間内のみの作付</td>
      <td colspan="1" rowspan="N">期間またぎの作付</td>
    elsif starting_spanning.any?
      # colspan=2で描画
      <td colspan="2" rowspan="N">期間またぎの作付</td>
    elsif starting_contained.any?
      # colspan=2で描画（またはcolspan=1でも可）
      <td colspan="2">期間内のみの作付</td>
    elsif continuing_spanning.any?
      # セルをスキップ（前のrowspanで表示）
      # 何も描画しない
    else
      # 空白セル（colspan=2）
      <td colspan="2">空白</td>
    end
  end
end
```

## 実装上の注意点

1. **ヘッダーの列数とボディの列数の整合性**
   - ヘッダーは各ほ場1列（colspan=2として扱う）
   - ボディは各ほ場2列（colspan=1を2つ、またはcolspan=2を1つ）
   - テーブル構造上、ヘッダーとボディの列数は一致させる必要があるため、ヘッダーも内部的に2列に分割する必要がある

2. **rowspanとの組み合わせ**
   - 期間またぎの作付は、colspan=2とrowspanの両方を使用
   - rowspanは、その作付がまたぐ期間数に応じて設定

3. **空白セルの処理**
   - 空白セルもcolspan=2で描画して、テーブル構造を保つ

4. **期間またぎの作付のcolspan統一**
   - 期間またぎの作付は常にcolspan=2に統一（要件4）

