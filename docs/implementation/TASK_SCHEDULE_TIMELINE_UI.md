# 作業予定タイムライン UI 設計メモ

## 目的

AGRR が自動生成した `TaskSchedule` / `TaskScheduleItem` を叩き台として提示し、ユーザーが **予定の修正** と **実績入力** を迅速に行えるタイムライン画面を提供する。

## 想定ユーザーとユースケース

- **圃場管理担当者**  
  - 今週・来週に予定されている作業を俯瞰し、作業順序や人員配置を調整したい。  
  - 不適切なタイミングのタスクをドラッグ & ドロップで微調整したい（将来対応）。
- **実績入力担当者**  
  - 当日の予定を確認しながら、完了済みタスクの実績をその場で登録したい。  
  - 遅延タスクをカレンダー上で一目で把握し、対応を検討したい。

## 画面コンセプト（タイムラインビュー）

### レイアウト概要

1. **ヘッダー**
   - 計画名 / 期間 / 圃場数 / 作業予定生成日時 (`TaskSchedule.generated_at`)
   - 週ナビゲーション（前週 / 今週 / 次週）
   - 週レンジ表示（例: 2025-03-10 〜 2025-03-16）
2. **ミニマップ（計画全体）**
   - 計画全期間をバーで表示し、現在表示中の週レンジをハイライト。
   - 播種日・収穫日・主要ステージなどの節目マーカーを表示。
3. **週タイムライン（本体）**
   - 行: `field_cultivation`（圃場×作付け単位）。圃場名 + 作物名 + 面積をヘッダーに表示。
   - 列: 日付（1 日刻み）。曜日ラベル、祝日表示、現在日付ラインを描画。
   - ステージ帯: 背景色で生育ステージを示し、タスク位置との相関がわかるようにする。
   - タスクバッジ: `TaskScheduleItem` を日付位置に配置。カテゴリ別の色/アイコン付与。
     - `一般作業`: 緑系
     - `基肥`: 茶色系
     - `追肥`: 青系
     - 予定未確定（`scheduled_date` なし）はタイムライン下部の「未確定リスト」に表示。
4. **詳細サイドパネル / モーダル**
   - バッジクリックで開く。内容:
     - タスク名、カテゴリ、ステージ名/順序
     - 予定日（変更可能になる余地）
     - 累積 GDD 情報（例: 650/900（72%））
     - 施肥量 / 単位（施肥タスクのみ）
     - 天候依存条件 (`weather_dependency`) や作業時間 (`time_per_sqm`)
     - メモ欄（将来の自由記述）
     - ボタン: 「予定を編集」「実績を入力」（段階的に追加）

### 情報の視覚化補助

- **現在日縦ライン**: 今日の日付位置を明示。
- **ステージ帯**: `stage_name` ごとに背景色帯で期間を示し、タスク位置が直感的にわかるようにする。
- **割合バッジ**: タスクカードに「計画期間の 45% 時点」などの情報を表示し、全体の中の位置づけを判断しやすくする。
- **GDD バー**: 詳細パネルで「累積 GDD / 必要 GDD」をバー表示。

## データ取得/API 仕様（案）

### エンドポイント

```
GET /plans/:id/task_schedules/timeline
```

### パラメーター

| パラメーター | 型 | デフォルト | 説明 |
|--------------|----|------------|------|
| `week_start` | ISO8601 日付 | 今週の月曜日 | 表示開始日 |
| `field_cultivation_id` | 整数 | 任意 | 圃場フィルタ |
| `category` | `general` / `fertilizer` / `all` | `all` | カテゴリフィルタ |

### レスポンス例

```json
{
  "plan": {
    "id": 123,
    "name": "2025 春夏計画",
    "planning_start_date": "2025-02-01",
    "planning_end_date": "2025-12-31",
    "timeline_generated_at": "2025-03-08T12:34:56+09:00"
  },
  "week": {
    "start_date": "2025-03-10",
    "end_date": "2025-03-16",
    "days": [
      {"date": "2025-03-10", "weekday": "mon", "is_today": false},
      ...
    ]
  },
  "milestones": [
    {"date": "2025-03-05", "label": "播種", "type": "sowing"},
    {"date": "2025-05-01", "label": "開花開始", "type": "stage_start"}
  ],
  "fields": [
    {
      "id": 45,
      "name": "第1圃場 A 区画",
      "crop_name": "トマト (桃太郎)",
      "area_sqm": 1200,
      "schedules": {
        "general": [
          {
            "item_id": 901,
            "name": "支柱設置",
            "scheduled_date": "2025-03-12",
            "task_type": "field_work",
            "stage_name": "定植直後",
            "stage_order": 2,
            "gdd_trigger": "150.0",
            "gdd_progress_ratio": 0.42,
            "priority": 2,
            "source": "agrr_schedule",
            "weather_dependency": "no_rain_24h",
            "status": "planned"
          },
          ...
        ],
        "fertilizer": [
          {
            "item_id": 945,
            "name": "基肥施用",
            "scheduled_date": "2025-03-11",
            "task_type": "basal_fertilization",
            "stage_name": "定植前",
            "stage_order": 1,
            "gdd_trigger": "120.0",
            "gdd_progress_ratio": 0.35,
            "amount": "45.0",
            "amount_unit": "g/m2",
            "priority": 1,
            "source": "agrr_fertilize_plan",
            "status": "planned"
          }
        ],
        "unscheduled": [
          {
            "item_id": 980,
            "name": "追肥（第2回）",
            "task_type": "topdress_fertilization",
            "stage_name": "開花期",
            "gdd_trigger": "450.0",
            "status": "pending"
          }
        ]
      }
    }
  ]
}
```

### 状態管理

- `status`: `planned` / `rescheduled` / `completed` / `delayed` などを付与。  
  - `rescheduled` は手動調整済みタスク。
  - `completed` は実績入力済みタスク。
- 将来の実績入力 API で状態更新・実績値保存を行えるよう拡張前提で設計。

## インタラクションロードマップ

| フェーズ | 内容 |
|----------|------|
| v0 (MVP) | 週タイムライン表示、フィルタ、詳細モーダル。予定がない場合のメッセージ表示。 |
| v1       | バッジドラッグで日付変更（`TaskScheduleItem.scheduled_date` 更新）。手動調整フラグの表示。 |
| v2       | 実績入力導線（詳細モーダルから実績フォームへ遷移・登録）。完了表示の更新。 |
| v3       | タスクの追加/複製、同期更新（agrr 再生成との競合解消 UI）。 |

## 技術方針

- 既存フロント基盤（ESBuild + Stimulus）に準拠した構成。
- タイムライン UI は軽量な独自実装を基本とし、必要に応じて外部ライブラリ（例: `vis-timeline`）を検討。  
  - MVP は CSS グリッド＋少量のキャンバス/ SVG で構築可能。
- データ取得は JSON API 経由。Rails 側で `TaskSchedule` を週ごとに整形する Presenter/Decorator を用意。
- JS テストは Jest + jsdom でコンポーネント単位の DOM 操作用テストを追加。

## テスト戦略（詳細）

### Rails 側

- **Presenter / Query テスト**  
  - `timeline` API のレスポンス整形が期待どおりか。  
  - 週レンジフィルタ、圃場フィルタ、カテゴリフィルタの挙動。
  - 未確定タスクの分類、手動調整 `status` の付与。
- **Controller テスト**  
  - 認可、JSON スキーマ検証、空データ時のレスポンス。

### System テスト（MVP 時点）

- 生成済み計画でタイムラインが表示されること。
- 週送り/戻しボタンで日付レンジが更新されること。
- タスクをクリックした際に詳細モーダルが内容を表示すること。
- 予定未生成の計画では「予定がありません」表示とすること。

### JavaScript 単体テスト

- タイムライン描画ユーティリティ  
  - ステージ帯計算、今日ライン描画、タスク配置計算。
- 詳細モーダルコンポーネント  
  - データバインディング、閉じる/開く挙動。
- 週ナビゲーションコンポーネント  
  - 週切り替え時に API リクエストが発火し、描画更新が走る。

### 将来フェーズ

- ドラッグ & ドロップ時の境界チェック、休日制約、ロック済みタスクの扱い。
- 実績入力後のステータス更新と UI 反映。
- API/JS モックを用いた統合的な操作テスト。

## 実装ステップ提案

1. **データ取得基盤**
   - `TaskScheduleTimelinePresenter`（仮）を実装し、週単位の JSON を返す API を作成。
   - 未確定タスク、ステージ帯、マイルストーンなどを Presenter で組み立てる。
2. **フロント MVP**
   - Stimulus コントローラで週ナビゲーションとタイムライン描画を実装。
   - CSS グリッド + SVG でタスクバッジとステージ帯を描画。
   - 詳細モーダルを用意し、タスク情報を表示。
3. **テスト整備**
   - Presenter・Controller テスト + System テスト（最低限のシナリオ）。
   - Jest でビュー補助ロジックの単体テストを追加（ドラッグ導入前でも可）。
4. **UX 強化**
   - ミニマップ、割合表示、GDD バーなどを段階的に導入。
5. **予定修正・実績入力機能**
   - ドラッグ & ドロップ → `TaskScheduleItem` 更新 API。  
   - 実績登録フォーム連携とステータス表示の更新。

---

この設計によって「自動生成された予定をベースに簡単に修正・実績入力へ繋げる」体験を実現する。段階的に拡張しつつ、初期段階では週単位の俯瞰性と情報の信頼性を優先する。ユーザーからのフィードバックに応じて、編集・入力機能を堅牢に拡張する計画とする。


