# 害虫・作物関連付け機能 テスト設計書

## 📋 概要

このドキュメントは、害虫と作物の関連付け機能に関するテスト設計をまとめたものです。
以下の2つの機能領域について、操作パターンと境界条件を整理しています。

1. **作物単位の害虫管理** (`Crops::PestsController`)
2. **害虫管理画面での作物選択機能** (`PestsController`拡張)

## 🎯 テスト対象機能

### 1. 作物単位の害虫管理 (`/crops/:crop_id/pests`)

#### 操作パターン
- **一覧表示**: 作物に関連付けられている害虫の一覧を表示
- **詳細表示**: 作物に紐づく害虫の詳細を表示
- **新規作成**: 
  - 既存の害虫を選択して関連付け
  - 新しい害虫を作成して関連付け
- **編集**: 害虫の情報を編集（作物との関連付けは変更しない）
- **更新**: 害虫の情報を更新

#### 境界条件
- 作物へのアクセス権限（参照作物/ユーザー作物/管理者）
- 害虫へのアクセス権限
- 既存害虫の重複関連付け防止
- 存在しない害虫IDでの関連付け試行
- 権限外の害虫へのアクセス試行

### 2. 害虫管理画面での作物選択 (`/pests`)

#### 操作パターン
- **新規作成時**: 複数の作物を選択して害虫と関連付け
- **編集時**: 関連付けられた作物を追加・削除
- **詳細表示**: 関連付けられた作物一覧を表示
- **更新時**: 作物の選択状態を更新（追加・削除の差分処理）

#### 境界条件
- 空の作物選択（選択なし）
- 複数の作物選択（最大数制限なし）
- 権限外の作物選択試行
- 参照作物とユーザー作物の混在選択
- 既に関連付けられている作物の重複追加防止
- 存在しない作物IDでの選択試行

## 📝 テストケース設計

### A. `Crops::PestsController` テスト

#### A-1. 一覧表示 (`index`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| A-1-1 | 自分の作物に3つの害虫が関連付けられている | `GET /crops/:crop_id/pests` | 3つの害虫が表示される |
| A-1-2 | 参照作物に1つの害虫が関連付けられている | `GET /crops/:crop_id/pests` (一般ユーザー) | 1つの害虫が表示される |
| A-1-3 | 自分の作物に害虫が関連付けられていない | `GET /crops/:crop_id/pests` | 空の状態メッセージが表示される |
| A-1-4 | 他人の作物にアクセス試行 | `GET /crops/:crop_id/pests` (他人の作物ID) | リダイレクト、権限エラー |
| A-1-5 | 存在しない作物IDにアクセス試行 | `GET /crops/99999/pests` | リダイレクト、not_foundエラー |

#### A-2. 詳細表示 (`show`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| A-2-1 | 作物に関連付けられている害虫の詳細を表示 | `GET /crops/:crop_id/pests/:id` | 害虫詳細が表示される |
| A-2-2 | 作物に関連付けられていない害虫IDを指定 | `GET /crops/:crop_id/pests/:id` (別の作物の害虫) | リダイレクト、not_foundエラー |
| A-2-3 | 存在しない害虫IDを指定 | `GET /crops/:crop_id/pests/99999` | リダイレクト、not_foundエラー |

#### A-3. 新規作成画面 (`new`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| A-3-1 | 新規作成画面を表示 | `GET /crops/:crop_id/pests/new` | フォームと関連付け可能な害虫リストが表示される |
| A-3-2 | 既にすべての害虫が関連付けられている | `GET /crops/:crop_id/pests/new` | 関連付け可能な害虫が空であることを表示 |

#### A-4. 既存害虫の関連付け (`create` - pest_id指定)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| A-4-1 | 既存の害虫を選択して関連付け | `POST /crops/:crop_id/pests` (pest_id指定) | 関連付け成功、リダイレクト |
| A-4-2 | 既に関連付けられている害虫を再度選択 | `POST /crops/:crop_id/pests` (既存のpest_id) | エラーメッセージ、リダイレクト |
| A-4-3 | 存在しない害虫IDを指定 | `POST /crops/:crop_id/pests` (pest_id: 99999) | エラーハンドリング |
| A-4-4 | 他人の害虫を関連付け試行（参照害虫以外） | `POST /crops/:crop_id/pests` (他人のpest_id) | 権限チェックが必要（現実装では可能） |

#### A-5. 新規害虫の作成と関連付け (`create` - 新規作成)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| A-5-1 | 新しい害虫を作成して関連付け | `POST /crops/:crop_id/pests` (新規害虫データ) | 害虫作成と関連付け成功 |
| A-5-2 | 無効な害虫データで作成試行 | `POST /crops/:crop_id/pests` (name空) | バリデーションエラー、フォーム再表示 |
| A-5-3 | 一般ユーザーが参照害虫作成試行 | `POST /crops/:crop_id/pests` (is_reference: true) | リダイレクト、権限エラー |
| A-5-4 | 管理者が参照害虫作成 | `POST /crops/:crop_id/pests` (is_reference: true, 管理者) | 作成成功 |

#### A-6. 編集 (`edit`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| A-6-1 | 関連付けられている害虫を編集 | `GET /crops/:crop_id/pests/:id/edit` | 編集フォームが表示される |
| A-6-2 | 関連付けられていない害虫を編集試行 | `GET /crops/:crop_id/pests/:id/edit` (別の害虫) | リダイレクト、not_foundエラー |

#### A-7. 更新 (`update`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| A-7-1 | 害虫情報を更新 | `PATCH /crops/:crop_id/pests/:id` | 更新成功、リダイレクト |
| A-7-2 | 無効なデータで更新試行 | `PATCH /crops/:crop_id/pests/:id` (name空) | バリデーションエラー、フォーム再表示 |
| A-7-3 | 一般ユーザーがis_reference変更試行 | `PATCH /crops/:crop_id/pests/:id` (is_reference変更) | リダイレクト、権限エラー |

### B. `PestsController` 拡張テスト（作物選択機能）

#### B-1. 新規作成時の作物選択 (`new`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| B-1-1 | 新規作成画面を表示 | `GET /pests/new` | フォームと利用可能な作物リストが表示される |
| B-1-2 | 自分の作物と参照作物が表示される | `GET /pests/new` (一般ユーザー) | 自分の作物 + 参照作物が表示 |
| B-1-3 | 管理者の場合、すべての作物が表示される | `GET /pests/new` (管理者) | 自分の作物 + 参照作物が表示 |
| B-1-4 | 作物が1つも存在しない | `GET /pests/new` | 作物選択セクションにメッセージ表示 |

#### B-2. 作成時の作物関連付け (`create`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| B-2-1 | 1つの作物を選択して害虫作成 | `POST /pests` (crop_ids: [1]) | 害虫作成と関連付け成功 |
| B-2-2 | 複数の作物を選択して害虫作成 | `POST /pests` (crop_ids: [1, 2, 3]) | 害虫作成と複数作物関連付け成功 |
| B-2-3 | 作物を選択せずに害虫作成 | `POST /pests` (crop_ids: []) | 害虫作成成功、関連付けなし |
| B-2-4 | 存在しない作物IDを指定 | `POST /pests` (crop_ids: [99999]) | 無視されるかエラーハンドリング |
| B-2-5 | 他人の作物IDを指定（一般ユーザー） | `POST /pests` (crop_ids: [他人の作物ID]) | 無視される（権限チェック） |
| B-2-6 | 参照作物と自分の作物を混在選択 | `POST /pests` (crop_ids: [参照作物, 自分の作物]) | 両方関連付け成功 |
| B-2-7 | 既に関連付けられている作物を選択 | `POST /pests` (crop_ids: [既に他の害虫に関連付けられた作物]) | 複数の害虫に同じ作物を関連付け可能 |

#### B-3. 編集画面での作物選択表示 (`edit`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| B-3-1 | 編集画面を表示 | `GET /pests/:id/edit` | フォームと利用可能な作物リスト、現在の関連付け状態が表示 |
| B-3-2 | 2つの作物に関連付けられている害虫を編集 | `GET /pests/:id/edit` | 2つの作物がチェック状態で表示 |

#### B-4. 更新時の作物関連付け変更 (`update`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| B-4-1 | 1つの作物を追加 | `PATCH /pests/:id` (既存: [1], 選択: [1, 2]) | 作物2が追加される |
| B-4-2 | 1つの作物を削除 | `PATCH /pests/:id` (既存: [1, 2], 選択: [1]) | 作物2の関連付けが削除される |
| B-4-3 | 複数の作物を追加・削除同時 | `PATCH /pests/:id` (既存: [1, 2], 選択: [2, 3]) | 作物1削除、作物3追加 |
| B-4-4 | すべての作物の関連付けを削除 | `PATCH /pests/:id` (既存: [1, 2], 選択: []) | すべての関連付けが削除される |
| B-4-5 | 既存と同じ選択状態で更新 | `PATCH /pests/:id` (既存: [1, 2], 選択: [1, 2]) | 変更なし、更新成功 |
| B-4-6 | 存在しない作物IDを含む選択 | `PATCH /pests/:id` (crop_ids: [1, 99999]) | 存在する作物のみ処理 |
| B-4-7 | 他人の作物IDを含む選択（一般ユーザー） | `PATCH /pests/:id` (crop_ids: [自分の作物, 他人の作物]) | 自分の作物のみ処理 |

#### B-5. 詳細表示での作物一覧 (`show`)

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| B-5-1 | 3つの作物に関連付けられている害虫を表示 | `GET /pests/:id` | 3つの作物が一覧表示される |
| B-5-2 | 作物に関連付けられていない害虫を表示 | `GET /pests/:id` | 「まだ関連付けられている作物がありません」メッセージ |
| B-5-3 | 作物名から作物詳細へのリンク | `GET /pests/:id` | 各作物名がリンクになっている |

### C. 権限チェックテスト

#### C-1. 作物へのアクセス権限

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| C-1-1 | 一般ユーザーが自分の作物の害虫一覧にアクセス | `GET /crops/:crop_id/pests` | 成功 |
| C-1-2 | 一般ユーザーが他人の作物の害虫一覧にアクセス | `GET /crops/:crop_id/pests` (他人の作物) | リダイレクト、権限エラー |
| C-1-3 | 一般ユーザーが参照作物の害虫一覧にアクセス | `GET /crops/:crop_id/pests` (参照作物) | 成功 |
| C-1-4 | 管理者が任意の作物の害虫一覧にアクセス | `GET /crops/:crop_id/pests` (管理者) | 成功 |

#### C-2. 害虫へのアクセス権限

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| C-2-1 | 一般ユーザーが自分の害虫に作物を関連付け | `POST /pests` (自分の害虫) | 成功 |
| C-2-2 | 一般ユーザーが参照害虫に作物を関連付け | `POST /pests` (参照害虫) | 成功（参照害虫は誰でも関連付け可能） |
| C-2-3 | 一般ユーザーが他人の害虫を編集試行 | `PATCH /pests/:id` (他人の害虫) | リダイレクト、権限エラー |

### D. エッジケース・境界条件テスト

#### D-1. データ整合性

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| D-1-1 | 大量の作物選択（100件） | `POST /pests` (crop_ids: [1..100]) | すべて関連付け成功 |
| D-1-2 | 空文字列を含む作物ID | `POST /pests` (crop_ids: ["", "1", ""]) | 空文字列は無視、有効なIDのみ処理 |
| D-1-3 | 重複した作物ID | `POST /pests` (crop_ids: [1, 1, 2]) | 重複は無視、ユニークな関連付けのみ |
| D-1-4 | 文字列形式の作物ID | `POST /pests` (crop_ids: ["1", "2"]) | 整数に変換されて処理される |
| D-1-5 | 数値以外の文字列 | `POST /pests` (crop_ids: ["abc", "1"]) | 数値以外は無視 |

#### D-2. トランザクション処理

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| D-2-1 | 害虫作成成功、関連付け失敗 | `POST /pests` (害虫作成成功、作物ID無効) | 害虫は作成される、関連付けはスキップ |
| D-2-2 | 複数作物の関連付けで一部失敗 | `POST /pests` (crop_ids: [1, 99999, 2]) | 有効な作物のみ関連付け |

#### D-3. 並行処理

| テストケース | 前提条件 | 操作 | 期待結果 |
|------------|---------|------|---------|
| D-3-1 | 同時に同じ害虫に異なる作物を関連付け | 並行リクエスト | 両方の関連付けが成功（重複チェックあり） |

## 🧪 テスト実装優先度

### 高優先度（必須）
- A-1-1, A-1-3, A-1-4: 基本的な一覧表示と権限チェック
- A-4-1, A-4-2: 既存害虫の関連付け（正常系・異常系）
- A-5-1: 新規害虫の作成と関連付け
- B-2-1, B-2-2, B-2-3: 作成時の作物選択（単数・複数・なし）
- B-4-1, B-4-2, B-4-3: 更新時の作物関連付け変更（追加・削除・同時）
- B-5-1, B-5-2: 詳細表示での作物一覧
- C-1-2, C-1-3: 作物へのアクセス権限チェック
- D-1-2, D-1-3, D-1-4: 入力データの正規化

### 中優先度（推奨）
- A-2-1, A-2-2: 詳細表示とエラーハンドリング
- A-6-1, A-7-1: 編集・更新の基本動作
- B-1-1, B-1-2: 新規作成画面の表示
- B-3-1, B-3-2: 編集画面での状態表示
- B-2-5, B-4-7: 権限外の作物選択試行
- C-2-1, C-2-2: 害虫へのアクセス権限

### 低優先度（オプション）
- A-1-5, A-2-3: 存在しないリソースへのアクセス
- B-2-4, B-4-6: 存在しない作物IDの処理
- D-1-1: 大量データの処理
- D-2-1, D-2-2: トランザクション処理
- D-3-1: 並行処理

## 📂 テストファイル構成

### 新規作成が必要なテストファイル

```
test/
├── controllers/
│   ├── crops/
│   │   └── pests_controller_test.rb  # 新規作成
│   └── pests_controller_test.rb       # 既存を拡張（作物選択機能）
├── integration/
│   └── pest_crop_association_test.rb  # 新規作成（統合テスト）
└── models/
    └── crop_pest_test.rb              # 既存（必要に応じて拡張）
```

### テストファイルの構造例

```ruby
# test/controllers/crops/pests_controller_test.rb
class Crops::PestsControllerTest < ActionDispatch::IntegrationTest
  setup do
    @user = create(:user)
    @crop = create(:crop, user: @user)
    sign_in_as @user
  end

  # 一覧表示テスト
  # 詳細表示テスト
  # 新規作成テスト（既存害虫の関連付け）
  # 新規作成テスト（新規害虫の作成）
  # 編集テスト
  # 更新テスト
  # 権限チェックテスト
end

# test/controllers/pests_controller_test.rb（拡張）
class PestsControllerTest < ActionDispatch::IntegrationTest
  # 既存のテストは維持
  
  # 新規追加: 作物選択機能のテスト
  test "should create pest with crop association" do
    # ...
  end
  
  test "should update pest crop associations" do
    # ...
  end
  
  # ...
end

# test/integration/pest_crop_association_test.rb
class PestCropAssociationTest < ActionDispatch::IntegrationTest
  # エンドツーエンドの統合テスト
  # 複数の操作を連続して実行するシナリオテスト
end
```

## 🔍 テストデータ準備

### Factory 拡張

既存のFactoryを利用しつつ、関連付けを簡単に作成できるヘルパーを追加：

```ruby
# test/support/factories_helper.rb（新規作成推奨）
module FactoriesHelper
  def create_crop_with_pests(crop:, pests:)
    pests.each do |pest|
      create(:crop_pest, crop: crop, pest: pest)
    end
    crop.reload
  end

  def create_pest_with_crops(pest:, crops:)
    crops.each do |crop|
      create(:crop_pest, crop: crop, pest: pest)
    end
    pest.reload
  end
end
```

## ✅ テスト実装チェックリスト

### Crops::PestsController
- [ ] 一覧表示（正常系・異常系）
- [ ] 詳細表示（正常系・異常系）
- [ ] 新規作成（既存害虫の関連付け）
- [ ] 新規作成（新規害虫の作成）
- [ ] 編集
- [ ] 更新
- [ ] 権限チェック（作物へのアクセス）
- [ ] 権限チェック（害虫へのアクセス）
- [ ] エラーハンドリング（RecordNotFound）
- [ ] エラーハンドリング（重複関連付け）

### PestsController 拡張
- [ ] 新規作成時の作物選択表示
- [ ] 作成時の作物関連付け（単数・複数・なし）
- [ ] 編集時の作物選択状態表示
- [ ] 更新時の作物関連付け変更（追加・削除・同時）
- [ ] 詳細表示での作物一覧
- [ ] 権限外の作物選択試行
- [ ] 入力データの正規化（空文字列・重複・型変換）

### 統合テスト
- [ ] 作物→害虫→作物の往復操作
- [ ] 複数の害虫と作物の相互関連付け
- [ ] 権限チェックの統合テスト

## 📊 カバレッジ目標

- **コントローラー**: 100%（すべてのアクション・パス）
- **モデル**: 100%（バリデーション・スコープ）
- **ヘルパーメソッド**: 80%以上（privateメソッドを含む）
- **エラーハンドリング**: 100%（すべてのエラーケース）

## 🚨 注意事項

1. **パッチの禁止**: ARCHITECTURE.mdに従い、依存性注入を使用
2. **テストの独立性**: 各テストは他のテストに依存しない
3. **データクリーンアップ**: `setup`/`teardown`で適切にクリーンアップ
4. **実際のデータベース操作**: モックではなく実際のDB操作でテスト

