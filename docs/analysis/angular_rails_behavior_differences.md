# Angular実装とRailsフロント実装の振る舞い・機能の相違点分析

Railsのサーバーサイドレンダリング（ERB）による実装を正（Gold Standard）とし、現在のAngularフロントエンド実装との差異をリスト化します。

## 1. Public Plan（公開プラン）作成ウィザード

| 項目 | Rails実装 (Gold Standard) | Angular実装 (現状) | 乖離・課題 |
| :--- | :--- | :--- | :--- |
| **全体デザイン** | 絵文字、カード型レイアウト、ステップ進捗バー、ブランドカラーを多用したリッチなUI。 | 最小限のテキストと標準的なHTML要素のみのプロトタイプ風UI。 | 視覚的なブランド体験が大きく損なわれている。 |
| **状態管理** | サーバーサイドセッション (`session[:public_plan]`) で各ステップの入力を確実に保持。 | URLクエリパラメータ (`farmId`, `farmSizeId`) に依存。ブラウザバックやリロードに弱い。 | 堅牢性が不足している。 |
| **バリデーション** | セッション不足時に自動で前のステップや最初のリジョン選択へリダイレクト。 | コンポーネント内のエラー表示のみ。不正な状態での操作を防ぐ制御が弱い。 | ユーザーが迷いやすい。 |
| **作物選択** | 作物名に加え品種名を表示。選択カウンター、ヒントメッセージ、固定ボトムバーを完備。 | シンプルなチェックボックスリスト。品種表示なし。カウンターやボトムバーなし。 | 大量の作物から選択する際のUXが劣る。 |
| **最適化中画面** | リアルタイム経過時間、フェーズ毎のメッセージ、スピナー、エラー時の再試行ボタンを表示。 | ステータス名と進捗率のみ。経過時間や詳細なエラーフィードバックなし。 | 処理中の「待ち」時間が長く感じられ、エラー時の回復手段がない。 |

## 2. 計画結果表示（Results）

| 項目 | Rails実装 (Gold Standard) | Angular実装 (現状) | 乖離・課題 |
| :--- | :--- | :--- | :--- |
| **ガントチャート** | SVGによるカスタム実装。**ドラッグ＆ドロップ**での期間調整・圃場変更に対応。 | Chart.js (`ng2-charts`) による横棒グラフ。閲覧専用（静的）。 | 最大の機能的乖離。計画の微調整がAngular側では不可能。 |
| **作物パレット** | 未使用の作物をドラッグしてガントに追加できるパレット機能。 | 実装なし。 | 新しい作付け案の試行ができない。 |
| **気象連動** | 作付けをクリックすると、その期間の**気温・GDD分析チャート**を動的に表示。 | 気象チャートコンポーネントはあるが、結果画面とは未統合。 | データに基づいた栽培判断ができない。 |
| **圃場管理** | 結果画面上で直接圃場の追加・削除・名称変更が可能。 | 実装なし。 | 圃場構成の変更ができない。 |
| **プラン保存** | 未ログイン時はセッションに一時保存し、ログイン後にアカウントへ移行する機能。 | 実装なし。 | 作成したプランを永続化する手段がない。 |
| **Undo機能** | 操作ミスを即座に元に戻す「削除の取り消し（Undo Delete）」システム。 | 実装なし。 | 操作の安全性が低い。 |

## 3. マスタ管理（Masters）

| 項目 | Rails実装 (Gold Standard) | Angular実装 (現状) | 乖離・課題 |
| :--- | :--- | :--- | :--- |
| **作物詳細** | 栽培ステージ、利用可能なタスクテンプレート、害虫連携など複雑な情報を網羅。 | 単純な作物名の一覧表示のみ。詳細画面自体が存在しない。 | 農業知識ベースとしての機能が欠落している。 |
| **農場詳細** | 地図表示に加え、ウェザーデータの取得進捗、圃場一覧（編集・削除付き）を表示。 | 地図と一覧はあるが、Rails側のリッチなレイアウトやUndo機能が未反映。 | 管理ツールとしての完成度が低い。 |
| **動的操作** | Turbo Streamによる画面遷移なしの部分更新。 | ページ全体の再読み込みまたは単純なコンポーネント切り替え。 | インタラクティブな操作感が異なる。 |

## 4. 共通機能・インフラ

| 項目 | Rails実装 (Gold Standard) | Angular実装 (現状) | 乖離・課題 |
| :--- | :--- | :--- | :--- |
| **多言語対応** | Rails i18n (`ja`, `us`, `in`) による完全な翻訳。 | コンポーネント内に**英語がハードコード**されている箇所が多数。キー体系も不一致。 | 多言語展開が不完全。 |
| **認証フロー** | ロール別（開発者/農家/研究者）のモックログインボタンを備えた開発用ログイン。 | Railsのログイン画面へ飛ばすのみ。Angular側でのモックログイン体験がない。 | 開発・テスト効率が低い。 |
| **ダイアログ/通知** | `DialogSystem.js` によるカスタムスタイルされたモダンな確認・入力画面。 | 標準の `confirm()` または実装なし。 | UIの一貫性と洗練度が欠けている。 |

## 5. 技術的課題と改善優先度

### 高優先度 (P0: 基幹機能の欠落)
1. **ガントチャートの双方向化**: ドラッグ＆ドロップによる編集機能の移植。
2. **プラン保存・ログイン連携**: 公開プランからログイン後の保存フローの構築。
3. **多言語対応の完全化**: ハードコードの除去とRails i18nキーとの同期。

### 中優先度 (P1: UX・視覚的整合性)
1. **ブランドデザインの適用**: 絵文字、カード、カラーシステム、固定バーの移植。
2. **気象チャートの統合**: 結果画面でのGDD/気温分析の表示。
3. **最適化進捗の高度化**: 経過時間、フェーズ詳細メッセージの表示。

### 低優先度 (P2: 管理・効率化)
1. **マスタ詳細画面の拡充**: ステージ管理やテンプレート連携。
2. **カスタムダイアログシステムの移植**: UIの一貫性。
3. **モックログインの改善**: Angular側での開発用ロール選択。

## 6. 改善に向けた技術方針案

### 1. ガントチャートの高度化 (P0)
- **現状**: Rails側の `custom_gantt_chart.js` は2700行を超える高度なカスタムSVG実装。
- **提案**: Rails側のコアロジック（座標計算、ドラッグ＆ドロップ処理）をTypeScriptクラスとして抽象化し、Angularコンポーネント内で再利用する。または、`d3.js` 等を用いて既存のSVG構造をAngularの宣言的な記法で再実装する。

### 2. ウィザードの状態管理の堅牢化 (P0)
- **現状**: ページ遷移ごとにURLパラメータに依存。
- **提案**: Angularの `PublicPlanService` を拡張し、`BehaviorSubject` を用いたストアパターンを導入。リロード対策として `SessionStorage` と同期させることで、Railsのセッションに近い挙動を実現する。

### 3. 多言語対応の同期 (P0)
- **現状**: ハードコードと不一致なキー。
- **提案**: Railsの `config/locales` から自動的に Angular 用の JSON を生成するスクリプトを導入し、`ngx-translate` で常に最新の共通キーを使用できるようにする。

### 4. プラン保存フローの実装 (P0)
- **現状**: ボタンすら存在しない。
- **提案**: `results` コンポーネントに保存ボタンを追加。未ログイン時は Angular 側で一時データを保持し、ログイン後に `PlanSaveService` 相当の API を叩くシーケンスを実装する。

### 5. UIコンポーネントの共通化 (P1)
- **現状**: デザイン要素がバラバラ。
- **提案**: Rails側のCSS設計（ブランドカラー、カードスタイル、ボトムバー）を Angular のグローバルスタイル (`app.css`) や共通UIコンポーネントライブラリとして抽出し、各コンポーネントに適用する。
