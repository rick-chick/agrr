# åœƒå ´è¿½åŠ ãƒ»å‰Šé™¤æ©Ÿèƒ½

## ðŸ“‹ æ¦‚è¦

æ ½åŸ¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”»é¢ã§åœƒå ´ã‚’å‹•çš„ã«è¿½åŠ ãƒ»å‰Šé™¤ã§ãã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

## âœ¨ æ©Ÿèƒ½

### åœƒå ´è¿½åŠ 
- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆä¸‹éƒ¨ã® **ç·‘è‰²ã€Œ+ åœƒå ´è¿½åŠ ã€ãƒœã‚¿ãƒ³** ã‚’ã‚¯ãƒªãƒƒã‚¯
- åœƒå ´åã¨é¢ç©ã‚’å…¥åŠ›
- è‡ªå‹•çš„ã«ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã«åæ˜ 

### åœƒå ´å‰Šé™¤
- ä½œç‰©ãŒãªã„ç©ºã®åœƒå ´ã« **èµ¤ã„Ã—ãƒœã‚¿ãƒ³** ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- Ã—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‰Šé™¤
- è‡ªå‹•çš„ã«ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤

### åˆ¶ç´„
- âœ… ä½œç‰©ãŒã‚ã‚‹åœƒå ´ã¯å‰Šé™¤ã§ããªã„ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³éžè¡¨ç¤ºï¼‰
- âœ… æœ€å¾Œã®1ã¤ã®åœƒå ´ã¯å‰Šé™¤ã§ããªã„ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³éžè¡¨ç¤ºï¼‰
- âœ… é¢ç©ã¯0ã‚ˆã‚Šå¤§ãã„å€¤ãŒå¿…é ˆ

## ðŸ”§ å®Ÿè£…è©³ç´°

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### åœƒå ´è¿½åŠ 
```
POST /api/v1/public_plans/cultivation_plans/:id/add_field
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š
- `field_name` (optional): åœƒå ´åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "åœƒå ´N"ï¼‰
- `field_area` (optional): é¢ç©ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100.0ï¼‰

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼š
```json
{
  "success": true,
  "message": "åœƒå ´ã‚’è¿½åŠ ã—ã¾ã—ãŸ",
  "field": {
    "id": 123,
    "field_id": "field_123",
    "name": "åœƒå ´5",
    "area": 150.0
  }
}
```

#### åœƒå ´å‰Šé™¤
```
DELETE /api/v1/public_plans/cultivation_plans/:id/remove_field/:field_id
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š
- `field_id`: åœƒå ´IDï¼ˆ"field_123"å½¢å¼ï¼‰

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼š
```json
{
  "success": true,
  "message": "åœƒå ´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
  "field_id": "field_123"
}
```

### field_idå½¢å¼ã®çµ±ä¸€

ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã§ `field_id` ã‚’ **"field_123"** å½¢å¼ã«çµ±ä¸€ã—ã¦ã„ã¾ã™ã€‚

**normalizeFieldId()é–¢æ•°** ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•å¤‰æ›ï¼š
- æ•°å€¤ `123` â†’ `"field_123"`
- æ–‡å­—åˆ—æ•°å€¤ `"123"` â†’ `"field_123"`
- æ—¢ã«æ­£ã—ã„å½¢å¼ `"field_123"` â†’ ãã®ã¾ã¾

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã€ä½œç‰©è¿½åŠ ã€åœƒå ´ç®¡ç†ã™ã¹ã¦ã§äº’æ›æ€§ã‚’ä¿è¨¼ã€‚

## ðŸ§ª ãƒ†ã‚¹ãƒˆ

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆAPIï¼‰
```bash
docker compose run --rm test bundle exec rails test \
  test/controllers/api/v1/public_plans/cultivation_plans_controller_test.rb \
  -n "/add_field|remove_field/"
```

**çµæžœ**: âœ… 7 runs, 35 assertions, 0 failures, 0 errors

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š
- âœ… åœƒå ´ã®æ­£å¸¸è¿½åŠ 
- âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ã®è¿½åŠ 
- âœ… ç„¡åŠ¹ãªé¢ç©ã§ã®ã‚¨ãƒ©ãƒ¼
- âœ… ç©ºã®åœƒå ´ã®å‰Šé™¤
- âœ… ä½œç‰©ãŒã‚ã‚‹åœƒå ´ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼
- âœ… æœ€å¾Œã®åœƒå ´ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼
- âœ… å­˜åœ¨ã—ãªã„åœƒå ´ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
è©³ç´°ã¯ä»¥ä¸‹ã‚’å‚ç…§ï¼š
- [FIELD_MANAGEMENT_MANUAL_TEST.md](./FIELD_MANAGEMENT_MANUAL_TEST.md)
- [FIELD_MANAGEMENT_CHECKLIST.md](./FIELD_MANAGEMENT_CHECKLIST.md)

## ðŸ› ãƒ‡ãƒãƒƒã‚°

ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ä»¥ä¸‹ã®é–¢æ•°ãŒä½¿ç”¨å¯èƒ½ï¼š

```javascript
// åœƒå ´IDå½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
debugFieldIds()

// å®Œå…¨ãªçŠ¶æ…‹ã‚’è¡¨ç¤º
debugState()

// æ‰‹å‹•ã§åœƒå ´ã‚’è¿½åŠ 
addField()

// æ‰‹å‹•ã§åœƒå ´ã‚’å‰Šé™¤
removeField('field_123')

// field_idã‚’æ­£è¦åŒ–
normalizeFieldId(123)  // â†’ "field_123"
```

## ðŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### JavaScript
- `app/assets/javascripts/custom_gantt_chart.js`
  - `normalizeFieldId()` - field_idæ­£è¦åŒ–
  - `addField()` - åœƒå ´è¿½åŠ 
  - `removeField()` - åœƒå ´å‰Šé™¤
  - `groupByField()` - åœƒå ´ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆç©ºã®åœƒå ´ã‚‚å«ã‚€ï¼‰

### Ruby
- `app/controllers/api/v1/public_plans/cultivation_plans_controller.rb`
  - `add_field` ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  - `remove_field` ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  - `data` ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåœƒå ´æƒ…å ±ã‚‚å«ã‚€ï¼‰

### ãƒ“ãƒ¥ãƒ¼
- `app/views/public_plans/results/_gantt_chart.html.erb`
  - `fields_data` å¤‰æ•°ã‚’è¿½åŠ 

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- `config/routes.rb`
  - `post :add_field`
  - `delete 'remove_field/:field_id'`

## ðŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### åœƒå ´è¿½åŠ ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã
2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
3. `ganttState` ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

### åœƒå ´è¿½åŠ å¾Œã«ç”»é¢ãŒæ›´æ–°ã•ã‚Œãªã„
1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§ `/add_field` ãŒ 200 OK ã‚’è¿”ã—ã¦ã„ã‚‹ã‹ç¢ºèª
2. `/data` ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. `hideLoadingOverlay()` ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼
1. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ `debugFieldIds()` ã‚’å®Ÿè¡Œ
2. ã™ã¹ã¦ã®field_idãŒ `"field_123"` å½¢å¼ã‹ç¢ºèª
3. ä¸æ­£ãªå½¢å¼ãŒã‚ã‚‹å ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰

## ðŸŽ¯ ä½¿ç”¨ä¾‹

### ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®æ“ä½œ
1. http://localhost:3000 ã‚’é–‹ã
2. ä½œä»˜ã‘è¨ˆç”»ã‚’ä½œæˆ
3. çµæžœç”»é¢ã§ä»¥ä¸‹ã‚’è©¦ã™ï¼š
   - ã€Œ+ åœƒå ´è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - åœƒå ´åã€Œåœƒå ´5ã€ã€é¢ç©ã€Œ200ã€ã‚’å…¥åŠ›
   - æ–°ã—ã„åœƒå ´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - ä½œç‰©ãƒ‘ãƒ¬ãƒƒãƒˆã‹ã‚‰ä½œç‰©ã‚’ãƒ‰ãƒ©ãƒƒã‚°
   - æ–°ã—ã„åœƒå ´ã«ãƒ‰ãƒ­ãƒƒãƒ—
   - æ­£å¸¸ã«è¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - ä½œç‰©ã‚’å‰Šé™¤
   - ç©ºã«ãªã£ãŸåœƒå ´ã®Ã—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - åœƒå ´ãŒå‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèª
```javascript
// åˆæœŸçŠ¶æ…‹
debugState()

// åœƒå ´è¿½åŠ å¾Œ
debugFieldIds()

// ã™ã¹ã¦"field_123"å½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
ganttState.fieldGroups.map(g => g.fieldId)
// ["field_92", "field_93", "field_95", "field_105"]
```

