# Public Plans 保存機能 要件定義書

## 概要
public_plans（公開作付け計画）に保存機能を追加し、未ログインの場合はログイン画面に遷移させ、ログイン後に計画を個人のplansにコピーする機能を実装する。

## 現在のシステム構成

### 既存モデル
- **CultivationPlan**: 作付け計画のメインモデル
  - `plan_type`: 'public' | 'private'
  - `user_id`: ユーザーID（publicの場合はnull）
  - `session_id`: セッションID（publicの場合）
  - 関連: Farm, User, CultivationPlanField, CultivationPlanCrop, FieldCultivation

- **User**: ユーザーモデル
  - `is_anonymous`: 匿名ユーザーフラグ
  - 関連: Farm, Field, Crop, CultivationPlan

- **Farm**: 農場モデル
  - `is_reference`: 参照農場フラグ
  - 関連: User, Field, FreeCropPlan

- **Crop**: 作物モデル
  - `is_reference`: 参照作物フラグ
  - 関連: User, CropStage

### 認証システム
- Google OAuth2認証（開発・テスト環境のみ）
- セッション管理（Sessionモデル）
- 匿名ユーザー対応

## 機能要件

### 1. 保存ボタンの追加
- **場所**: public_plans/results画面
- **表示条件**: 計画が完了している場合のみ
- **ボタンラベル**: 「計画を保存する」

### 2. 未ログイン時の処理
- **アクション**: 保存ボタンクリック時
- **処理**: 
  1. 現在のpublic_planの情報をセッションに保存
  2. ログイン画面（`/auth/login`）にリダイレクト
  3. ログイン成功後、保存処理を実行

#### 2.1 サインイン（新規登録）フロー
- **初回ユーザーの場合**: Google OAuth2で新規アカウント作成
- **既存ユーザーの場合**: 既存アカウントでログイン
- **セッション保存以降**: ログイン・サインイン問わず同じ保存処理を実行

### 3. ログイン後の保存処理
- **トリガー**: ログイン成功後のリダイレクト
- **処理内容**:
  1. セッションからpublic_plan情報を取得
  2. ユーザーのマスタデータを作成・取得
  3. public_planをprivate_planにコピー
  4. 関連データの紐付け

### 4. マスタデータの作成・取得

#### 4.1 農場（Farm）の処理
- **参照農場から個人農場へのコピー**:
  - `is_reference: false`で新しいFarmを作成
  - 参照農場の座標・地域情報をコピー
  - ユーザーに紐付け
  - **重複チェック**: 同じ座標の農場が既に存在する場合は既存のものを使用

#### 4.2 作物（Crop）の処理
- **参照作物から個人作物へのコピー**:
  - `is_reference: false`で新しいCropを作成
  - 参照作物の詳細情報をコピー
  - ユーザーに紐付け
  - **作物ステージのコピー**: CropStage、TemperatureRequirement、ThermalRequirement、SunshineRequirementも含めてコピー
  - **重複チェック**: 同じ名前の作物が既に存在する場合は既存のものを使用

#### 4.3 圃場（Field）の処理
- **新規圃場の作成**:
  - 計画の圃場情報からFieldを作成
  - 農場に紐付け
  - **座標情報**: 計画の圃場座標をそのまま使用

#### 4.4 連作ルール（InteractionRule）の処理
- **連作ルールのコピー**:
  - 計画で使用された作物の組み合わせから連作ルールを作成
  - ユーザーに紐付け
  - **ルールの詳細**: 作物間の相互作用ルールを適切に設定

#### 4.5 マスタデータ間の関連付け
- **農場 ↔ 圃場**: 作成した圃場を農場に紐付け
- **作物 ↔ 圃場**: 計画で使用された作物と圃場の関係を維持
- **作物 ↔ 連作ルール**: 作物の組み合わせから連作ルールを生成
- **データ整合性**: 全てのマスタデータが適切に関連付けられていることを確認

### 5. 計画のコピー処理
- **CultivationPlanのコピー**:
  - `plan_type: 'private'`に変更
  - `user_id`を設定
  - `session_id`をクリア
  - `plan_year`を今年に設定
  - `planning_start_date`, `planning_end_date`を今年の期間に設定

- **関連データのコピー**:
  - CultivationPlanField
  - CultivationPlanCrop
  - FieldCultivation

### 6. 保存後の遷移
- **成功時**: 個人のplans一覧画面（`/plans`）にリダイレクト
- **失敗時**: エラーメッセージと共に元の画面に戻る

## 技術要件

### 1. セッション管理
- **保存データ**: public_planのID、農場ID、作物IDリスト
- **有効期限**: 24時間
- **キー**: `:public_plan_save_data`

### 2. トランザクション処理
- **原子性**: 全ての処理を1つのトランザクションで実行
- **ロールバック**: エラー時は全ての変更をロールバック

### 3. エラーハンドリング
- **バリデーションエラー**: 適切なエラーメッセージを表示
- **データ不整合**: ロールバックしてエラー画面に遷移
- **権限エラー**: ログイン画面にリダイレクト

### 4. パフォーマンス
- **N+1問題の回避**: includesを使用した効率的なクエリ
- **バルクインサート**: 大量データの一括処理

## 画面仕様

### 1. 保存ボタン
- **位置**: results画面の下部
- **スタイル**: プライマリボタン
- **アイコン**: 保存アイコン
- **テキスト**: 「計画を保存する」

### 2. ログイン画面
- **既存画面**: `/auth/login`
- **追加処理**: ログイン成功後の保存処理実行

### 3. 成功画面
- **遷移先**: `/plans`
- **メッセージ**: 「計画が正常に保存されました」

### 4. エラー画面
- **表示場所**: 元の画面
- **メッセージ**: 具体的なエラー内容

## データベース変更

### 1. 新規テーブル
- 不要（既存モデルを活用）

### 2. 既存テーブルの変更
- 不要（既存のカラムを活用）

### 3. インデックス
- 既存のインデックスを活用

## セキュリティ要件

### 1. 認証
- **必須**: ログイン済みユーザーのみ保存可能
- **セッション**: 有効なセッションのみ処理

### 2. 権限
- **作成権限**: ログイン済みユーザーのみ
- **データアクセス**: 自分のデータのみ

### 3. データ保護
- **個人情報**: 適切な暗号化
- **セッション**: セキュアなセッション管理

## テスト要件

### 1. 単体テスト
- **モデル**: 各モデルの保存処理
- **コントローラー**: 保存アクション
- **サービス**: ビジネスロジック

### 2. 統合テスト
- **フロー**: 未ログイン→ログイン→保存
- **データ**: マスタデータの作成・紐付け
- **エラー**: 各種エラーケース

### 3. E2Eテスト
- **ユーザーフロー**: 保存ボタン→ログイン→保存完了
- **データ整合性**: 保存後のデータ確認

## 実装優先度

### Phase 1: 基本機能
1. 保存ボタンの追加
2. 未ログイン時のログイン画面遷移
3. 基本的な保存処理

### Phase 2: マスタデータ処理
1. 農場のコピー処理
2. 作物のコピー処理
3. 圃場の作成処理

### Phase 3: 高度な機能
1. 連作ルールの処理
2. エラーハンドリングの強化
3. パフォーマンス最適化

## 注意事項

### 1. 既存機能への影響
- **public_plans**: 既存機能は変更なし
- **認証**: 既存の認証フローを活用
- **データ**: 既存のデータ構造を活用

### 2. 後方互換性
- **API**: 既存のAPIは変更なし
- **画面**: 既存の画面は変更なし
- **データ**: 既存のデータは変更なし

### 3. パフォーマンス
- **大量データ**: 効率的なバルク処理
- **メモリ**: 適切なメモリ使用量
- **レスポンス**: 適切なレスポンス時間
