# マスタデータ間のデータ移送図

## 概要
public_plansからprivate_plansへの保存時に、参照マスタデータから個人マスタデータへの移送処理を図で表現します。

## データ移送フロー図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Public Plans 保存処理                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           セッションデータ保存                                    │
│  session[:public_plan_save_data] = {                                            │
│    plan_id: 123,                                                                │
│    farm_id: 456,                                                                │
│    crop_ids: [789, 790, 791],                                                  │
│    field_data: [{name: "Field A", area: 100, coordinates: [35.0, 139.0]}]      │
│  }                                                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ログイン・サインイン処理                                │
│  Google OAuth2 → User.from_omniauth → Session.create_for_user                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           PlanSaveService 実行                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        1. マスタデータの作成・取得                                │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          農場（Farm）の新規作成処理                               │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   参照農場       │    │   個人農場       │    │   天気情報取得   │              │
│  │                 │    │                 │    │                 │              │
│  │ is_reference:   │───▶│ is_reference:   │    │ LocationWeather │              │
│  │ true            │    │ false           │    │ から天気情報を   │              │
│  │                 │    │                 │    │ 取得            │              │
│  │ latitude: 35.0  │    │ latitude: 35.0  │    │                 │              │
│  │ longitude: 139.0│    │ longitude: 139.0 │    │ 天気データ取得   │              │
│  │ region: "jp"    │    │ region: "jp"    │    │ ジョブを実行     │              │
│  │                 │    │                 │    │                 │              │
│  │ weather_location│    │ weather_location│    │                 │              │
│  │ _id: 123        │    │ _id: 新規作成    │    │                 │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          作物（Crop）のコピー処理                                │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   計画作物       │    │   個人作物       │    │   参照作物から   │              │
│  │                 │    │                 │    │   ステージ取得   │              │
│  │ CultivationPlan │───▶│ is_reference:   │    │                 │              │
│  │ Crop            │    │ false           │    │ ┌─────────────┐ │              │
│  │                 │    │                 │    │ │参照作物の    │ │              │
│  │ crop: 参照作物   │    │ name: 参照作物   │    │ │CropStageを   │ │              │
│  │ quantity: 10    │    │ variety: 参照作物│    │ │コピー        │ │              │
│  │                 │    │ area_per_unit:  │    │ │             │ │              │
│  │                 │    │ 参照作物から     │    │ │Temperature  │ │              │
│  │                 │    │ 取得            │    │ │Thermal      │ │              │
│  │                 │    │                 │    │ │Sunshine     │ │              │
│  │                 │    │                 │    │ │Requirements │ │              │
│  └─────────────────┘    └─────────────────┘    │ └─────────────┘ │              │
│                                               │                 │              │
│                                               │ 重複チェック     │              │
│                                               │ 同じ名前の作物   │              │
│                                               │ が既存かチェック │              │
│                                               │ 既存なら使用     │              │
│                                               │ 新規なら作成     │              │
│                                               └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          圃場（Field）の作成処理                                 │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   計画圃場データ  │    │   個人圃場       │    │   農場への紐付け │              │
│  │                 │    │                 │    │                 │              │
│  │ name: "Field A" │───▶│ name: "Field A" │    │ field.farm =    │              │
│  │ area: 100       │    │ area: 100       │    │ user_farm       │              │
│  │ coordinates:    │    │ coordinates:    │    │                 │              │
│  │ [35.0, 139.0]   │    │ [35.0, 139.0]   │    │                 │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    CultivationPlanInteractionRule のコピー処理                   │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   計画の連作ルール │    │   個人連作ルール │    │   重複チェック   │              │
│  │                 │    │                 │    │                 │              │
│  │ CultivationPlan │───▶│ is_reference:   │    │ 同じ組み合わせ   │              │
│  │ InteractionRule │    │ false           │    │ のルールが既存   │              │
│  │                 │    │                 │    │ かチェック       │              │
│  │ crop1: トマト   │    │ crop1: トマト   │    │ 既存なら使用     │              │
│  │ crop2: キュウリ │    │ crop2: キュウリ │    │ 新規なら作成     │              │
│  │ interaction_    │    │ interaction_    │    │                 │              │
│  │ type: "neutral" │    │ type: "neutral" │    │                 │              │
│  │ description:    │    │ description:    │    │                 │              │
│  │ "トマトとキュウリ│    │ "トマトとキュウリ│    │                 │              │
│  │ の連作ルール"    │    │ の連作ルール"    │    │                 │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        2. マスタデータ間の関連付け                               │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          関連付け処理の詳細                                       │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   農場 ↔ 圃場   │    │   作物 ↔ 圃場   │    │   作物 ↔ 連作   │              │
│  │                 │    │                 │    │   ルール        │              │
│  │ farm.fields     │    │ 計画で使用された │    │                 │              │
│  │ << field        │    │ 作物と圃場の関係 │    │ crop1 ↔ crop2   │              │
│  │                 │    │ を維持          │    │ の関係を設定    │              │
│  │ field.farm =    │    │                 │    │                 │              │
│  │ farm            │    │                 │    │                 │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        3. 計画のコピー処理                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          CultivationPlan のコピー                                │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Public Plan   │    │  Private Plan   │    │   関連データ     │              │
│  │                 │    │                 │    │   のコピー       │              │
│  │ plan_type:      │───▶│ plan_type:      │    │                 │              │
│  │ "public"        │    │ "private"       │    │ CultivationPlan │              │
│  │                 │    │                 │    │ Field          │              │
│  │ user_id: null   │    │ user_id: user.id│    │                 │              │
│  │                 │    │                 │    │ CultivationPlan │              │
│  │ session_id:     │    │ session_id: null│    │ Crop            │              │
│  │ "abc123"        │    │                 │    │                 │              │
│  │                 │    │ plan_year:      │    │ FieldCultivation│              │
│  │ plan_year: null │    │ Date.current.  │    │                 │              │
│  │                 │    │ year            │    │                 │              │
│  │ planning_start_ │    │                 │    │                 │              │
│  │ date: null      │    │ planning_start_ │    │                 │              │
│  │                 │    │ date: Date.     │    │                 │              │
│  │ planning_end_   │    │ current.       │    │                 │              │
│  │ date: null      │    │ beginning_of_  │    │                 │              │
│  │                 │    │ year            │    │                 │              │
│  │                 │    │                 │    │                 │              │
│  │                 │    │ planning_end_   │    │                 │              │
│  │                 │    │ date: Date.     │    │                 │              │
│  │                 │    │ current.       │    │                 │              │
│  │                 │    │ end_of_year    │    │                 │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        4. データ整合性チェック                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          整合性チェック項目                                       │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   農場チェック   │    │   作物チェック   │    │   圃場チェック   │              │
│  │                 │    │                 │    │                 │              │
│  │ farm.fields.    │    │ crops.all?     │    │ fields.all?     │              │
│  │ count ==        │    │ (&:persisted?) │    │ (&:persisted?)  │              │
│  │ fields.count    │    │                 │    │                 │              │
│  │                 │    │                 │    │                 │              │
│  │ 圃場数が一致     │    │ 作物が正しく     │    │ 圃場が正しく     │              │
│  │ しているか       │    │ 作成されているか │    │ 作成されているか │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   連作ルール     │    │   計画チェック   │    │   関連データ     │              │
│  │   チェック       │    │                 │    │   チェック       │              │
│  │                 │    │                 │    │                 │              │
│  │ interaction_    │    │ plan.plan_type  │    │ plan.fields.    │              │
│  │ rules.all?      │    │ == "private"    │    │ count > 0       │              │
│  │ (&:persisted?)  │    │                 │    │                 │              │
│  │                 │    │ plan.user_id   │    │ plan.crops.     │              │
│  │ 連作ルールが     │    │ == user.id     │    │ count > 0       │              │
│  │ 正しく作成       │    │                 │    │                 │              │
│  │ されているか     │    │ 計画が正しく     │    │ 関連データが     │              │
│  │                 │    │ 作成されているか │    │ 正しく作成       │              │
│  │                 │    │                 │    │ されているか     │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              成功時の処理                                        │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   セッション     │    │   リダイレクト   │    │   完了メッセージ │              │
│  │   クリア        │    │                 │    │                 │              │
│  │                 │    │                 │    │                 │              │
│  │ session.delete  │    │ redirect_to     │    │ "計画が正常に   │              │
│  │ (:public_plan_  │    │ plans_path      │    │ 保存されました" │              │
│  │ save_data)      │    │                 │    │                 │              │
│  │                 │    │                 │    │                 │              │
│  │ 保存データを     │    │ 個人の計画一覧   │    │ ユーザーに完了   │              │
│  │ セッションから   │    │ 画面に遷移      │    │ を通知          │              │
│  │ 削除            │    │                 │    │                 │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## データ移送の詳細

### 1. セッションデータの保存
```
session[:public_plan_save_data] = {
  plan_id: 123,                    # 元の計画ID
  farm_id: 456,                    # 参照農場ID
  crop_ids: [789, 790, 791],       # 参照作物IDリスト
  field_data: [                    # 圃場データ
    {
      name: "Field A",
      area: 100,
      coordinates: [35.0, 139.0]
    }
  ],
  created_at: Time.current         # 保存日時
}
```

### 2. マスタデータのコピー処理

#### 2.1 農場の新規作成
```
参照農場 → 個人農場（新規作成）
├── is_reference: true → false
├── user_id: null → user.id
├── 座標・地域情報をコピー
├── weather_location_id: 新規作成
└── 天気データ取得ジョブを実行
```

#### 2.2 作物のコピー（計画作物から）
```
計画作物 → 個人作物
├── CultivationPlanCrop → Crop
├── is_reference: true → false
├── user_id: null → user.id
├── 基本情報を参照作物から取得（name, variety, area_per_unit, revenue_per_area, groups）
├── 作物ステージを参照作物からコピー
│   ├── CropStage
│   ├── TemperatureRequirement
│   ├── ThermalRequirement
│   └── SunshineRequirement
└── 重複チェック（同じ名前の作物が既存か）
```

#### 2.3 圃場の作成
```
計画圃場データ → 個人圃場
├── name: 計画の圃場名
├── area: 計画の圃場面積
├── coordinates: 計画の圃場座標
└── farm: 作成した個人農場に紐付け
```

#### 2.4 CultivationPlanInteractionRule のコピー
```
計画の連作ルール → 個人連作ルール
├── CultivationPlanInteractionRule → InteractionRule
├── is_reference: true → false
├── user_id: null → user.id
├── crop1, crop2: 作物の組み合わせ
├── interaction_type: 計画からコピー
├── description: 計画からコピー
└── 重複チェック（同じ組み合わせのルールが既存か）
```

### 3. マスタデータ間の関連付け

#### 3.1 農場 ↔ 圃場
```
farm.fields << field
field.farm = farm
```

#### 3.2 作物 ↔ 連作ルール
```
interaction_rule.crop1 = user_crop1
interaction_rule.crop2 = user_crop2
```

#### 3.3 計画 ↔ マスタデータ
```
plan.farm = user_farm
plan.cultivation_plan_crops.each do |plan_crop|
  plan_crop.crop = user_crop
end
plan.cultivation_plan_fields.each do |plan_field|
  plan_field.field = user_field
end
plan.cultivation_plan_interaction_rules.each do |plan_rule|
  plan_rule.interaction_rule = user_interaction_rule
end
```

### 4. データ整合性チェック

#### 4.1 農場チェック
```
farm.fields.count == fields.count
```

#### 4.2 作物チェック
```
crops.all?(&:persisted?)
```

#### 4.3 圃場チェック
```
fields.all?(&:persisted?)
```

#### 4.4 連作ルールチェック
```
interaction_rules.all?(&:persisted?)
```

#### 4.5 計画チェック
```
plan.plan_type == "private"
plan.user_id == user.id
plan.fields.count > 0
plan.crops.count > 0
plan.interaction_rules.count > 0
```

## エラーハンドリング

### 1. トランザクション処理
```
ActiveRecord::Base.transaction do
  # 全ての処理を実行
  # エラー時は自動的にロールバック
end
```

### 2. エラーケース
- **バリデーションエラー**: データの整合性エラー
- **データ不整合**: マスタデータの関連付けエラー
- **権限エラー**: ユーザーの権限不足
- **システムエラー**: 予期しないエラー

### 3. エラー処理
```
rescue => e
  Rails.logger.error "PlanSaveService error: #{e.message}"
  @result.error_message = e.message
  @result
end
```

## パフォーマンス考慮

### 1. バルク処理
- 大量データの一括処理
- N+1問題の回避

### 2. メモリ使用量
- 適切なメモリ使用量
- ガベージコレクションの考慮

### 3. データベースクエリ
- 効率的なクエリの実行
- インデックスの活用
