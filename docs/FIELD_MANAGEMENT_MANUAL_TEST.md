# 圃場追加・削除機能 - 手動テストガイド

## 概要
栽培スケジュール画面で圃場を追加・削除する機能の動作確認手順です。

## 前提条件
```bash
docker compose up
# ブラウザで http://localhost:3000 を開く
```

## テストシナリオ

### 1. 圃場追加機能

#### 1.1 基本的な追加
1. 作付け計画を作成して結果画面に移動
2. ガントチャート下部の **緑色の「+ 圃場追加」ボタン** をクリック
3. プロンプトで圃場名を入力（例: `圃場5`）
4. プロンプトで面積を入力（例: `150`）
5. 「圃場を追加中...」のローディング表示が出る
6. **期待結果**: 新しい圃場の行がガントチャートに表示される

#### 1.2 デフォルト値
1. 「+ 圃場追加」ボタンをクリック
2. プロンプトで何も変更せずにOK（デフォルト値を使用）
3. **期待結果**: `圃場N`（Nは次の番号）、面積100㎡で追加される

#### 1.3 バリデーション
1. 「+ 圃場追加」ボタンをクリック
2. 面積に`-10`を入力
3. **期待結果**: 「有効な面積を入力してください」アラートが表示される

### 2. 圃場削除機能

#### 2.1 空の圃場を削除
1. 作物がない空の圃場を確認
2. 圃場行の左側にある **赤い×ボタン** をクリック
3. 確認ダイアログで「OK」をクリック
4. 「圃場を削除中...」のローディング表示が出る
5. **期待結果**: 圃場がガントチャートから削除される

#### 2.2 作物がある圃場（削除不可）
1. 作物が配置されている圃場を確認
2. **期待結果**: 削除ボタン（×）が **表示されない**
3. （実装: `group.cultivations.length === 0`の場合のみ表示）

#### 2.3 最後の圃場（削除不可）
1. 圃場を1つだけ残す（他を削除）
2. **期待結果**: 最後の圃場には削除ボタンが **表示されない**
3. （実装: `ganttState.fieldGroups.length > 1`の場合のみ表示）

### 3. 統合シナリオ

#### 3.1 圃場追加 → 作物ドロップ
1. 「+ 圃場追加」で新しい圃場を追加
2. 作物パレットを開く
3. 作物を新しい圃場にドラッグ&ドロップ
4. **期待結果**: 作物が追加され、最適化が実行される

#### 3.2 作物削除 → 圃場削除
1. 圃場にある作物を削除（右クリックまたは×ボタン）
2. 圃場が空になったことを確認
3. 圃場の×ボタンが表示される
4. ×ボタンをクリックして圃場を削除
5. **期待結果**: 圃場が削除される

#### 3.3 作物を移動 → 元の圃場を削除
1. 圃場Aにある唯一の作物を圃場Bに移動
2. 圃場Aが空になる
3. 圃場Aの×ボタンが表示される
4. ×ボタンで圃場Aを削除
5. **期待結果**: 圃場Aが削除され、圃場Bに作物が残る

## デバッグ情報の確認

### ブラウザのコンソールログ
F12キーで開発者ツールを開き、Consoleタブで以下のログを確認：

```javascript
// 初期化時
🔧 初期化時の圃場情報（正規化前）: [...]
🔧 初期化時の圃場情報（正規化後）: [...]
✅ 圃場追加ボタンを描画しました

// 圃場追加時
🖱️ 圃場追加ボタンがクリックされました
➕ 圃場を追加
📊 現在の圃場数: 3
📤 圃場追加リクエスト: {field_name: "圃場5", field_area: 150}
📊 API Response: {success: true, ...}
✅ 圃場を追加しました

// 圃場削除時
🗑️ 圃場を削除: field_123
📊 API Response: {success: true, ...}
✅ 圃場を削除しました

// データ更新時
📊 データ取得成功: {...}
📊 取得した圃場情報: [...]
📊 正規化後の圃場情報: [...]
📊 グループ化結果: [...]
```

### field_id形式の確認
コンソールで実行：
```javascript
// 全圃場のfield_idを確認
ganttState.fieldGroups.map(g => g.fieldId)
// 期待される出力: ["field_92", "field_93", "field_95"]

// すべて"field_123"形式であることを確認
ganttState.fieldGroups.every(g => typeof g.fieldId === 'string' && g.fieldId.startsWith('field_'))
// 期待される出力: true
```

## トラブルシューティング

### 問題: 圃場追加ボタンが表示されない
- F12でコンソールを開く
- エラーがないか確認
- `ganttState.fieldGroups`が存在するか確認

### 問題: 圃場追加後に画面が更新されない
- ネットワークタブで `/add_field` リクエストが200 OKを返しているか確認
- `/data` リクエストが実行されているか確認
- `hideLoadingOverlay()`が呼ばれているか確認

### 問題: 作物ドロップ後にエラー
- コンソールで `field_id` の形式を確認
- すべて `"field_123"` 形式であることを確認
- `normalizeFieldId()` 関数が正しく動作しているか確認

## 成功の確認ポイント

✅ 圃場追加ボタンが緑色で表示される
✅ クリックするとプロンプトが表示される
✅ 追加後、ガントチャートに新しい行が表示される
✅ 空の圃場に赤い×ボタンが表示される
✅ ×ボタンで圃場が削除される
✅ 作物のドラッグ&ドロップが正常に動作する
✅ すべてのfield_idが"field_123"形式で統一されている

## 関連ファイル
- `app/assets/javascripts/custom_gantt_chart.js` - メイン機能
- `app/controllers/api/v1/public_plans/cultivation_plans_controller.rb` - API
- `config/routes.rb` - ルーティング
- `test/controllers/api/v1/public_plans/cultivation_plans_controller_test.rb` - 単体テスト

