# å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ãƒ­ãƒ¼ã¨ç§»é€ã®å…¨ä½“åƒ

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹                                      â”‚
â”‚                          â•â•â•â•â•â•â•â•â•â•â•â•â•                                       â”‚
â”‚                                                                              â”‚
â”‚                         ğŸŒ Open-Meteo API                                    â”‚
â”‚                    (ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹å¤©æ°—ãƒ‡ãƒ¼ã‚¿API)                               â”‚
â”‚                                                                              â”‚
â”‚                  https://open-meteo.com/                                     â”‚
â”‚           ãƒ»éå»ã®æ°—è±¡ãƒ‡ãƒ¼ã‚¿ï¼ˆ2000å¹´ï½ç¾åœ¨ï¼‰                                    â”‚
â”‚           ãƒ»é«˜ç²¾åº¦ãªæ°—è±¡è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿                                             â”‚
â”‚           ãƒ»ç„¡æ–™ãƒ»å•†ç”¨åˆ©ç”¨å¯èƒ½                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ HTTPS Request
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      2. ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚³ãƒãƒ³ãƒ‰                                     â”‚
â”‚                      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                     â”‚
â”‚                                                                              â”‚
â”‚                      ğŸ“¦ agrr weather ã‚³ãƒãƒ³ãƒ‰                                â”‚
â”‚                         (lib/core/agrr)                                      â”‚
â”‚                                                                              â”‚
â”‚   ãƒ»ãƒã‚¤ãƒŠãƒªå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆGo/Rustè£½ï¼‰                                          â”‚
â”‚   ãƒ»Open-Meteo APIã‹ã‚‰å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—                                         â”‚
â”‚   ãƒ»JSONå½¢å¼ã§å‡ºåŠ›                                                            â”‚
â”‚                                                                              â”‚
â”‚   ã‚³ãƒãƒ³ãƒ‰ä¾‹ï¼š                                                                â”‚
â”‚   agrr weather --location 35.6762,139.6503 \                                â”‚
â”‚                --start-date 2005-01-01 \                                    â”‚
â”‚                --end-date 2025-12-31 \                                      â”‚
â”‚                --json                                                        â”‚
â”‚                                                                              â”‚
â”‚   å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å½¢å¼ï¼š                                                             â”‚
â”‚   {                                                                          â”‚
â”‚     "success": true,                                                         â”‚
â”‚     "data": {                                                                â”‚
â”‚       "location": {                                                          â”‚
â”‚         "latitude": 35.6762,                                                 â”‚
â”‚         "longitude": 139.6503,                                               â”‚
â”‚         "elevation": 40.0,                                                   â”‚
â”‚         "timezone": "Asia/Tokyo"                                             â”‚
â”‚       },                                                                     â”‚
â”‚       "data": [                                                              â”‚
â”‚         {                                                                    â”‚
â”‚           "time": "2005-01-01",                                              â”‚
â”‚           "temperature_2m_max": 12.5,                                        â”‚
â”‚           "temperature_2m_min": 3.2,                                         â”‚
â”‚           "temperature_2m_mean": 7.8,                                        â”‚
â”‚           "precipitation_sum": 0.0,                                          â”‚
â”‚           "sunshine_hours": 8.5,                                             â”‚
â”‚           "wind_speed_10m": 3.2,                                             â”‚
â”‚           "weather_code": 0                                                  â”‚
â”‚         },                                                                   â”‚
â”‚         ...                                                                  â”‚
â”‚       ]                                                                      â”‚
â”‚     }                                                                        â”‚
â”‚   }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ JSON Output
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   3. Railsãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–                                â”‚
â”‚                   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                â”‚
â”‚                                                                              â”‚
â”‚              ğŸ”„ FetchWeatherDataJob                                          â”‚
â”‚           (app/jobs/fetch_weather_data_job.rb)                               â”‚
â”‚                                                                              â”‚
â”‚   ãƒ»Solid Queueï¼ˆSQLiteãƒ™ãƒ¼ã‚¹ï¼‰ã§å®Ÿè¡Œ                                          â”‚
â”‚   ãƒ»agrrã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦JSONå–å¾—                                             â”‚
â”‚   ãƒ»ãƒ‘ãƒ¼ã‚¹ï¼†ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³                                                      â”‚
â”‚   ãƒ»DBã¸ä¸€æ‹¬ä¿å­˜ï¼ˆupsertï¼‰                                                     â”‚
â”‚   ãƒ»ã‚¨ãƒ©ãƒ¼æ™‚ã¯è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§5å›ï¼‰                                           â”‚
â”‚                                                                              â”‚
â”‚   å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼š                                                                 â”‚
â”‚   1. agrrã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ                                                         â”‚
â”‚      stdout, stderr = Open3.capture3(agrr, 'weather', ...)                  â”‚
â”‚                                                                              â”‚
â”‚   2. JSONãƒ‘ãƒ¼ã‚¹                                                               â”‚
â”‚      weather_data = JSON.parse(stdout)                                       â”‚
â”‚                                                                              â”‚
â”‚   3. WeatherLocationä½œæˆ/å–å¾—                                                 â”‚
â”‚      weather_location = WeatherLocation.find_or_create_by_coordinates(      â”‚
â”‚        latitude: data['location']['latitude'],                               â”‚
â”‚        longitude: data['location']['longitude'],                             â”‚
â”‚        elevation: data['location']['elevation'],                             â”‚
â”‚        timezone: data['location']['timezone']                                â”‚
â”‚      )                                                                       â”‚
â”‚                                                                              â”‚
â”‚   4. WeatherDataã‚’ä¸€æ‹¬ä¿å­˜                                                    â”‚
â”‚      WeatherDatum.upsert_all(records,                                        â”‚
â”‚        unique_by: [:weather_location_id, :date])                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Database Insert
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜                                     â”‚
â”‚                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                       â”‚
â”‚                                                                              â”‚
â”‚                      ğŸ“ SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹                                    â”‚
â”‚                    (storage/production.sqlite3)                              â”‚
â”‚                                                                              â”‚
â”‚   ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ï¼š                                                               â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ weather_locations               â”‚                                       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                       â”‚
â”‚   â”‚ id                    (PK)      â”‚                                       â”‚
â”‚   â”‚ latitude              (decimal) â”‚ â† ç·¯åº¦                                â”‚
â”‚   â”‚ longitude             (decimal) â”‚ â† çµŒåº¦                                â”‚
â”‚   â”‚ elevation             (decimal) â”‚ â† æ¨™é«˜                                â”‚
â”‚   â”‚ timezone              (string)  â”‚ â† ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³                         â”‚
â”‚   â”‚ created_at/updated_at          â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚              â”‚                                                               â”‚
â”‚              â”‚ has_many                                                      â”‚
â”‚              â†“                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚   â”‚ weather_data                    â”‚                                       â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                       â”‚
â”‚   â”‚ id                    (PK)      â”‚                                       â”‚
â”‚   â”‚ weather_location_id   (FK)      â”‚                                       â”‚
â”‚   â”‚ date                  (date)    â”‚ â† æ—¥ä»˜                                â”‚
â”‚   â”‚ temperature_max       (decimal) â”‚ â† æœ€é«˜æ°—æ¸©ï¼ˆâ„ƒï¼‰                       â”‚
â”‚   â”‚ temperature_min       (decimal) â”‚ â† æœ€ä½æ°—æ¸©ï¼ˆâ„ƒï¼‰                       â”‚
â”‚   â”‚ temperature_mean      (decimal) â”‚ â† å¹³å‡æ°—æ¸©ï¼ˆâ„ƒï¼‰                       â”‚
â”‚   â”‚ precipitation         (decimal) â”‚ â† é™æ°´é‡ï¼ˆmmï¼‰                         â”‚
â”‚   â”‚ sunshine_hours        (decimal) â”‚ â† æ—¥ç…§æ™‚é–“ï¼ˆæ™‚é–“ï¼‰                     â”‚
â”‚   â”‚ wind_speed            (decimal) â”‚ â† é¢¨é€Ÿï¼ˆm/sï¼‰                         â”‚
â”‚   â”‚ weather_code          (integer) â”‚ â† å¤©æ°—ã‚³ãƒ¼ãƒ‰                          â”‚
â”‚   â”‚ created_at/updated_at          â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                              â”‚
â”‚   ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼š                                                               â”‚
â”‚   ãƒ»weather_locations: UNIQUE(latitude, longitude)                           â”‚
â”‚   ãƒ»weather_data: UNIQUE(weather_location_id, date)                          â”‚
â”‚                                                                              â”‚
â”‚   ãƒ‡ãƒ¼ã‚¿ä¾‹ï¼ˆåŒ—æµ·é“ãƒ»æœ­å¹Œï¼‰ï¼š                                                    â”‚
â”‚   ãƒ»weather_location_id: 1                                                   â”‚
â”‚   ãƒ»latitude: 43.0642, longitude: 141.3469                                   â”‚
â”‚   ãƒ»ãƒ‡ãƒ¼ã‚¿æœŸé–“: 2000-01-01 ï½ 2025-10-11                                      â”‚
â”‚   ãƒ»ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ç´„9,415ä»¶ï¼ˆ25å¹´Ã—365æ—¥ï¼‰                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ SELECT query
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      5. è¨ˆç”»ä½œæˆå‡¦ç†ã®é–‹å§‹                                     â”‚
â”‚                      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                     â”‚
â”‚                                                                              â”‚
â”‚           ğŸ¯ PublicPlansController#create                                    â”‚
â”‚        (app/controllers/public_plans_controller.rb)                          â”‚
â”‚                                                                              â”‚
â”‚   ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ï¼š                                                             â”‚
â”‚   ãƒ»æ ½åŸ¹åœ°åŸŸï¼ˆå‚ç…§è¾²å ´ï¼‰                                                        â”‚
â”‚   ãƒ»è¾²å ´ã‚µã‚¤ã‚ºï¼ˆé¢ç©ï¼‰                                                         â”‚
â”‚   ãƒ»æ ½åŸ¹ä½œç‰©ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰                                                      â”‚
â”‚              â†“                                                               â”‚
â”‚   CultivationPlanCreator.call                                                â”‚
â”‚   ãƒ»CultivationPlanä½œæˆ                                                       â”‚
â”‚   ãƒ»Fieldä½œæˆ                                                                 â”‚
â”‚   ãƒ»FieldCultivationä½œæˆ                                                      â”‚
â”‚              â†“                                                               â”‚
â”‚   OptimizeCultivationPlanJob.perform_later                                   â”‚
â”‚   ï¼ˆéåŒæœŸã§æœ€é©åŒ–å®Ÿè¡Œï¼‰                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Background Job
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    6. å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã¨å¤‰æ›                                   â”‚
â”‚                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                   â”‚
â”‚                                                                              â”‚
â”‚          ğŸ”„ CultivationPlanOptimizer#prepare_weather_data                    â”‚
â”‚              (app/services/cultivation_plan_optimizer.rb)                    â”‚
â”‚                                                                              â”‚
â”‚   ã‚¹ãƒ†ãƒƒãƒ—1: DBã‹ã‚‰éå»20å¹´åˆ†ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—                            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚   training_start_date = Date.current - 20.years  # 2005-10-12               â”‚
â”‚   training_end_date = Date.current - 1.day       # 2025-10-11               â”‚
â”‚                                                                              â”‚
â”‚   training_data = weather_location.weather_data_for_period(                  â”‚
â”‚     training_start_date, training_end_date                                   â”‚
â”‚   )                                                                          â”‚
â”‚                                                                              â”‚
â”‚   â†“ ç´„7,305ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆ20å¹´Ã—365æ—¥ï¼‰                                            â”‚
â”‚                                                                              â”‚
â”‚   ã‚¹ãƒ†ãƒƒãƒ—2: DBã‹ã‚‰ä»Šå¹´ã®å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚   current_year_start = Date.new(Date.current.year, 1, 1)  # 2025-01-01     â”‚
â”‚   current_year_end = Date.current - 1.day                  # 2025-10-11     â”‚
â”‚                                                                              â”‚
â”‚   current_year_data = weather_location.weather_data_for_period(              â”‚
â”‚     current_year_start, current_year_end                                     â”‚
â”‚   )                                                                          â”‚
â”‚                                                                              â”‚
â”‚   â†“ ç´„284ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆ2025å¹´1æœˆ1æ—¥ï½10æœˆ11æ—¥ï¼‰                                   â”‚
â”‚                                                                              â”‚
â”‚   ã‚¹ãƒ†ãƒƒãƒ—3: AGRRå½¢å¼ã«å¤‰æ›                                                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚   training_formatted = {                                                     â”‚
â”‚     'latitude' => 43.0642,                                                   â”‚
â”‚     'longitude' => 141.3469,                                                 â”‚
â”‚     'elevation' => 15.0,                                                     â”‚
â”‚     'timezone' => 'Asia/Tokyo',                                              â”‚
â”‚     'data' => [                                                              â”‚
â”‚       {                                                                      â”‚
â”‚         'time' => '2005-10-12',                                              â”‚
â”‚         'temperature_2m_max' => 18.5,                                        â”‚
â”‚         'temperature_2m_min' => 10.2,                                        â”‚
â”‚         'temperature_2m_mean' => 14.3,                                       â”‚
â”‚         'precipitation_sum' => 2.5,                                          â”‚
â”‚         'sunshine_duration' => 25200.0,  # 7æ™‚é–“Ã—3600ç§’                      â”‚
â”‚         'wind_speed_10m_max' => 3.2,                                         â”‚
â”‚         'weather_code' => 1                                                  â”‚
â”‚       },                                                                     â”‚
â”‚       ... (7,305ãƒ¬ã‚³ãƒ¼ãƒ‰)                                                    â”‚
â”‚     ]                                                                        â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â”‚   current_year_formatted = { ... }  # åŒæ§˜ã®æ§‹é€ ã§284ãƒ¬ã‚³ãƒ¼ãƒ‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ JSON data
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      7. ARIMAæ™‚ç³»åˆ—äºˆæ¸¬                                       â”‚
â”‚                      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                         â”‚
â”‚                                                                              â”‚
â”‚                  ğŸ”® agrr predict ã‚³ãƒãƒ³ãƒ‰                                     â”‚
â”‚           (Agrr::PredictionGateway#predict)                                  â”‚
â”‚                                                                              â”‚
â”‚   å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼š                                                                 â”‚
â”‚   ãƒ»éå»20å¹´åˆ†ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ï¼ˆ7,305æ—¥åˆ†ï¼‰                                 â”‚
â”‚   ãƒ»äºˆæ¸¬æ—¥æ•°: 365æ—¥ï¼ˆæ¥å¹´1å¹´é–“ï¼‰                                               â”‚
â”‚                                                                              â”‚
â”‚   å‡¦ç†ï¼š                                                                      â”‚
â”‚   1. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«JSONæ›¸ãè¾¼ã¿                                                â”‚
â”‚      write_temp_file(training_formatted)                                     â”‚
â”‚                                                                              â”‚
â”‚   2. agrrã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ                                                         â”‚
â”‚      agrr predict \                                                          â”‚
â”‚        --input /tmp/weather_input_xxx.json \                                 â”‚
â”‚        --output /tmp/weather_output_xxx.json \                               â”‚
â”‚        --days 365                                                            â”‚
â”‚                                                                              â”‚
â”‚   3. ARIMAãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹äºˆæ¸¬                                                    â”‚
â”‚      ãƒ»è‡ªå·±å›å¸°å’Œåˆ†ç§»å‹•å¹³å‡ãƒ¢ãƒ‡ãƒ«                                               â”‚
â”‚      ãƒ»å­£ç¯€æ€§ã‚’è€ƒæ…®ï¼ˆSARIMAï¼‰                                                  â”‚
â”‚      ãƒ»20å¹´åˆ†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ç¿’                                                â”‚
â”‚      ãƒ»æ¥å¹´365æ—¥åˆ†ã‚’äºˆæ¸¬                                                       â”‚
â”‚                                                                              â”‚
â”‚   4. äºˆæ¸¬çµæœã‚’JSONèª­ã¿è¾¼ã¿                                                   â”‚
â”‚      future_data = JSON.parse(output_file)                                   â”‚
â”‚                                                                              â”‚
â”‚   å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ï¼š                                                                 â”‚
â”‚   {                                                                          â”‚
â”‚     'data' => [                                                              â”‚
â”‚       {                                                                      â”‚
â”‚         'time' => '2025-10-12',  # æ˜æ—¥ã‹ã‚‰                                  â”‚
â”‚         'temperature_2m_max' => 17.8,                                        â”‚
â”‚         'temperature_2m_min' => 9.5,                                         â”‚
â”‚         'temperature_2m_mean' => 13.6,                                       â”‚
â”‚         'precipitation_sum' => 1.2,                                          â”‚
â”‚         'sunshine_duration' => 21600.0,                                      â”‚
â”‚         'wind_speed_10m_max' => 2.8,                                         â”‚
â”‚         'weather_code' => 1                                                  â”‚
â”‚       },                                                                     â”‚
â”‚       ... (365ãƒ¬ã‚³ãƒ¼ãƒ‰)                                                      â”‚
â”‚     ]                                                                        â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â”‚   â†“ æ¥å¹´365æ—¥åˆ†ã®äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Merge
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    8. ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ï¼ˆæœ€çµ‚ãƒ‡ãƒ¼ã‚¿ï¼‰                                â”‚
â”‚                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                   â”‚
â”‚                                                                              â”‚
â”‚          merge_weather_data(current_year_formatted, future)                  â”‚
â”‚                                                                              â”‚
â”‚   æœ€çµ‚çš„ãªå¤©æ°—ãƒ‡ãƒ¼ã‚¿ï¼ˆ2å¹´åˆ†ï¼‰ï¼š                                                 â”‚
â”‚   {                                                                          â”‚
â”‚     latitude: 43.0642,                                                       â”‚
â”‚     longitude: 141.3469,                                                     â”‚
â”‚     data: [                                                                  â”‚
â”‚       # ä»Šå¹´ã®å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆ2025/01/01 ï½ 2025/10/11ï¼‰                            â”‚
â”‚       { time: '2025-01-01', ... },  # 284æ—¥åˆ†                                â”‚
â”‚       { time: '2025-01-02', ... },                                           â”‚
â”‚       ...                                                                    â”‚
â”‚       { time: '2025-10-11', ... },                                           â”‚
â”‚                                                                              â”‚
â”‚       # æ¥å¹´ã®äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ï¼ˆ2025/10/12 ï½ 2026/10/11ï¼‰                          â”‚
â”‚       { time: '2025-10-12', ... },  # 365æ—¥åˆ†                                â”‚
â”‚       { time: '2025-10-13', ... },                                           â”‚
â”‚       ...                                                                    â”‚
â”‚       { time: '2026-10-11', ... }                                            â”‚
â”‚     ]                                                                        â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â”‚   åˆè¨ˆ: 284 + 365 = 649æ—¥åˆ†ï¼ˆç´„2å¹´åˆ†ï¼‰                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Weather data
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      9. ä½œä»˜ã‘è¨ˆç”»ã®æœ€é©åŒ–                                     â”‚
â”‚                      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                     â”‚
â”‚                                                                              â”‚
â”‚                  ğŸ¯ agrr optimize period ã‚³ãƒãƒ³ãƒ‰                             â”‚
â”‚           (Agrr::OptimizationGateway#optimize)                               â”‚
â”‚                                                                              â”‚
â”‚   å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼š                                                                 â”‚
â”‚   ãƒ»ä½œç‰©æƒ…å ±ï¼ˆcrop_name, varietyï¼‰                                            â”‚
â”‚   ãƒ»å¤©æ°—ãƒ‡ãƒ¼ã‚¿ï¼ˆ2å¹´åˆ†ã€649æ—¥ï¼‰                                                 â”‚
â”‚   ãƒ»åœƒå ´æƒ…å ±ï¼ˆfield_area, daily_fixed_costï¼‰                                  â”‚
â”‚   ãƒ»è©•ä¾¡æœŸé–“ï¼ˆevaluation_start, evaluation_endï¼‰                              â”‚
â”‚                                                                              â”‚
â”‚   å‡¦ç†ï¼š                                                                      â”‚
â”‚   1. ä½œç‰©ã®ç”Ÿè‚²è¦ä»¶ã‚’è€ƒæ…®                                                      â”‚
â”‚      ãƒ»æ¸©åº¦è¦ä»¶ï¼ˆæœ€é©æ¸©åº¦ã€é™ç•Œæ¸©åº¦ï¼‰                                           â”‚
â”‚      ãƒ»æ—¥ç…§è¦ä»¶                                                                â”‚
â”‚      ãƒ»ç”Ÿè‚²ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆæ’­ç¨®â†’åç©«ï¼‰                                               â”‚
â”‚                                                                              â”‚
â”‚   2. å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ç”Ÿè‚²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³                                     â”‚
â”‚      ãƒ»å„æ—¥ä»˜ã‚’æ’­ç¨®æ—¥ã¨ã—ã¦è©•ä¾¡                                                â”‚
â”‚      ãƒ»ç©ç®—æ¸©åº¦è¨ˆç®—                                                            â”‚
â”‚      ãƒ»æ—¥ç…§æ™‚é–“è©•ä¾¡                                                            â”‚
â”‚      ãƒ»åç©«æ—¥äºˆæ¸¬                                                              â”‚
â”‚                                                                              â”‚
â”‚   3. æœ€é©ãªä½œä»˜ã‘æœŸé–“ã‚’æ±ºå®š                                                   â”‚
â”‚      ãƒ»æœ€å°ã‚³ã‚¹ãƒˆã§æœ€å¤§åç›Š                                                    â”‚
â”‚      ãƒ»ãƒªã‚¹ã‚¯è©•ä¾¡                                                              â”‚
â”‚                                                                              â”‚
â”‚   å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ï¼š                                                                 â”‚
â”‚   {                                                                          â”‚
â”‚     'optimal_start_date' => '2025-04-15',                                    â”‚
â”‚     'optimal_end_date' => '2025-08-20',                                      â”‚
â”‚     'expected_yield' => 250.5,  # kg                                         â”‚
â”‚     'expected_revenue' => 125000,  # å††                                      â”‚
â”‚     'expected_cost' => 45000,  # å††                                          â”‚
â”‚     'expected_profit' => 80000,  # å††                                        â”‚
â”‚     'growth_stages' => [                                                     â”‚
â”‚       { name: 'æ’­ç¨®', start: '2025-04-15', end: '2025-04-20' },              â”‚
â”‚       { name: 'ç”Ÿè‚²', start: '2025-04-21', end: '2025-07-31' },              â”‚
â”‚       { name: 'åç©«', start: '2025-08-01', end: '2025-08-20' }               â”‚
â”‚     ]                                                                        â”‚
â”‚   }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Save result
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      10. çµæœã®ä¿å­˜ã¨è¡¨ç¤º                                      â”‚
â”‚                      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                     â”‚
â”‚                                                                              â”‚
â”‚   FieldCultivation#complete_with_result!(result)                             â”‚
â”‚                                                                              â”‚
â”‚   DBã«ä¿å­˜ï¼š                                                                  â”‚
â”‚   ãƒ»optimal_start_date                                                       â”‚
â”‚   ãƒ»optimal_end_date                                                         â”‚
â”‚   ãƒ»expected_yield                                                           â”‚
â”‚   ãƒ»expected_revenue                                                         â”‚
â”‚   ãƒ»expected_cost                                                            â”‚
â”‚   ãƒ»expected_profit                                                          â”‚
â”‚   ãƒ»growth_stages (JSON)                                                     â”‚
â”‚              â†“                                                               â”‚
â”‚   PublicPlansController#results                                              â”‚
â”‚   ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çµæœã‚’è¡¨ç¤º                                                         â”‚
â”‚   ãƒ»æœ€é©ãªä½œä»˜ã‘æœŸé–“                                                           â”‚
â”‚   ãƒ»äºˆæƒ³åé‡ãƒ»åç›Š                                                             â”‚
â”‚   ãƒ»ç”Ÿè‚²ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«                                                           â”‚
â”‚   ãƒ»åœƒå ´ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°èª¬æ˜

### 1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: Open-Meteo API ğŸŒ

**æ¦‚è¦:**
- ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®æ°—è±¡ãƒ‡ãƒ¼ã‚¿API
- 2000å¹´ä»¥é™ã®éå»ãƒ‡ãƒ¼ã‚¿ã‚’æä¾›
- ä¸–ç•Œä¸­ã®æ°—è±¡è¦³æ¸¬æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
- ç„¡æ–™ãƒ»å•†ç”¨åˆ©ç”¨å¯èƒ½

**æä¾›ãƒ‡ãƒ¼ã‚¿:**
- æ—¥æ¬¡æ°—è±¡ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€é«˜/æœ€ä½/å¹³å‡æ°—æ¸©ã€é™æ°´é‡ã€æ—¥ç…§æ™‚é–“ã€é¢¨é€Ÿã€å¤©æ°—ã‚³ãƒ¼ãƒ‰ï¼‰
- ç·¯åº¦çµŒåº¦ãƒ™ãƒ¼ã‚¹ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ»æ¨™é«˜æƒ…å ±ã‚‚å«ã‚€

### 2. ãƒ‡ãƒ¼ã‚¿å–å¾—: `agrr weather` ã‚³ãƒãƒ³ãƒ‰ ğŸ“¦

**å®Ÿè£…:**
- å®Ÿè¡Œå¯èƒ½ãƒã‚¤ãƒŠãƒªï¼ˆ`lib/core/agrr`ï¼‰
- Open-Meteo APIã«HTTPSãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- JSONå½¢å¼ã§å‡ºåŠ›

**ä½¿ç”¨ä¾‹:**
```bash
agrr weather --location 43.0642,141.3469 \
             --start-date 2005-01-01 \
             --end-date 2025-10-11 \
             --json
```

### 3. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å–å¾—: `FetchWeatherDataJob` ğŸ”„

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
- `app/jobs/fetch_weather_data_job.rb`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**
1. `agrr weather`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
2. JSONãƒ‘ãƒ¼ã‚¹ã¨æ¤œè¨¼
3. `WeatherLocation`ã®ä½œæˆ/å–å¾—
4. `WeatherDatum`ã‚’ä¸€æ‹¬ä¿å­˜ï¼ˆ`upsert_all`ï¼‰

**ç‰¹å¾´:**
- Solid Queueï¼ˆSQLiteãƒ™ãƒ¼ã‚¹ï¼‰ã§å®Ÿè¡Œ
- è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§5å›ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ã‚­ãƒƒãƒ—

**ãƒˆãƒªã‚¬ãƒ¼:**
- å‚ç…§è¾²å ´ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä½œæˆæ™‚ï¼ˆ`rails db:seed`ï¼‰
- æ‰‹å‹•å®Ÿè¡Œï¼ˆ`bin/fetch_reference_weather_data`ï¼‰
- APIçµŒç”±ï¼ˆ`/api/v1/internal/farms/:id/fetch_weather_data`ï¼‰

### 4. ãƒ‡ãƒ¼ã‚¿ä¿å­˜: SQLite Database ğŸ“

**ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ :**

#### `weather_locations` ãƒ†ãƒ¼ãƒ–ãƒ«
| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| id | integer | ä¸»ã‚­ãƒ¼ |
| latitude | decimal | ç·¯åº¦ |
| longitude | decimal | çµŒåº¦ |
| elevation | decimal | æ¨™é«˜ï¼ˆmï¼‰ |
| timezone | string | ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ |

- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:** `UNIQUE(latitude, longitude)`
- **é–¢ä¿‚:** `has_many :weather_data`

#### `weather_data` ãƒ†ãƒ¼ãƒ–ãƒ«
| ã‚«ãƒ©ãƒ  | å‹ | èª¬æ˜ |
|--------|-----|------|
| id | integer | ä¸»ã‚­ãƒ¼ |
| weather_location_id | integer | å¤–éƒ¨ã‚­ãƒ¼ |
| date | date | æ—¥ä»˜ |
| temperature_max | decimal | æœ€é«˜æ°—æ¸©ï¼ˆâ„ƒï¼‰ |
| temperature_min | decimal | æœ€ä½æ°—æ¸©ï¼ˆâ„ƒï¼‰ |
| temperature_mean | decimal | å¹³å‡æ°—æ¸©ï¼ˆâ„ƒï¼‰ |
| precipitation | decimal | é™æ°´é‡ï¼ˆmmï¼‰ |
| sunshine_hours | decimal | æ—¥ç…§æ™‚é–“ï¼ˆæ™‚é–“ï¼‰ |
| wind_speed | decimal | é¢¨é€Ÿï¼ˆm/sï¼‰ |
| weather_code | integer | å¤©æ°—ã‚³ãƒ¼ãƒ‰ |

- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:** `UNIQUE(weather_location_id, date)`
- **é–¢ä¿‚:** `belongs_to :weather_location`

**ãƒ‡ãƒ¼ã‚¿é‡ã®ä¾‹ï¼ˆå‚ç…§è¾²å ´47åœ°åŸŸï¼‰:**
- æœŸé–“: 2000å¹´ï½2025å¹´ï¼ˆç´„25å¹´ï¼‰
- 1åœ°åŸŸã‚ãŸã‚Š: ç´„9,125æ—¥ = 9,125ãƒ¬ã‚³ãƒ¼ãƒ‰
- å…¨47åœ°åŸŸ: ç´„428,875ãƒ¬ã‚³ãƒ¼ãƒ‰

### 5. è¨ˆç”»ä½œæˆé–‹å§‹: `PublicPlansController#create` ğŸ¯

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
- `app/controllers/public_plans_controller.rb`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåœ°åŸŸãƒ»ã‚µã‚¤ã‚ºãƒ»ä½œç‰©ã‚’é¸æŠ
2. `CultivationPlanCreator`ã§è¨ˆç”»ä½œæˆ
3. `OptimizeCultivationPlanJob`ã‚’éåŒæœŸå®Ÿè¡Œ

### 6. å¤©æ°—ãƒ‡ãƒ¼ã‚¿æº–å‚™: `CultivationPlanOptimizer` ğŸ”„

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
- `app/services/cultivation_plan_optimizer.rb`

**ãƒ‡ãƒ¼ã‚¿å–å¾—æˆ¦ç•¥ï¼ˆå¤‰æ›´å¾Œï¼‰:**

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—
```ruby
# éå»20å¹´åˆ†ï¼ˆARIMAãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ï¼‰
training_start_date = Date.current - 20.years  # 2005-10-12
training_end_date = Date.current - 1.day       # 2025-10-11
training_data = weather_location.weather_data_for_period(
  training_start_date, training_end_date
)
# â†’ ç´„7,305ãƒ¬ã‚³ãƒ¼ãƒ‰
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ä»Šå¹´ã®å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—
```ruby
# ä»Šå¹´1å¹´é–“ã®å®Ÿãƒ‡ãƒ¼ã‚¿
current_year_start = Date.new(Date.current.year, 1, 1)  # 2025-01-01
current_year_end = Date.current - 1.day                  # 2025-10-11
current_year_data = weather_location.weather_data_for_period(
  current_year_start, current_year_end
)
# â†’ ç´„284ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆ2025å¹´1æœˆ1æ—¥ï½10æœˆ11æ—¥ï¼‰
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: AGRRå½¢å¼ã«å¤‰æ›
```ruby
training_formatted = format_weather_data_for_agrr(weather_location, training_data)
current_year_formatted = format_weather_data_for_agrr(weather_location, current_year_data)
```

**å¤‰æ›å†…å®¹:**
- DBå½¢å¼ â†’ AGRR JSONå½¢å¼
- `sunshine_hours`ï¼ˆæ™‚é–“ï¼‰ â†’ `sunshine_duration`ï¼ˆç§’ï¼‰ã«å¤‰æ›

### 7. ARIMAæ™‚ç³»åˆ—äºˆæ¸¬: `agrr predict` ğŸ”®

**å®Ÿè£…:**
- `Agrr::PredictionGateway#predict`
- `app/gateways/agrr/prediction_gateway.rb`

**å‡¦ç†:**
```ruby
future = prediction_gateway.predict(
  historical_data: training_formatted,  # 20å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿
  days: 365                             # æ¥å¹´1å¹´é–“ã‚’äºˆæ¸¬
)
```

**agrrã‚³ãƒãƒ³ãƒ‰:**
```bash
agrr predict \
  --input /tmp/weather_input_xxx.json \
  --output /tmp/weather_output_xxx.json \
  --days 365
```

**ARIMAãƒ¢ãƒ‡ãƒ«:**
- **è‡ªå·±å›å¸°å’Œåˆ†ç§»å‹•å¹³å‡ãƒ¢ãƒ‡ãƒ«**
- å­£ç¯€æ€§ã‚’è€ƒæ…®ï¼ˆSARIMAï¼‰
- éå»20å¹´ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ç¿’
- æ¥å¹´365æ—¥åˆ†ã‚’äºˆæ¸¬

**äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿:**
- æœŸé–“: 2025å¹´10æœˆ12æ—¥ ï½ 2026å¹´10æœˆ11æ—¥
- ãƒ‡ãƒ¼ã‚¿æ•°: 365æ—¥åˆ†

### 8. ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸: ä»Šå¹´å®Ÿãƒ‡ãƒ¼ã‚¿ + æ¥å¹´äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ ğŸ“Š

**å®Ÿè£…:**
```ruby
merge_weather_data(current_year_formatted, future)
```

**æœ€çµ‚ãƒ‡ãƒ¼ã‚¿:**
```ruby
{
  latitude: 43.0642,
  longitude: 141.3469,
  data: [
    # ä»Šå¹´ã®å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆ2025/01/01 ï½ 2025/10/11ï¼‰
    { time: '2025-01-01', ... },  # 284æ—¥åˆ†
    ...
    { time: '2025-10-11', ... },
    
    # æ¥å¹´ã®äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ï¼ˆ2025/10/12 ï½ 2026/10/11ï¼‰
    { time: '2025-10-12', ... },  # 365æ—¥åˆ†
    ...
    { time: '2026-10-11', ... }
  ]
}
```

**åˆè¨ˆ: 284 + 365 = 649æ—¥åˆ†ï¼ˆç´„2å¹´åˆ†ï¼‰**

### 9. ä½œä»˜ã‘æœ€é©åŒ–: `agrr optimize period` ğŸ¯

**å®Ÿè£…:**
- `Agrr::OptimizationGateway#optimize`
- `app/gateways/agrr/optimization_gateway.rb`

**å…¥åŠ›:**
- ä½œç‰©æƒ…å ±ï¼ˆåå‰ã€å“ç¨®ï¼‰
- å¤©æ°—ãƒ‡ãƒ¼ã‚¿ï¼ˆ2å¹´åˆ†ã€649æ—¥ï¼‰
- åœƒå ´æƒ…å ±ï¼ˆé¢ç©ã€æ—¥æ¬¡å›ºå®šã‚³ã‚¹ãƒˆï¼‰
- è©•ä¾¡æœŸé–“ï¼ˆé–‹å§‹æ—¥ã€çµ‚äº†æ—¥ï¼‰

**å‡¦ç†:**
1. ä½œç‰©ã®ç”Ÿè‚²è¦ä»¶ã‚’è€ƒæ…®
   - æ¸©åº¦è¦ä»¶ï¼ˆæœ€é©æ¸©åº¦ã€é™ç•Œæ¸©åº¦ï¼‰
   - æ—¥ç…§è¦ä»¶
   - ç”Ÿè‚²ã‚¹ãƒ†ãƒ¼ã‚¸
2. å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã§ç”Ÿè‚²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   - å„æ—¥ä»˜ã‚’æ’­ç¨®æ—¥ã¨ã—ã¦è©•ä¾¡
   - ç©ç®—æ¸©åº¦è¨ˆç®—
   - æ—¥ç…§æ™‚é–“è©•ä¾¡
   - åç©«æ—¥äºˆæ¸¬
3. æœ€é©ãªä½œä»˜ã‘æœŸé–“ã‚’æ±ºå®š
   - æœ€å°ã‚³ã‚¹ãƒˆã§æœ€å¤§åç›Š
   - ãƒªã‚¹ã‚¯è©•ä¾¡

**å‡ºåŠ›:**
- æœ€é©ãªé–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥
- äºˆæƒ³åé‡ãƒ»åç›Šãƒ»ã‚³ã‚¹ãƒˆãƒ»åˆ©ç›Š
- ç”Ÿè‚²ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### 10. çµæœä¿å­˜ã¨è¡¨ç¤º ğŸ’¾

**ä¿å­˜:**
- `FieldCultivation#complete_with_result!(result)`
- DBã«æœ€é©åŒ–çµæœã‚’ä¿å­˜

**è¡¨ç¤º:**
- `PublicPlansController#results`
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«çµæœã‚’è¡¨ç¤º
  - æœ€é©ãªä½œä»˜ã‘æœŸé–“
  - äºˆæƒ³åé‡ãƒ»åç›Š
  - ç”Ÿè‚²ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  - åœƒå ´ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ•ãƒ­ãƒ¼

### å‚ç…§è¾²å ´ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿æ›´æ–°

**æ‰‹å‹•å®Ÿè¡Œ:**
```bash
# å…¨å‚ç…§è¾²å ´ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°
bin/fetch_reference_weather_data

# ç‰¹å®šã®è¾²å ´ã®ã¿
bin/fetch_reference_weather_data --farm-name "åŒ—æµ·é“ãƒ»æœ­å¹Œ"
```

**APIçµŒç”±:**
```bash
curl -X POST http://localhost:3000/api/v1/internal/farms/1/fetch_weather_data
```

**è‡ªå‹•åŒ–ï¼ˆæ¨å¥¨ï¼‰:**
- cron/systemdã‚¿ã‚¤ãƒãƒ¼ã§å®šæœŸå®Ÿè¡Œ
- æœˆ1å›ç¨‹åº¦ã®æ›´æ–°ã§ååˆ†

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿å®¹é‡ã¨æ€§èƒ½

### ãƒ‡ãƒ¼ã‚¿å®¹é‡
- 1ãƒ¬ã‚³ãƒ¼ãƒ‰: ç´„100ãƒã‚¤ãƒˆ
- 1åœ°åŸŸ25å¹´åˆ†: ç´„0.9MB
- 47åœ°åŸŸ25å¹´åˆ†: ç´„42MB
- **éå¸¸ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼**

### å–å¾—æ™‚é–“
- 1å¹´åˆ†ã®å–å¾—: ç´„2ï½3ç§’
- 20å¹´åˆ†ã®å–å¾—: ç´„40ï½60ç§’
- å…¨47åœ°åŸŸã®åˆå›å–å¾—: ç´„30ï½45åˆ†

### äºˆæ¸¬æ™‚é–“
- ARIMAäºˆæ¸¬ï¼ˆ365æ—¥ï¼‰: ç´„5ï½10ç§’
- æœ€é©åŒ–è¨ˆç®—: ç´„10ï½30ç§’/ä½œç‰©

## ğŸ¯ ã¾ã¨ã‚

ã“ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®ç‰¹å¾´ï¼š

1. **ä¿¡é ¼æ€§ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: Open-Meteo APIï¼ˆç„¡æ–™ãƒ»å•†ç”¨å¯ï¼‰
2. **åŠ¹ç‡çš„ãªå–å¾—**: ãƒã‚¤ãƒŠãƒªã‚³ãƒãƒ³ãƒ‰ + ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–
3. **ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªä¿å­˜**: SQLiteã§è»½é‡ãƒ»é«˜é€Ÿ
4. **é«˜åº¦ãªäºˆæ¸¬**: ARIMAæ™‚ç³»åˆ—ãƒ¢ãƒ‡ãƒ«ï¼ˆ20å¹´å­¦ç¿’ï¼‰
5. **å®Ÿç”¨çš„ãªè¨­è¨ˆ**: ä»Šå¹´å®Ÿãƒ‡ãƒ¼ã‚¿ + æ¥å¹´äºˆæ¸¬ = 2å¹´åˆ†

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¿¡é ¼æ€§ã®é«˜ã„å¤©æ°—äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€æœ€é©ãªä½œä»˜ã‘è¨ˆç”»ã‚’ç«‹ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

