<%# app/views/public_plans/results/_gantt_row.html.erb %>
<%# „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„ÅÆ1Ë°åÔºà1ÂúÉÂ†¥„Éª1‰ΩúÁâ©Ôºâ %>

<%
  # Helper methods
  def calculate_month_index(date, plan_start)
    return nil unless date
    ((date.year - plan_start.year) * 12) + date.month
  end
  
  def crop_class(crop_name)
    crop_name.to_s.parameterize
  end
  
  def crop_emoji(crop_name)
    emojis = {
      '„Éà„Éû„Éà' => 'üçÖ',
      '„Ç≠„É•„Ç¶„É™' => 'ü•í',
      '„Éä„Çπ' => 'üçÜ',
      '„Éî„Éº„Éû„É≥' => 'ü´ë',
      '„É¨„Çø„Çπ' => 'ü•¨',
      '„Ç≠„É£„Éô„ÉÑ' => 'ü•¨',
      '„Éã„É≥„Ç∏„É≥' => 'ü•ï',
      '„ÉÄ„Ç§„Ç≥„É≥' => 'ü•ï',
      '„Éõ„Ç¶„É¨„É≥„ÇΩ„Ç¶' => 'ü•¨',
      '„Ç§„ÉÅ„Ç¥' => 'üçì',
      '„É°„É≠„É≥' => 'üçà',
      '„Çπ„Ç§„Ç´' => 'üçâ',
      'Á±≥' => 'üåæ',
      'Â∞èÈ∫¶' => 'üåæ',
      'Â§ßË±Ü' => 'ü´ò'
    }
    emojis[crop_name.to_s] || 'üå±'
  end
  
  def render_stage_gradient(field_cultivation)
    # optimization_result „Åã„Çâ stages „ÇíÂèñÂæó
    stages = field_cultivation.optimization_result&.dig('raw', 'stages') || []
    return '' if stages.empty?
    
    # „Çπ„ÉÜ„Éº„Ç∏„Åî„Å®„ÅÆËâ≤
    stage_colors = {
      'Áô∫ËäΩ' => '#90EE90',
      'ÊàêÈï∑' => '#32CD32',
      'ÈñãËä±' => '#FFB6C1',
      'ÁµêÂÆü' => '#FF6347',
      'ÂèéÁ©´' => '#FFD700'
    }
    
    # ÂêÑ„Çπ„ÉÜ„Éº„Ç∏„ÅÆÂâ≤Âêà„ÇíË®àÁÆó
    total_days = field_cultivation.cultivation_days || 1
    gradients = stages.map do |stage|
      stage_name = stage['name'] || stage[:name]
      stage_days = stage['days'] || stage[:days] || 0
      percentage = (stage_days.to_f / total_days * 100).round(2)
      color = stage_colors[stage_name] || '#CCCCCC'
      "#{color} #{percentage}%"
    end
    
    "linear-gradient(90deg, #{gradients.join(', ')})"
  end
%>

<tr class="gantt-row" 
    data-field-cultivation-id="<%= field_cultivation.id %>"
    data-crop-name="<%= field_cultivation.crop_display_name %>"
    data-field-name="<%= field_cultivation.field_display_name %>">
  
  <%# Â∑¶ÂÅ¥„ÅÆÂõ∫ÂÆöÂàóÔºàÂúÉÂ†¥„Éª‰ΩúÁâ©ÊÉÖÂ†±Ôºâ %>
  <td class="gantt-sticky-col gantt-field-info">
    <div class="field-info-content">
      <div class="field-name">
        <span class="field-icon">üèûÔ∏è</span>
        <span class="field-text"><%= field_cultivation.field_display_name %></span>
      </div>
      <div class="crop-name">
        <span class="crop-icon"><%= crop_emoji(field_cultivation.crop_display_name) %></span>
        <span class="crop-text"><%= field_cultivation.crop_display_name %></span>
      </div>
      <div class="area-info">
        <%= number_with_delimiter(field_cultivation.area.to_i) %>„é°
      </div>
    </div>
  </td>
  
  <%# 24„É∂ÊúàÂàÜ„ÅÆ„Çª„É´ %>
  <% if field_cultivation.start_date && field_cultivation.completion_date %>
    <% 
      start_month = calculate_month_index(field_cultivation.start_date, plan_start_date)
      end_month = calculate_month_index(field_cultivation.completion_date, plan_start_date)
      duration_months = end_month - start_month + 1
    %>
    
    <%# Ê†ΩÂüπÈñãÂßãÂâç„ÅÆÁ©∫„Çª„É´ %>
    <% (1...start_month).each do %>
      <td class="gantt-empty-cell"></td>
    <% end %>
    
    <%# Ê†ΩÂüπÊúüÈñì„ÅÆ„Çª„É´ÔºàÁµêÂêàÔºâ %>
    <td colspan="<%= duration_months %>" 
        class="gantt-cultivation-bar <%= crop_class(field_cultivation.crop_display_name) %>"
        style="background: <%= render_stage_gradient(field_cultivation) %>;">
      <div class="bar-content">
        <div class="bar-dates">
          <span class="bar-start-date" title="Êí≠Á®ÆÊó•">
            <span class="date-marker">‚ñ≤</span>
            <span class="date-text"><%= field_cultivation.start_date.strftime('%-m/%-d') %></span>
          </span>
          <span class="bar-duration">
            <%= field_cultivation.cultivation_days %>Êó•
          </span>
          <span class="bar-end-date" title="ÂèéÁ©´Êó•">
            <span class="date-text"><%= field_cultivation.completion_date.strftime('%-m/%-d') %></span>
            <span class="date-marker">‚ñ≤</span>
          </span>
        </div>
      </div>
    </td>
    
    <%# Ê†ΩÂüπÁµÇ‰∫ÜÂæå„ÅÆÁ©∫„Çª„É´ %>
    <% ((end_month + 1)..24).each do %>
      <td class="gantt-empty-cell"></td>
    <% end %>
  <% else %>
    <%# „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà %>
    <% (1..24).each do %>
      <td class="gantt-empty-cell gantt-no-data"></td>
    <% end %>
  <% end %>
</tr>

