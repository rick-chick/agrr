<div class="form-card" 
     data-crop-fertilize-profile-form
     data-i18n-title="<%= t('crops.crop_fertilize_profiles.application.title') %>"
     data-i18n-remove-button="<%= t('crops.crop_fertilize_profiles.application.remove_button') %>"
     data-i18n-application-type-label="<%= t('crops.crop_fertilize_profiles.application.application_type_label') %>"
     data-i18n-application-type-prompt="<%= t('crops.crop_fertilize_profiles.application.application_type_prompt') %>"
     data-i18n-application-type-help="<%= t('crops.crop_fertilize_profiles.application.application_type_help') %>"
     data-i18n-basal="<%= t('crops.crop_fertilize_profiles.application.basal') %>"
     data-i18n-topdress="<%= t('crops.crop_fertilize_profiles.application.topdress') %>"
     data-i18n-count-label="<%= t('crops.crop_fertilize_profiles.application.count_label') %>"
     data-i18n-count-help="<%= t('crops.crop_fertilize_profiles.application.count_help') %>"
     data-i18n-schedule-hint-label="<%= t('crops.crop_fertilize_profiles.application.schedule_hint_label') %>"
     data-i18n-schedule-hint-placeholder="<%= t('crops.crop_fertilize_profiles.application.schedule_hint_placeholder') %>"
     data-i18n-schedule-hint-help="<%= t('crops.crop_fertilize_profiles.application.schedule_hint_help') %>"
     data-i18n-per-application-section="<%= t('crops.crop_fertilize_profiles.application.per_application_section') %>"
     data-i18n-per-application-help="<%= t('crops.crop_fertilize_profiles.application.per_application_help') %>"
     data-i18n-per-application-n-label="<%= t('crops.crop_fertilize_profiles.application.per_application_n_label') %>"
     data-i18n-per-application-p-label="<%= t('crops.crop_fertilize_profiles.application.per_application_p_label') %>"
     data-i18n-per-application-k-label="<%= t('crops.crop_fertilize_profiles.application.per_application_k_label') %>">
  <%= form_with(model: [@crop, @profile]) do |f| %>
    <% if @profile.errors.any? %>
      <div class="errors">
        <h3><%= t('crops.crop_fertilize_profiles.form.errors.title', count: @profile.errors.count) %></h3>
        <ul>
          <% @profile.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <button type="button" 
              id="ai-save-fertilize-profile-btn" 
              class="btn btn-ai" 
              data-controller="crop-fertilize-profile-ai"
              data-is-new-record="<%= @profile.new_record? %>"
              data-crop-id="<%= @crop.id %>"
              data-profile-id="<%= @profile.persisted? ? @profile.id : '' %>"
              data-enter-crop-name="<%= t('js.crop_fertilize_profile_ai.enter_crop_name', default: 'ä½œç‰©ã‚’é¸æŠžã—ã¦ãã ã•ã„') %>"
              data-fetching="<%= t('js.crop_fertilize_profile_ai.fetching', default: 'AIã§è‚¥æ–™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...') %>"
              data-button-fetching="<%= t('js.crop_fertilize_profile_ai.button_fetching', default: 'ðŸ¤– AIã§æƒ…å ±ã‚’å–å¾—ä¸­...') %>"
              data-created-success="<%= t('js.crop_fertilize_profile_ai.created_success', default: 'âœ“ è‚¥æ–™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ%{crop_name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼') %>"
              data-updated-success="<%= t('js.crop_fertilize_profile_ai.updated_success', default: 'âœ“ è‚¥æ–™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ%{crop_name}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼') %>"
              data-fetch-failed="<%= t('js.crop_fertilize_profile_ai.fetch_failed', default: 'è‚¥æ–™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ') %>"
              data-network-error="<%= t('js.crop_fertilize_profile_ai.network_error', default: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') %>"
              data-button-idle="<%= t('crops.crop_fertilize_profiles.form.ai_button', default: 'ðŸ¤– AIã§è‚¥æ–™æƒ…å ±ã‚’å–å¾—ãƒ»ä¿å­˜') %>">
      </button>
      <div id="ai-save-status" class="form-text d-none"></div>
      <div class="form-text"><%= t('crops.crop_fertilize_profiles.form.ai_help', default: 'ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€AIãŒã“ã®ä½œç‰©ã®è‚¥æ–™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è‡ªå‹•çš„ã«å–å¾—ã—ã¦ä¿å­˜ã—ã¾ã™') %></div>
    </div>

    <!-- AIå‡¦ç†ä¸­ã®åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="ad-popup-overlay" class="ad-popup-overlay">
      <div class="ad-popup-container">
        <div class="ad-popup-status">
          <div class="ad-popup-status-title">
            <%= t('crops.crop_fertilize_profiles.form.ai_processing_title', default: 'ðŸ¤– AIã§è‚¥æ–™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—ä¸­...') %>
          </div>
          <p class="ad-popup-status-message"><%= t('crops.crop_fertilize_profiles.form.ai_processing_message', default: 'ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¨è‚¥æ–™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°ç”»é¢ã«è‡ªå‹•ã§ç§»å‹•ã—ã¾ã™ã€‚') %></p>
        </div>

        <div class="ad-popup-progress">
          <p class="ad-popup-progress-text"><%= t('crops.crop_fertilize_profiles.form.ai_progress_text', default: 'AIå‡¦ç†ä¸­...') %></p>
          <div class="ad-popup-progress-bar">
            <div class="ad-popup-progress-fill"></div>
          </div>
        </div>
        
        <!-- Google AdSense åºƒå‘Š -->
        <%= render 'shared/adsense_display_ad', ad_slot: '0000000000', ad_format: 'rectangle' %>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :sources, t('crops.crop_fertilize_profiles.form.sources_label'), class: 'form-label' %>
      <% sources_value = @profile.sources.is_a?(Array) ? @profile.sources.join(', ') : (@profile.sources.to_s if @profile.sources.present?) %>
      <%= f.text_field :sources, value: sources_value, class: 'form-control', placeholder: t('crops.crop_fertilize_profiles.form.sources_placeholder') %>
      <div class="form-text"><%= t('crops.crop_fertilize_profiles.form.sources_help') %></div>
    </div>

    <div class="form-group">
      <%= f.label :notes, t('crops.crop_fertilize_profiles.form.notes_label'), class: 'form-label' %>
      <%= f.text_area :notes, rows: 4, class: 'form-control', placeholder: t('crops.crop_fertilize_profiles.form.notes_placeholder') %>
      <div class="form-text"><%= t('crops.crop_fertilize_profiles.form.notes_help') %></div>
    </div>

    <div class="form-section">
      <h3 class="section-title"><%= t('crops.crop_fertilize_profiles.form.applications_section_title') %></h3>
      
      <div id="crop-fertilize-applications">
        <%= f.fields_for :crop_fertilize_applications do |app_form| %>
          <%= render 'crop_fertilize_application_fields', f: app_form %>
        <% end %>
      </div>

      <div class="form-group">
        <button type="button" id="add-crop-fertilize-application" class="btn btn-secondary"><%= t('crops.crop_fertilize_profiles.form.add_application_button') %></button>
      </div>
    </div>

    <div class="actions">
      <%= f.submit t("crops.crop_fertilize_profiles.form.submit_#{@profile.new_record? ? 'create' : 'update'}"), class: 'btn btn-success' %>
      <%= link_to t('crops.crop_fertilize_profiles.form.cancel'), @profile.persisted? ? crop_crop_fertilize_profile_path(@crop, @profile) : crop_path(@crop), class: 'btn btn-secondary' %>
    </div>
  <% end %>
</div>

