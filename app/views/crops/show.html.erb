<% content_for :title, "#{@crop.name} - AGRR" %>

<div class="crop-detail-card">
  <div class="crop-detail-header">
    <h1 class="crop-detail-title"><%= @crop.name %></h1>
    <% if admin_user? && @crop.is_reference %>
      <div class="crop-detail-type reference"><%= t('.reference_crop') %></div>
    <% end %>
  </div>
  
  <div class="crop-basic-info">
    <div class="info-item">
      <span class="info-label">üìù <%= t('.name') %>:</span>
      <span class="info-value"><%= @crop.name %></span>
    </div>
    
    <% if @crop.variety.present? %>
      <div class="info-item">
        <span class="info-label">üå± <%= t('.variety') %>:</span>
        <span class="info-value"><%= @crop.variety %></span>
      </div>
    <% end %>
    
    <% if @crop.area_per_unit.present? %>
      <div class="info-item">
        <span class="info-label">üìè <%= t('.area_per_unit') %>:</span>
        <span class="info-value"><%= @crop.area_per_unit %> „é°</span>
      </div>
    <% end %>
    
    <% if @crop.revenue_per_area.present? %>
      <div class="info-item">
        <span class="info-label">üí∞ <%= t('.revenue_per_area') %>:</span>
        <span class="info-value"><%= number_to_currency(@crop.revenue_per_area, unit: '¬•', precision: 0) %>/„é°</span>
      </div>
    <% end %>
    
    <% if @crop.groups.present? %>
      <% groups_array = @crop.groups.is_a?(Array) ? @crop.groups : [@crop.groups] %>
      <% if groups_array.any? %>
        <div class="info-item">
          <span class="info-label">üè∑Ô∏è <%= t('.groups') %>:</span>
          <span class="info-value"><%= groups_array.join(', ') %></span>
        </div>
      <% end %>
    <% end %>
    
    <div class="info-item">
      <span class="info-label">üìÖ <%= t('.created_at') %>:</span>
      <span class="info-value"><%= I18n.l(@crop.created_at, format: :long) %></span>
    </div>
    
    <div class="info-item">
      <span class="info-label">üìÖ <%= t('.updated_at') %>:</span>
      <span class="info-value"><%= I18n.l(@crop.updated_at, format: :long) %></span>
    </div>
  </div>
  
  <div class="pests-section">
    <h2 class="stages-title"><%= t('.pests_title') %></h2>
    <% if @crop.pests.any? %>
      <div class="pests-list">
        <% @crop.pests.recent.each do |pest| %>
          <div class="pest-item">
            <div class="pest-name">
              <%= link_to pest.name, crop_pest_path(@crop, pest), class: "pest-link" %>
            </div>
            <% if pest.name_scientific.present? %>
              <div class="pest-scientific"><%= pest.name_scientific %></div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="no-pests">
        <p><%= t('.no_pests_description') %></p>
      </div>
    <% end %>
    <div class="pest-actions">
      <%= link_to t('.manage_pests'), crop_pests_path(@crop), class: "btn btn-secondary btn-sm" %>
    </div>
  </div>

  <div class="agricultural-tasks-section">
    <h2 class="stages-title">üîß <%= t('.agricultural_tasks_title') %></h2>
    <% if @viewable_agricultural_tasks.any? %>
      <div class="agricultural-tasks-list">
        <% @viewable_agricultural_tasks.each do |task| %>
          <div class="agricultural-task-item">
            <div class="agricultural-task-name">
              <%= link_to task.name, agricultural_task_path(task), class: "agricultural-task-link" %>
            </div>
            <% if task.description.present? %>
              <div class="agricultural-task-description"><%= truncate(task.description, length: 100) %></div>
            <% end %>
            <% if task.time_per_sqm.present? %>
              <div class="agricultural-task-time">‚è± <%= task.time_per_sqm %> h/„é°</div>
            <% end %>
            <% if task.is_reference %>
              <div class="agricultural-task-type reference">[<%= t('.reference_task') %>]</div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="no-agricultural-tasks">
        <p><%= t('.no_agricultural_tasks_description') %></p>
      </div>
    <% end %>
    <div class="agricultural-task-actions">
      <%= link_to t('.manage_agricultural_tasks'), crop_agricultural_tasks_path(@crop), class: "btn btn-secondary btn-sm" %>
    </div>
  </div>

  <div class="stages-section">
    <h2 class="stages-title"><%= t('.stages_title') %></h2>
    <% if @crop.crop_stages.any? %>
      <ol class="stages-list">
        <% @crop.crop_stages.order(:order).each do |stage| %>
          <li class="stage-item">
            <div class="stage-name"><%= stage.name %></div>
            <div class="stage-order"><%= t('.stage_order') %>: <%= stage.order %></div>
            
            <% if stage.temperature_requirement || stage.thermal_requirement || stage.sunshine_requirement || stage.nutrient_requirement %>
              <div class="stage-requirements">
                <% if stage.temperature_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">üå°Ô∏è <%= t('.temperature_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.base_temperature') %>: <%= stage.temperature_requirement.base_temperature %>¬∞C<br>
                      <%= t('.optimal_temperature') %>: <%= stage.temperature_requirement.optimal_min %>„Äú<%= stage.temperature_requirement.optimal_max %>¬∞C<br>
                      <%= t('.low_stress_threshold') %>: <%= stage.temperature_requirement.low_stress_threshold %>¬∞C<br>
                      <%= t('.high_stress_threshold') %>: <%= stage.temperature_requirement.high_stress_threshold %>¬∞C<br>
                      <%= t('.frost_threshold') %>: <%= stage.temperature_requirement.frost_threshold %>¬∞C<br>
                      <%= t('.sterility_risk_threshold') %>: <%= stage.temperature_requirement.sterility_risk_threshold %>¬∞C<br>
                      <%= t('.max_temperature') %>: <%= stage.temperature_requirement.max_temperature %>¬∞C
                    </div>
                  </div>
                <% end %>
                
                <% if stage.thermal_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">üå°Ô∏è <%= t('.thermal_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.required_gdd') %>: <%= stage.thermal_requirement.required_gdd %>¬∞C„ÉªÊó•
                    </div>
                  </div>
                <% end %>
                
                <% if stage.sunshine_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">‚òÄÔ∏è <%= t('.sunshine_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.minimum_sunshine_hours') %>: <%= stage.sunshine_requirement.minimum_sunshine_hours %>ÊôÇÈñì<br>
                      <%= t('.target_sunshine_hours') %>: <%= stage.sunshine_requirement.target_sunshine_hours %>ÊôÇÈñì
                    </div>
                  </div>
                <% end %>
                
                <% if stage.nutrient_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">üå± <%= t('.nutrient_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.daily_uptake_n') %>: <%= stage.nutrient_requirement.daily_uptake_n %> g/m¬≤/day<br>
                      <%= t('.daily_uptake_p') %>: <%= stage.nutrient_requirement.daily_uptake_p %> g/m¬≤/day<br>
                      <%= t('.daily_uptake_k') %>: <%= stage.nutrient_requirement.daily_uptake_k %> g/m¬≤/day
                    </div>
                  </div>
                <% end %>
                
              </div>
            <% end %>
          </li>
        <% end %>
      </ol>
    <% else %>
      <div class="no-stages">
        <div class="empty-state-icon">üå±</div>
        <h3><%= t('.no_stages_title') %></h3>
        <p><%= t('.no_stages_description') %></p>
      </div>
    <% end %>
  </div>
  
  <div class="actions">
    <%= link_to t('.back_to_list'), crops_path, class: "btn btn-secondary" %>
    <% if @crop.is_reference %>
      <%# ÂèÇÁÖß‰ΩúÁâ©„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÁ∑®ÈõÜ„ÉªÂâäÈô§ÂèØËÉΩ %>
      <% if admin_user? %>
        <%= link_to t('.edit'), edit_crop_path(@crop), class: "btn btn-secondary" %>
        <%= button_to t('.delete'), @crop, method: :delete, 
                    class: "btn btn-error", 
                    confirm: t('.confirm_delete') %>
      <% end %>
    <% else %>
      <%# „É¶„Éº„Ç∂„Éº‰ΩúÁâ©„ÅØÊâÄÊúâËÄÖ„ÅåÁ∑®ÈõÜ„ÉªÂâäÈô§ÂèØËÉΩ %>
      <%= link_to t('.edit'), edit_crop_path(@crop), class: "btn btn-secondary" %>
      <%= button_to t('.delete'), @crop, method: :delete, 
                  class: "btn btn-error", 
                  confirm: t('.confirm_delete') %>
    <% end %>
  </div>
</div>
