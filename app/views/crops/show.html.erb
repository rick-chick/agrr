<% content_for :title, "#{@crop.name} - AGRR" %>

<div class="crop-detail-card" id="<%= dom_id(@crop) %>" data-undo-delete-record>
  <div class="crop-detail-header">
    <h1 class="crop-detail-title"><%= @crop.name %></h1>
    <% if admin_user? && @crop.is_reference %>
      <div class="crop-detail-type reference"><%= t('.reference_crop') %></div>
    <% end %>
  </div>
  
  <div class="crop-basic-info">
    <div class="info-item">
      <span class="info-label">üìù <%= t('.name') %>:</span>
      <span class="info-value"><%= @crop.name %></span>
    </div>
    
    <% if @crop.variety.present? %>
      <div class="info-item">
        <span class="info-label">üå± <%= t('.variety') %>:</span>
        <span class="info-value"><%= @crop.variety %></span>
      </div>
    <% end %>
    
    <% if @crop.area_per_unit.present? %>
      <div class="info-item">
        <span class="info-label">üìè <%= t('.area_per_unit') %>:</span>
        <span class="info-value"><%= @crop.area_per_unit %> „é°</span>
      </div>
    <% end %>
    
    <% if @crop.revenue_per_area.present? %>
      <div class="info-item">
        <span class="info-label">üí∞ <%= t('.revenue_per_area') %>:</span>
        <span class="info-value"><%= number_to_currency(@crop.revenue_per_area, unit: '¬•', precision: 0) %>/„é°</span>
      </div>
    <% end %>
    
    <% if @crop.groups.present? %>
      <% groups_array = @crop.groups.is_a?(Array) ? @crop.groups : [@crop.groups] %>
      <% if groups_array.any? %>
        <div class="info-item">
          <span class="info-label">üè∑Ô∏è <%= t('.groups') %>:</span>
          <span class="info-value"><%= groups_array.join(', ') %></span>
        </div>
      <% end %>
    <% end %>
    
    <div class="info-item">
      <span class="info-label">üìÖ <%= t('.created_at') %>:</span>
      <span class="info-value"><%= I18n.l(@crop.created_at, format: :long) %></span>
    </div>
    
    <div class="info-item">
      <span class="info-label">üìÖ <%= t('.updated_at') %>:</span>
      <span class="info-value"><%= I18n.l(@crop.updated_at, format: :long) %></span>
    </div>
  </div>
  
  <div class="pests-section">
    <div class="pests-section__header">
      <h2 class="stages-title"><%= t('.pests_title') %></h2>
      <%= link_to t('.manage_pests'), crop_pests_path(@crop), class: "btn btn-secondary btn-sm pests-section__action" %>
    </div>
    <% if @crop.pests.any? %>
      <div class="pests-grid">
        <% @crop.pests.recent.each do |pest| %>
          <article class="pest-card">
            <header class="pest-card__header">
              <h3 class="pest-card__name">
                <%= link_to pest.name, crop_pest_path(@crop, pest), class: "pest-card__link" %>
              </h3>
              <% if pest.name_scientific.present? %>
                <div class="pest-card__scientific"><%= pest.name_scientific %></div>
              <% end %>
            </header>

            <% if pest.family.present? || pest.order.present? || pest.occurrence_season.present? %>
              <ul class="pest-card__meta">
                <% if pest.family.present? %>
                  <li>
                    <span class="pest-card__meta-label"><%= t('.pest_family_label') %></span>
                    <span class="pest-card__meta-value"><%= pest.family %></span>
                  </li>
                <% end %>
                <% if pest.order.present? %>
                  <li>
                    <span class="pest-card__meta-label"><%= t('.pest_order_label') %></span>
                    <span class="pest-card__meta-value"><%= pest.order %></span>
                  </li>
                <% end %>
                <% if pest.occurrence_season.present? %>
                  <li>
                    <span class="pest-card__meta-label"><%= t('.pest_occurrence_label') %></span>
                    <span class="pest-card__meta-value"><%= pest.occurrence_season %></span>
                  </li>
                <% end %>
              </ul>
            <% end %>

          </article>
        <% end %>
      </div>
    <% else %>
      <div class="no-pests">
        <p><%= t('.no_pests_description') %></p>
      </div>
    <% end %>
  </div>

  <div class="task-schedule-blueprints-section" id="crop-task-schedule-blueprints">
    <div class="task-schedule-blueprints__header">
      <h2 class="stages-title"><%= t('.task_schedule_blueprints_title') %></h2>
      <% if admin_user? %>
        <div class="task-schedule-blueprints__actions">
          <%= button_to t('.generate_task_schedule_blueprints_button'),
                        generate_task_schedule_blueprints_crop_path(@crop),
                        method: :post,
                        class: 'btn btn-primary btn-sm task-schedule-blueprints__secondary-action',
                        form: { data: { turbo_confirm: t('.generate_task_schedule_blueprints_confirm') } } %>
        </div>
      <% end %>
    </div>
    <p class="task-schedule-blueprints-description">
      <%= t('.task_schedule_blueprints_description_html').html_safe %>
    </p>
    <% if @task_schedule_blueprints.any? %>
      <% sorted_blueprints = @task_schedule_blueprints.includes(:agricultural_task).sort_by do |blueprint|
           [blueprint.gdd_trigger.to_f, blueprint.priority.to_i, blueprint.id]
         end %>

      <% crop_required_gdd_values = @crop.crop_stages.map { |stage| stage.thermal_requirement&.required_gdd.to_f }.compact %>
      <% total_required_gdd = crop_required_gdd_values.sum %>
      <% blueprint_gdd_max = sorted_blueprints.map { |bp| bp.gdd_trigger.to_f }.max %>
      <% total_required_gdd = blueprint_gdd_max if total_required_gdd <= 0 %>
      <% total_required_gdd = 1.0 if total_required_gdd.nil? || total_required_gdd <= 0 %>
      <% lane_count = sorted_blueprints.size %>

      <div class="task-schedule-blueprints-board" style="--lane-count: <%= lane_count %>;">
        <div class="task-board-canvas">
          <div class="task-board-grid"></div>
          <div class="task-board-axis-x-scale">
            <span class="task-board-axis-x-tick" style="--tick-position: 0%;">0</span>
            <span class="task-board-axis-x-tick" style="--tick-position: 100%;">
              <%= number_with_precision(total_required_gdd, precision: 0) %>
            </span>
          </div>
          <div class="task-board-cards">
            <% sorted_blueprints.each_with_index do |blueprint, index| %>
              <% gdd_ratio = (blueprint.gdd_trigger.to_f / total_required_gdd).clamp(0.0, 1.0) %>
              <% left_percent = (gdd_ratio * 100).clamp(8.0, 95.0) %>
              <% lane_position = ((index + 0.5) / lane_count) * 100 %>
              <% top_percent = lane_position %>

              <% card_tooltip = [
                   t('.task_schedule_blueprints_order_tooltip', order: index + 1),
                   "#{t('.gdd_trigger')} #{number_with_precision(blueprint.gdd_trigger, precision: 1)}"
                 ].compact.join(' / ') %>

              <div class="task-blueprint-card blueprint-<%= blueprint.task_type %>"
                   data-gdd-trigger="<%= number_with_precision(blueprint.gdd_trigger, precision: 1) %>"
                   data-order="<%= index + 1 %>"
                   title="<%= card_tooltip %>"
                   style="--card-left: <%= left_percent.round(2) %>%; --card-top: <%= top_percent.round(2) %>%;">
                <div class="task-blueprint-card__title">
                  <%= blueprint.agricultural_task&.name || blueprint.description || blueprint.stage_name || t('.task_schedule_blueprints_missing_task') %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        <div class="task-board-axis-label task-board-axis-label-x">
          <span><%= t('.task_schedule_blueprints_axis_gdd_total', total: number_with_precision(total_required_gdd, precision: 0)) %></span>
        </div>
      </div>
    <% else %>
      <div class="no-task-schedule-blueprints">
        <p><%= t('.no_task_schedule_blueprints') %></p>
      </div>
    <% end %>

    <% if @available_agricultural_tasks.any? %>
      <div class="task-manual-section" id="available-task-templates">
        <div class="task-manual-section__header">
          <h3 class="task-manual-section__title"><%= t('.available_task_templates_title') %></h3>
          <span class="task-manual-section__count">
            <%= t('.available_task_count', count: @available_agricultural_tasks.size) %>
          </span>
        </div>
        <div class="task-manual-grid">
          <% @available_agricultural_tasks.each do |task| %>
            <% is_selected = @selected_task_ids.include?(task.id) %>
            <%= form_with url: toggle_task_template_crop_path(@crop, agricultural_task_id: task.id),
                          method: :post,
                          class: "task-manual-card #{'task-manual-card--selected' if is_selected}",
                          data: { turbo: true } do |f| %>
              <%= f.button type: :submit, class: "task-manual-card__button" do %>
                <article class="task-manual-card__content">
                  <h4 class="task-manual-card__name">
                    <span><%= task.name %></span>
                    <% if is_selected %>
                      <span class="task-manual-card__selected-badge">‚úì</span>
                    <% end %>
                  </h4>
                  <p class="task-manual-card__note">
                    <%= task.description.present? ? truncate(task.description, length: 80) : t('.manual_task_hint') %>
                  </p>
                </article>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="stages-section">
    <h2 class="stages-title"><%= t('.stages_title') %></h2>
    <% if @crop.crop_stages.any? %>
      <ol class="stages-list">
        <% @crop.crop_stages.order(:order).each do |stage| %>
          <li class="stage-item">
            <div class="stage-name"><%= stage.name %></div>
            <div class="stage-order"><%= t('.stage_order') %>: <%= stage.order %></div>
            
            <% if stage.temperature_requirement || stage.thermal_requirement || stage.sunshine_requirement || stage.nutrient_requirement %>
              <div class="stage-requirements">
                <% if stage.temperature_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">üå°Ô∏è <%= t('.temperature_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.base_temperature') %>: <%= stage.temperature_requirement.base_temperature %>¬∞C<br>
                      <%= t('.optimal_temperature') %>: <%= stage.temperature_requirement.optimal_min %>„Äú<%= stage.temperature_requirement.optimal_max %>¬∞C<br>
                      <%= t('.low_stress_threshold') %>: <%= stage.temperature_requirement.low_stress_threshold %>¬∞C<br>
                      <%= t('.high_stress_threshold') %>: <%= stage.temperature_requirement.high_stress_threshold %>¬∞C<br>
                      <%= t('.frost_threshold') %>: <%= stage.temperature_requirement.frost_threshold %>¬∞C<br>
                      <%= t('.sterility_risk_threshold') %>: <%= stage.temperature_requirement.sterility_risk_threshold %>¬∞C<br>
                      <%= t('.max_temperature') %>: <%= stage.temperature_requirement.max_temperature %>¬∞C
                    </div>
                  </div>
                <% end %>
                
                <% if stage.thermal_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">üå°Ô∏è <%= t('.thermal_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.required_gdd') %>: <%= stage.thermal_requirement.required_gdd %>¬∞C„ÉªÊó•
                    </div>
                  </div>
                <% end %>
                
                <% if stage.sunshine_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">‚òÄÔ∏è <%= t('.sunshine_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.minimum_sunshine_hours') %>: <%= stage.sunshine_requirement.minimum_sunshine_hours %>ÊôÇÈñì<br>
                      <%= t('.target_sunshine_hours') %>: <%= stage.sunshine_requirement.target_sunshine_hours %>ÊôÇÈñì
                    </div>
                  </div>
                <% end %>
                
                <% if stage.nutrient_requirement %>
                  <div class="requirement-item">
                    <div class="requirement-label">üå± <%= t('.nutrient_requirement') %></div>
                    <div class="requirement-value">
                      <%= t('.daily_uptake_n') %>: <%= stage.nutrient_requirement.daily_uptake_n %> g/m¬≤/day<br>
                      <%= t('.daily_uptake_p') %>: <%= stage.nutrient_requirement.daily_uptake_p %> g/m¬≤/day<br>
                      <%= t('.daily_uptake_k') %>: <%= stage.nutrient_requirement.daily_uptake_k %> g/m¬≤/day
                    </div>
                  </div>
                <% end %>
                
              </div>
            <% end %>
          </li>
        <% end %>
      </ol>
    <% else %>
      <div class="no-stages">
        <div class="empty-state-icon">üå±</div>
        <h3><%= t('.no_stages_title') %></h3>
        <p><%= t('.no_stages_description') %></p>
      </div>
    <% end %>
  </div>
  
  <div class="actions">
    <%= link_to t('.back_to_list'), crops_path, class: "btn btn-secondary" %>
    <% if @crop.is_reference %>
      <%# ÂèÇÁÖß‰ΩúÁâ©„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÁ∑®ÈõÜ„ÉªÂâäÈô§ÂèØËÉΩ %>
      <% if admin_user? %>
        <%= link_to t('.edit'), edit_crop_path(@crop), class: "btn btn-secondary" %>
        <%= link_to t('.delete'), crop_path(@crop),
                    class: "btn btn-error",
                    data: {
                      controller: "undo-delete",
                      action: "click->undo-delete#submit",
                      turbo_method: :delete,
                      undo_delete_url_value: crop_path(@crop),
                      undo_delete_message_value: t('crops.undo.toast', name: @crop.name),
                      undo_delete_redirect_url_value: crops_path
                    } %>
      <% end %>
    <% else %>
      <%# „É¶„Éº„Ç∂„Éº‰ΩúÁâ©„ÅØÊâÄÊúâËÄÖ„ÅåÁ∑®ÈõÜ„ÉªÂâäÈô§ÂèØËÉΩ %>
      <%= link_to t('.edit'), edit_crop_path(@crop), class: "btn btn-secondary" %>
      <%= link_to t('.delete'), crop_path(@crop),
                  class: "btn btn-error",
                  data: {
                    controller: "undo-delete",
                    action: "click->undo-delete#submit",
                    turbo_method: :delete,
                    undo_delete_url_value: crop_path(@crop),
                    undo_delete_message_value: t('crops.undo.toast', name: @crop.name),
                    undo_delete_redirect_url_value: crops_path
                  } %>
    <% end %>
  </div>
</div>
