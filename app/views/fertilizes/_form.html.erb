<div class="form-card">
  <%= form_with(model: @fertilize) do |f| %>
    <% if @fertilize.errors.any? %>
      <div class="errors">
        <h3><%= t('fertilizes.form.errors.title', count: @fertilize.errors.count) %></h3>
        <ul>
          <% @fertilize.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= f.label :name, t('fertilizes.form.name_label'), class: 'form-label' %>
      <%= f.text_field :name, required: true, class: 'form-control' %>
    </div>

    <div class="form-group">
      <button type="button" id="ai-save-fertilize-btn" class="btn btn-ai" 
              data-controller="fertilize-ai"
              data-is-new-record="<%= @fertilize.new_record? %>"
              data-fertilize-id="<%= @fertilize.persisted? ? @fertilize.id : '' %>"
              data-enter-name="<%= t('js.fertilize_ai.enter_name') %>"
              data-fetching="<%= t('js.fertilize_ai.fetching') %>"
              data-button-fetching="<%= t('js.fertilize_ai.button_fetching') %>"
              data-created-success="<%= t('js.fertilize_ai.created_success', name: '%{name}') %>"
              data-updated-success="<%= t('js.fertilize_ai.updated_success', name: '%{name}') %>"
              data-fetch-failed="<%= t('js.fertilize_ai.fetch_failed') %>"
              data-network-error="<%= t('js.fertilize_ai.network_error') %>"
              data-button-idle="<%= t('fertilizes.form.ai_button') %>">
      </button>
      <div id="ai-save-status" class="form-text d-none"></div>
      <div class="form-text"><%= t('fertilizes.form.ai_help') %></div>
    </div>

    <!-- AI処理中の広告ポップアップ -->
    <div id="ad-popup-overlay" class="ad-popup-overlay">
      <div class="ad-popup-container">
        <div class="ad-popup-status">
          <div class="ad-popup-status-title">
            <%= t('fertilizes.form.ai_processing_title') %>
          </div>
          <p class="ad-popup-status-message"><%= t('fertilizes.form.ai_processing_message') %></p>
        </div>

        <div class="ad-popup-progress">
          <p class="ad-popup-progress-text"><%= t('fertilizes.form.ai_progress_text') %></p>
          <div class="ad-popup-progress-bar">
            <div class="ad-popup-progress-fill"></div>
          </div>
        </div>
        
        <!-- Google AdSense 広告 -->
        <%= render 'shared/adsense_display_ad', ad_slot: '0000000000', ad_format: 'rectangle' %>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :n, t('fertilizes.form.n_label'), class: 'form-label' %>
      <%= f.number_field :n, step: :any, class: 'form-control' %>
      <div class="form-text"><%= t('fertilizes.form.n_help') %></div>
    </div>

    <div class="form-group">
      <%= f.label :p, t('fertilizes.form.p_label'), class: 'form-label' %>
      <%= f.number_field :p, step: :any, class: 'form-control' %>
      <div class="form-text"><%= t('fertilizes.form.p_help') %></div>
    </div>

    <div class="form-group">
      <%= f.label :k, t('fertilizes.form.k_label'), class: 'form-label' %>
      <%= f.number_field :k, step: :any, class: 'form-control' %>
      <div class="form-text"><%= t('fertilizes.form.k_help') %></div>
    </div>

    <div class="form-group">
      <%= f.label :description, t('fertilizes.form.description_label'), class: 'form-label' %>
      <%= f.text_area :description, rows: 4, class: 'form-control' %>
      <div class="form-text"><%= t('fertilizes.form.description_help') %></div>
    </div>

    <div class="form-group">
      <%= f.label :package_size, t('fertilizes.form.package_size_label'), class: 'form-label' %>
      <div class="input-group">
        <%= f.number_field :package_size, step: :any, min: 0, class: 'form-control' %>
        <span class="input-group-text">kg</span>
      </div>
      <div class="form-text"><%= t('fertilizes.form.package_size_help') %></div>
    </div>

    <% if admin_user? %>
      <div class="form-group">
        <div class="checkbox-group">
          <%= f.check_box :is_reference, class: 'form-control' %>
          <%= f.label :is_reference, t('fertilizes.form.is_reference_label'), class: 'form-label' %>
        </div>
      </div>
    <% end %>

    <div class="actions">
      <%= f.submit t("fertilizes.form.submit_#{@fertilize.new_record? ? 'create' : 'update'}"), class: 'btn btn-success' %>
      <%= link_to t('fertilizes.form.cancel'), @fertilize.persisted? ? fertilize_path(@fertilize) : fertilizes_path, class: 'btn btn-secondary' %>
    </div>
  <% end %>
</div>

