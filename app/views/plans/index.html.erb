<% content_for :title, t('plans.index.title') %>

<div class="plans-wrapper">
  <div class="plans-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="plans-header">
      <div class="plans-header-main">
        <div>
          <h1 class="plans-header-title">
            <%= t('plans.index.title') %>
          </h1>
          <p class="plans-header-subtitle">
            <%= t('plans.index.subtitle') %>
          </p>
        </div>
        <div>
          <%= link_to new_plan_path, class: "btn-plans-primary" do %>
            <%= t('plans.index.create_new') %>
          <% end %>
        </div>
      </div>
    </div>

    <% if @vm.plans_by_year.empty? %>
      <!-- è¨ˆç”»ãŒãªã„å ´åˆ -->
      <div class="plans-empty">
        <div class="plans-empty-icon">ðŸ“…</div>
        <h2 class="plans-empty-title">
          <%= t('plans.index.no_plans') %>
        </h2>
        <p class="plans-empty-subtitle">
          <%= t('plans.index.no_plans_hint') %>
        </p>
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; justify-content: center;">
          <%= link_to new_plan_path, class: "btn-plans-primary" do %>
            <%= t('plans.index.create_new') %>
          <% end %>
          <%= link_to public_plans_path, class: "btn-plans-primary", style: "background-color: var(--color-primary-light);" do %>
            <%= t('plans.index.try_public_plans') %>
          <% end %>
        </div>
      </div>
    <% else %>
        <!-- å¹´åº¦åˆ¥ã®è¨ˆç”»ä¸€è¦§ -->
        <% @vm.available_years.reverse.each_with_index do |year, index| %>
          <% year_plans = @vm.plans_by_year[year] %>

          <div class="plans-year-section">
            <details open>
              <summary class="plans-year-title" style="cursor: pointer; user-select: none; list-style: none; display: flex; align-items: center; gap: var(--space-2);">
                <span class="year-toggle-icon" style="transition: transform 0.2s;">â–¼</span>
                <%= t('plans.index.year_label', year: year) %>
                <% if year_plans.present? %>
                  <span style="font-size: var(--font-size-sm); color: var(--text-secondary); font-weight: normal;">
                    (<%= year_plans.count %>ä»¶)
                  </span>
                <% end %>
              </summary>
            
            <div class="plans-year-content" style="margin-top: var(--space-4);">
              <% if year_plans.present? %>
                  <div class="plans-grid">
                  <% year_plans.each do |plan| %>
                      <div class="plan-card" id="<%= dom_id(plan) %>" data-undo-delete-record>
                      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ -->
                      <div class="plan-card-header">
                        <span class="plan-card-status <%= plan.status %>">
                          <%= t("plans.index.status.#{plan.status}") %>
                        </span>
                      </div>
                      
                      <!-- è¨ˆç”»å -->
                      <h3 class="plan-card-title">
                        <%= plan.display_name %>
                      </h3>
                      
                      <!-- è¾²å ´æƒ…å ± -->
                      <div class="plan-card-details">
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-label"><%= t('plans.index.plan_card.farm') %>:</span>
                          <span><%= plan.farm.display_name %></span>
                        </div>
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-label"><%= t('plans.index.plan_card.total_area') %>:</span>
                          <span><%= number_with_delimiter(plan.total_area) %> ãŽ¡</span>
                        </div>
                        <div class="plan-card-detail-item">
                          <span><%= t('plans.index.plan_card.crops_count', count: @vm.crops_count(plan)) %></span>
                          <span>ãƒ»</span>
                          <span><%= t('plans.index.plan_card.fields_count', count: @vm.fields_count(plan)) %></span>
                        </div>
                      </div>
                      
                      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                      <div class="plan-card-actions">
                        <% if plan.status_completed? %>
                          <%= link_to t('plans.index.plan_card.view'), plan_path(plan), 
                              class: "plan-card-action-btn primary" %>
                            <%= link_to t('plans.index.plan_card.delete'), plan_path(plan),
                                class: "plan-card-action-btn danger",
                                data: {
                                  controller: "undo-delete",
                                  action: "click->undo-delete#submit",
                                  turbo_method: :delete,
                                  undo_delete_url_value: plan_path(plan),
                                  undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                  undo_delete_redirect_url_value: plans_path
                                } %>
                        <% elsif plan.status_optimizing? %>
                          <%= link_to t('plans.index.plan_card.view'), optimizing_plan_path(plan), 
                              class: "plan-card-action-btn primary" %>
                            <%= link_to t('plans.index.plan_card.delete'), plan_path(plan),
                                class: "plan-card-action-btn danger",
                                data: {
                                  controller: "undo-delete",
                                  action: "click->undo-delete#submit",
                                  turbo_method: :delete,
                                  undo_delete_url_value: plan_path(plan),
                                  undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                  undo_delete_redirect_url_value: plans_path
                                } %>
                        <% elsif plan.status_pending? %>
                          <%= link_to t('plans.index.plan_card.view'), plan_path(plan), 
                              class: "plan-card-action-btn primary" %>
                            <%= link_to t('plans.index.plan_card.delete'), plan_path(plan),
                                class: "plan-card-action-btn danger",
                                data: {
                                  controller: "undo-delete",
                                  action: "click->undo-delete#submit",
                                  turbo_method: :delete,
                                  undo_delete_url_value: plan_path(plan),
                                  undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                  undo_delete_redirect_url_value: plans_path
                                } %>
                        <% else %>
                            <%= link_to t('plans.index.plan_card.delete'), plan_path(plan),
                                class: "plan-card-action-btn danger",
                                data: {
                                  controller: "undo-delete",
                                  action: "click->undo-delete#submit",
                                  turbo_method: :delete,
                                  undo_delete_url_value: plan_path(plan),
                                  undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                  undo_delete_redirect_url_value: plans_path
                                } %>
                        <% end %>
                      </div>
                      
                      <!-- ä½œæˆæ—¥ -->
                      <div class="plan-card-meta">
                        <%= t('plans.index.plan_card.created_at') %>: <%= l(plan.created_at, format: :short) %>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <!-- ãã®å¹´åº¦ã«è¨ˆç”»ãŒãªã„å ´åˆ -->
                <div class="content-card">
                  <p style="text-align: center; color: var(--text-secondary);">
                    <%= t('plans.index.no_plans') %>
                  </p>
                </div>
              <% end %>
            </div>
          </details>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
