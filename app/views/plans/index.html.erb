<% content_for :title, t('plans.index.title') %>

<div class="plans-wrapper">
  <div class="plans-container">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="page-header">
      <div>
        <h1 class="page-title">
          <%= t('plans.index.title') %>
        </h1>
        <p class="page-subtitle" style="font-size: var(--font-size-base); color: var(--text-secondary); margin: var(--space-2) 0 0 0;">
          <%= t('plans.index.subtitle') %>
        </p>
      </div>
      <div>
        <%= link_to new_plan_path, class: "btn btn-primary" do %>
          <%= t('plans.index.create_new') %>
        <% end %>
      </div>
    </div>

    <% if @plans_by_farm.empty? %>
      <!-- Ë®àÁîª„Åå„Å™„ÅÑÂ†¥Âêà -->
      <div class="plans-empty">
        <div class="plans-empty-icon">üìÖ</div>
        <h2 class="plans-empty-title">
          <%= t('plans.index.no_plans') %>
        </h2>
        <p class="plans-empty-subtitle">
          <%= t('plans.index.no_plans_hint') %>
        </p>
        <div class="plans-empty-actions">
          <%= link_to new_plan_path, class: "btn btn-primary" do %>
            <%= t('plans.index.create_new') %>
          <% end %>
          <%= link_to public_plans_path, class: "btn btn-ghost" do %>
            <%= t('plans.index.try_public_plans') %>
          <% end %>
        </div>
      </div>
    <% else %>
        <!-- Ëæ≤Â†¥Âà•„ÅÆË®àÁîª‰∏ÄË¶ß -->
        <% @plans_by_farm.each_with_index do |(farm_id, farm_plans), index| %>
          <% farm = farm_plans.first.farm %>

          <div class="plans-farm-section">
            <details <%= 'open' if index == 0 %>>
              <summary class="plans-farm-title plans-farm-summary">
                <span class="farm-toggle-icon"></span>
                <span class="plans-farm-label"><%= farm.display_name %></span>
                <% if farm_plans.present? %>
                  <span class="farm-count">
                    (<%= farm_plans.count %>‰ª∂)
                  </span>
                <% else %>
                  <span class="farm-count farm-count-empty">
                    (Ë®àÁîª„Å™„Åó)
                  </span>
                <% end %>
              </summary>
            
            <div class="plans-farm-content">
              <% if farm_plans.present? %>
                  <div class="plans-grid">
                  <% farm_plans.each do |plan| %>
                      <div class="plan-card" id="<%= dom_id(plan) %>" data-undo-delete-record>
                      <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏ -->
                      <div class="plan-card-header">
                        <span class="plan-card-status <%= plan.status %>">
                          <%= t("plans.index.status.#{plan.status}") %>
                        </span>
                      </div>
                      
                      <!-- Ë®àÁîªÂêç -->
                      <h3 class="plan-card-title">
                        <%= plan.display_name %>
                      </h3>
                      
                      <!-- Ë®àÁîªÊúüÈñì -->
                      <% if plan.planning_start_date && plan.planning_end_date %>
                        <div class="plan-card-details">
                          <div class="plan-card-detail-item">
                            <span class="plan-card-detail-icon">üìÖ</span>
                            <span class="plan-card-detail-label">Ë®àÁîªÊúüÈñì:</span>
                            <span><%= l(plan.planning_start_date, format: :short) %> „Äú <%= l(plan.planning_end_date, format: :short) %></span>
                          </div>
                        </div>
                      <% end %>
                      
                      <!-- Ëæ≤Â†¥ÊÉÖÂ†± -->
                      <div class="plan-card-details">
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-icon">üè†</span>
                          <span class="plan-card-detail-label"><%= t('plans.index.plan_card.farm') %>:</span>
                          <span><%= plan.farm.display_name %></span>
                        </div>
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-icon">üìê</span>
                          <span class="plan-card-detail-label"><%= t('plans.index.plan_card.total_area') %>:</span>
                          <span><%= number_with_delimiter(plan.total_area) %> „é°</span>
                        </div>
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-icon">üåæ</span>
                          <span><%= t('plans.index.plan_card.crops_count', count: @vm.crops_count(plan)) %></span>
                          <span class="plan-card-detail-separator">„Éª</span>
                          <span><%= t('plans.index.plan_card.fields_count', count: @vm.fields_count(plan)) %></span>
                        </div>
                      </div>
                      
                      <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                      <div class="plan-card-actions">
                        <% if plan.status_completed? %>
                          <%= link_to plan_path(plan), 
                              class: "plan-card-action-btn primary" do %>
                            <%= t('plans.index.plan_card.view') %>
                          <% end %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-secondary",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% elsif plan.status_optimizing? %>
                          <%= link_to optimizing_plan_path(plan), 
                              class: "plan-card-action-btn primary" do %>
                            <%= t('plans.index.plan_card.view') %>
                          <% end %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-secondary",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% elsif plan.status_pending? %>
                          <%= link_to plan_path(plan), 
                              class: "plan-card-action-btn primary" do %>
                            <%= t('plans.index.plan_card.view') %>
                          <% end %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-secondary",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% else %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-full",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% end %>
                      </div>
                      
                      <!-- ‰ΩúÊàêÊó• -->
                      <div class="plan-card-meta">
                        <%= t('plans.index.plan_card.created_at') %>: <%= l(plan.created_at, format: :short) %>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <!-- „Åù„ÅÆËæ≤Â†¥„Å´Ë®àÁîª„Åå„Å™„ÅÑÂ†¥Âêà -->
                <div class="content-card">
                  <p class="content-card-empty">
                    <%= t('plans.index.no_plans') %>
                  </p>
                </div>
              <% end %>
            </div>
          </details>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
