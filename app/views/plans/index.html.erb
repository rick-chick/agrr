<% content_for :title, t('plans.index.title') %>

<div class="plans-wrapper">
  <div class="plans-container">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="plans-header">
      <div class="plans-header-main">
        <div>
          <h1 class="plans-header-title">
            <%= t('plans.index.title') %>
          </h1>
          <p class="plans-header-subtitle">
            <%= t('plans.index.subtitle') %>
          </p>
        </div>
        <div>
          <%= link_to new_plan_path, class: "btn-plans-primary" do %>
            <%= t('plans.index.create_new') %>
          <% end %>
        </div>
      </div>
    </div>

    <% if @vm.plans_by_year.empty? %>
      <!-- Ë®àÁîª„Åå„Å™„ÅÑÂ†¥Âêà -->
      <div class="plans-empty">
        <div class="plans-empty-icon">üìÖ</div>
        <h2 class="plans-empty-title">
          <%= t('plans.index.no_plans') %>
        </h2>
        <p class="plans-empty-subtitle">
          <%= t('plans.index.no_plans_hint') %>
        </p>
        <div class="plans-empty-actions">
          <%= link_to new_plan_path, class: "btn-plans-primary" do %>
            <%= t('plans.index.create_new') %>
          <% end %>
          <%= link_to public_plans_path, class: "btn-plans-secondary" do %>
            <%= t('plans.index.try_public_plans') %>
          <% end %>
        </div>
      </div>
    <% else %>
        <!-- Âπ¥Â∫¶Âà•„ÅÆË®àÁîª‰∏ÄË¶ß -->
        <% @vm.available_years.reverse.each_with_index do |year, index| %>
          <% year_plans = @vm.plans_by_year[year] %>

          <div class="plans-year-section">
            <details <%= 'open' if index == 0 %>>
              <summary class="plans-year-title plans-year-summary">
                <span class="year-toggle-icon"></span>
                <span class="plans-year-label"><%= t('plans.index.year_label', year: year) %></span>
                <% if year_plans.present? %>
                  <span class="year-count">
                    (<%= year_plans.count %>‰ª∂)
                  </span>
                <% else %>
                  <span class="year-count year-count-empty">
                    (Ë®àÁîª„Å™„Åó)
                  </span>
                <% end %>
              </summary>
            
            <div class="plans-year-content">
              <% if year_plans.present? %>
                  <div class="plans-grid">
                  <% year_plans.each do |plan| %>
                      <div class="plan-card" id="<%= dom_id(plan) %>" data-undo-delete-record>
                      <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏ -->
                      <div class="plan-card-header">
                        <span class="plan-card-status <%= plan.status %>">
                          <%= t("plans.index.status.#{plan.status}") %>
                        </span>
                      </div>
                      
                      <!-- Ë®àÁîªÂêç -->
                      <h3 class="plan-card-title">
                        <%= plan.display_name %>
                      </h3>
                      
                      <!-- Ëæ≤Â†¥ÊÉÖÂ†± -->
                      <div class="plan-card-details">
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-icon">üè†</span>
                          <span class="plan-card-detail-label"><%= t('plans.index.plan_card.farm') %>:</span>
                          <span><%= plan.farm.display_name %></span>
                        </div>
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-icon">üìê</span>
                          <span class="plan-card-detail-label"><%= t('plans.index.plan_card.total_area') %>:</span>
                          <span><%= number_with_delimiter(plan.total_area) %> „é°</span>
                        </div>
                        <div class="plan-card-detail-item">
                          <span class="plan-card-detail-icon">üåæ</span>
                          <span><%= t('plans.index.plan_card.crops_count', count: @vm.crops_count(plan)) %></span>
                          <span class="plan-card-detail-separator">„Éª</span>
                          <span><%= t('plans.index.plan_card.fields_count', count: @vm.fields_count(plan)) %></span>
                        </div>
                      </div>
                      
                      <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                      <div class="plan-card-actions">
                        <% if plan.status_completed? %>
                          <%= link_to plan_path(plan), 
                              class: "plan-card-action-btn primary" do %>
                            <%= t('plans.index.plan_card.view') %>
                          <% end %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-secondary",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% elsif plan.status_optimizing? %>
                          <%= link_to optimizing_plan_path(plan), 
                              class: "plan-card-action-btn primary" do %>
                            <%= t('plans.index.plan_card.view') %>
                          <% end %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-secondary",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% elsif plan.status_pending? %>
                          <%= link_to plan_path(plan), 
                              class: "plan-card-action-btn primary" do %>
                            <%= t('plans.index.plan_card.view') %>
                          <% end %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-secondary",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% else %>
                          <%= link_to plan_path(plan),
                              class: "plan-card-action-btn danger plan-card-action-btn-full",
                              data: {
                                controller: "undo-delete",
                                action: "click->undo-delete#submit",
                                turbo_method: :delete,
                                undo_delete_url_value: plan_path(plan),
                                undo_delete_message_value: t('plans.undo.toast', name: plan.display_name),
                                undo_delete_redirect_url_value: plans_path
                              } do %>
                            <%= t('plans.index.plan_card.delete') %>
                          <% end %>
                        <% end %>
                      </div>
                      
                      <!-- ‰ΩúÊàêÊó• -->
                      <div class="plan-card-meta">
                        <%= t('plans.index.plan_card.created_at') %>: <%= l(plan.created_at, format: :short) %>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <!-- „Åù„ÅÆÂπ¥Â∫¶„Å´Ë®àÁîª„Åå„Å™„ÅÑÂ†¥Âêà -->
                <div class="content-card">
                  <p class="content-card-empty">
                    <%= t('plans.index.no_plans') %>
                  </p>
                </div>
              <% end %>
            </div>
          </details>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
