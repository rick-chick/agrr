<% content_for :title, @vm.plan.display_name %>

<div class="plans-wrapper">
  <div class="plans-container" id="<%= dom_id(@vm.plan) %>" data-undo-delete-record>
    <!-- ヘッダーアクション -->
    <div class="action-bar">
      <%= link_to plans_path, class: "btn btn-ghost" do %>
        <%= t('plans.show.back_to_list') %>
      <% end %>
      <div class="action-bar-group">
        <%= link_to t('plans.show.view_task_schedule'), plan_task_schedule_path(@vm.plan),
            class: "btn btn-ghost" %>
        <%= link_to t('plans.show.delete'), plan_path(@vm.plan),
            class: "btn btn-error",
            data: {
              controller: "undo-delete",
              action: "click->undo-delete#submit",
              turbo_method: :delete,
              undo_delete_url_value: plan_path(@vm.plan),
              undo_delete_message_value: t('plans.undo.toast', name: @vm.plan.display_name),
              undo_delete_redirect_url_value: plans_path
            } %>
      </div>
    </div>

    <!-- サマリーカード -->
    <div class="content-card">
      <div class="content-card-header">
        <h1 class="content-card-header-title">
          <%= @vm.plan.display_name %>
        </h1>
        <span class="plan-card-status completed">
          <%= t('plans.show.header.badge') %>
        </span>
      </div>
      
      <p class="content-card-description">
        <%= t('plans.show.header.subtitle', count: @vm.plan.field_cultivations.count) %>
      </p>
      
      <!-- 統計情報グリッド -->
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.farm') %>
          </div>
          <div class="stat-value">
            <%= @vm.plan.farm.display_name %>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.total_area') %>
          </div>
          <div class="stat-value">
            <%= number_with_delimiter(@vm.plan.total_area) %> ㎡
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.field_count') %>
          </div>
          <div class="stat-value">
            <%= t('plans.show.header.field_count_value', count: @vm.plan.cultivation_plan_fields.count) %>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.planning_period') %>
          </div>
          <div class="stat-value">
            <%= t('plans.show.header.planning_period_value', 
                   start: @vm.plan.planning_start_date.year,
                   end: @vm.plan.planning_end_date.year) %>
          </div>
        </div>
      </div>
    </div>

    <!-- ガントチャート（表示範囲ツールバーをヘッダーに集約） -->
    <div class="plans-gantt-panel plans-gantt-section" data-controller="plans-show">
      <div class="plans-gantt-panel-header">
        <div class="plans-gantt-panel-label">
          <div class="gantt-title-subtext">
            <%= t('plans.show.display_range.title') %>
          </div>
        </div>

        <div class="display-range-toolbar">
          <div class="display-range-toolbar-left">
            <div class="display-range-quick-buttons">
              <div class="display-range-button-group display-range-button-group-move">
                <button type="button" 
                        class="btn btn-ghost btn-sm display-range-btn display-range-btn-move" 
                        data-display-range-action="month-back">
                  <%= t('plans.show.display_range.quick_select.month_back') %>
                </button>
                <button type="button" 
                        class="btn btn-ghost btn-sm display-range-btn display-range-btn-move" 
                        data-display-range-action="month-forward">
                  <%= t('plans.show.display_range.quick_select.month_forward') %>
                </button>
              </div>
              <div class="display-range-button-divider"></div>
              <div class="display-range-button-group display-range-button-group-range">
                <button type="button" 
                        class="btn btn-ghost btn-sm display-range-btn display-range-btn-range" 
                        data-display-range-action="range-1year">
                  <%= t('plans.show.display_range.quick_select.range_1year') %>
                </button>
                <button type="button" 
                        class="btn btn-ghost btn-sm display-range-btn display-range-btn-range" 
                        data-display-range-action="range-2year">
                  <%= t('plans.show.display_range.quick_select.range_2year') %>
                </button>
                <button type="button" 
                        class="btn btn-ghost btn-sm display-range-btn display-range-btn-range" 
                        data-display-range-action="full-range">
                  <%= t('plans.show.display_range.quick_select.full_range') %>
                </button>
              </div>
            </div>
          </div>
          <div class="display-range-toolbar-right">
            <div class="display-range-date-inputs">
              <div class="display-range-date-input-group">
                <label class="display-range-date-label"><%= t('plans.show.display_range.start_date') %></label>
                <input type="date" 
                       id="display-start-date" 
                       class="display-range-date-input"
                       value="<%= @vm.plan.planning_start_date&.strftime('%Y-%m-%d') %>"
                       min="<%= @vm.plan.planning_start_date&.strftime('%Y-%m-%d') %>"
                       max="<%= @vm.plan.planning_end_date&.strftime('%Y-%m-%d') %>">
              </div>
              <div class="display-range-date-input-group">
                <label class="display-range-date-label"><%= t('plans.show.display_range.end_date') %></label>
                <input type="date" 
                       id="display-end-date" 
                       class="display-range-date-input"
                       value="<%= @vm.plan.planning_end_date&.strftime('%Y-%m-%d') %>"
                       min="<%= @vm.plan.planning_start_date&.strftime('%Y-%m-%d') %>"
                       max="<%= @vm.plan.planning_end_date&.strftime('%Y-%m-%d') %>">
              </div>
              <div class="display-range-apply-wrapper">
                <button type="button" 
                        id="apply-display-range" 
                        class="btn btn-ghost btn-sm display-range-apply-btn">
                  <%= t('plans.show.display_range.apply') %>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="plans-gantt-panel-body">
        <%= render 'shared/gantt_chart', 
                   cultivation_plan: @vm.plan,
                   show_crop_palette: true,
                   plan_type: 'private',
                   data_url: data_api_v1_plans_cultivation_plan_path(@vm.plan),
                   adjust_url: adjust_api_v1_plans_cultivation_plan_path(@vm.plan),
                   add_field_url: add_field_api_v1_plans_cultivation_plan_path(@vm.plan),
                   remove_field_url: remove_field_api_v1_plans_cultivation_plan_path(id: @vm.plan.id, field_id: 'PLACEHOLDER'),
                   add_crop_url: add_crop_api_v1_plans_cultivation_plan_path(@vm.plan),
                   optimization_channel: 'PlansOptimizationChannel',
                   gantt_title: t('plans.show.gantt.title'),
                   detail_title: t('plans.show.detail.title'),
                   detail_loading: t('plans.show.detail.loading'),
                   crop_palette_toggle_label: t('plans.show.crop_palette.toggle', default: '作物を追加'),
                   crop_palette_title: t('plans.show.crop_palette.title', default: '作物を追加'),
                   crop_palette_in_use_label: t('plans.show.crop_palette.in_use', default: '使用中') %>
      </div>
    </div>
  </div>
</div>

<% content_for :javascripts do %>
  <%= javascript_include_tag "gantt_data_utils", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "crop_colors", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "custom_gantt_chart", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "crop_palette_drag", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "crop_palette_style", "data-turbo-track": "reload" %>
<% end %>
