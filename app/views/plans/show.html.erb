<% content_for :title, @vm.plan.display_name %>

<div class="plans-wrapper">
  <div class="plans-container" id="<%= dom_id(@vm.plan) %>" data-undo-delete-record>
    <!-- ヘッダーアクション -->
    <div class="action-bar">
      <%= link_to plans_path, class: "btn btn-ghost" do %>
        <%= t('plans.show.back_to_list') %>
      <% end %>
      <div class="action-bar-group">
        <%= link_to t('plans.show.view_task_schedule'), plan_task_schedule_path(@vm.plan),
            class: "btn btn-ghost" %>
        <%= link_to t('plans.show.delete'), plan_path(@vm.plan),
            class: "btn btn-error",
            data: {
              controller: "undo-delete",
              action: "click->undo-delete#submit",
              turbo_method: :delete,
              undo_delete_url_value: plan_path(@vm.plan),
              undo_delete_message_value: t('plans.undo.toast', name: @vm.plan.display_name),
              undo_delete_redirect_url_value: plans_path
            } %>
      </div>
    </div>

    <!-- サマリーカード -->
    <div class="content-card">
      <div class="content-card-header">
        <h1 class="content-card-header-title">
          <%= @vm.plan.display_name %>
        </h1>
        <span class="plan-card-status completed">
          <%= t('plans.show.header.badge') %>
        </span>
      </div>
      
      <p class="content-card-description">
        <%= t('plans.show.header.subtitle', count: @vm.plan.field_cultivations.count) %>
      </p>
      
      <!-- 統計情報グリッド -->
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.farm') %>
          </div>
          <div class="stat-value">
            <%= @vm.plan.farm.display_name %>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.total_area') %>
          </div>
          <div class="stat-value">
            <%= number_with_delimiter(@vm.plan.total_area) %> ㎡
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.field_count') %>
          </div>
          <div class="stat-value">
            <%= t('plans.show.header.field_count_value', count: @vm.plan.cultivation_plan_fields.count) %>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">
            <%= t('plans.show.header.planning_period') %>
          </div>
          <div class="stat-value">
            <%= t('plans.show.header.planning_period_value', 
                   start: @vm.plan.planning_start_date.year,
                   end: @vm.plan.planning_end_date.year) %>
          </div>
        </div>
      </div>
    </div>

    <!-- 表示範囲選択 -->
    <div class="content-card">
      <h3 class="content-card-title">表示範囲の設定</h3>
      <div class="plans-form-group">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <div>
            <label class="plans-form-label">開始日</label>
            <input type="date" 
                   id="display-start-date" 
                   class="plans-form-input"
                   value="<%= @vm.plan.planning_start_date&.strftime('%Y-%m-%d') %>"
                   min="<%= @vm.plan.planning_start_date&.strftime('%Y-%m-%d') %>"
                   max="<%= @vm.plan.planning_end_date&.strftime('%Y-%m-%d') %>">
          </div>
          <div>
            <label class="plans-form-label">終了日</label>
            <input type="date" 
                   id="display-end-date" 
                   class="plans-form-input"
                   value="<%= @vm.plan.planning_end_date&.strftime('%Y-%m-%d') %>"
                   min="<%= @vm.plan.planning_start_date&.strftime('%Y-%m-%d') %>"
                   max="<%= @vm.plan.planning_end_date&.strftime('%Y-%m-%d') %>">
          </div>
          <div style="margin-top: 1.5rem;">
            <button type="button" 
                    id="apply-display-range" 
                    class="btn btn-primary">
              適用
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ガントチャート -->
    <div class="plans-gantt-section" data-controller="plans-show">
      <%= render 'shared/gantt_chart', 
                 cultivation_plan: @vm.plan,
                 show_crop_palette: true,
                 plan_type: 'private',
                 data_url: data_api_v1_plans_cultivation_plan_path(@vm.plan),
                 adjust_url: adjust_api_v1_plans_cultivation_plan_path(@vm.plan),
                 add_field_url: add_field_api_v1_plans_cultivation_plan_path(@vm.plan),
                 remove_field_url: remove_field_api_v1_plans_cultivation_plan_path(id: @vm.plan.id, field_id: 'PLACEHOLDER'),
                 add_crop_url: add_crop_api_v1_plans_cultivation_plan_path(@vm.plan),
                 optimization_channel: 'PlansOptimizationChannel',
                 gantt_title: t('plans.show.gantt.title'),
                 detail_title: t('plans.show.detail.title'),
                 detail_loading: t('plans.show.detail.loading'),
                 crop_palette_toggle_label: t('plans.show.crop_palette.toggle', default: '作物を追加'),
                 crop_palette_title: t('plans.show.crop_palette.title', default: '作物を追加'),
                 crop_palette_in_use_label: t('plans.show.crop_palette.in_use', default: '使用中') %>
    </div>
  </div>
</div>

<!-- JSはesbuildのapplication.jsにバンドルされます -->
