<% content_for :title, t('plans.show.header.title', year: @cultivation_plan.plan_year) %>

<div class="plans-wrapper">
  <div class="plans-container">
    <!-- ヘッダーアクション -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); gap: var(--space-3); flex-wrap: wrap;">
      <%= link_to plans_path, class: "btn-plans-secondary" do %>
        <%= t('plans.show.back_to_list') %>
      <% end %>
      <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
        <% if @cultivation_plan.status_pending? %>
          <%= button_to t('plans.show.optimize_button'), optimize_plan_path(@cultivation_plan), method: :post,
              class: "btn-plans-primary",
              data: { confirm: "この計画を最適化しますか？" } %>
        <% end %>
        <%= button_to t('plans.show.copy_plan'), copy_plan_path(@cultivation_plan), method: :post,
            class: "btn-plans-secondary",
            data: { confirm: "次年度（#{@cultivation_plan.plan_year + 1}年度）にこの計画をコピーしますか？" } %>
      </div>
    </div>

    <!-- サマリーカード -->
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); flex-wrap: wrap; gap: var(--space-4);">
        <h1 style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--text-primary); margin: 0;">
          <%= t('plans.show.header.title', year: @cultivation_plan.plan_year) %>
        </h1>
        <span class="plan-card-status completed">
          <%= t('plans.show.header.badge') %>
        </span>
      </div>
      
      <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">
        <%= t('plans.show.header.subtitle', count: @cultivation_plan.field_cultivations.count) %>
      </p>
      
      <!-- 統計情報グリッド -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
        <div>
          <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
            <%= t('plans.show.header.farm') %>
          </div>
          <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--text-primary);">
            <%= @cultivation_plan.farm.display_name %>
          </div>
        </div>
        <div>
          <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
            <%= t('plans.show.header.total_area') %>
          </div>
          <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--text-primary);">
            <%= number_with_delimiter(@cultivation_plan.total_area) %> ㎡
          </div>
        </div>
        <div>
          <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
            <%= t('plans.show.header.field_count') %>
          </div>
          <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--text-primary);">
            <%= t('plans.show.header.field_count_value', count: @cultivation_plan.cultivation_plan_fields.count) %>
          </div>
        </div>
        <div>
          <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
            <%= t('plans.show.header.planning_period') %>
          </div>
          <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--text-primary);">
            <%= t('plans.show.header.planning_period_value', 
                   start: @cultivation_plan.planning_start_date.year,
                   end: @cultivation_plan.planning_end_date.year) %>
          </div>
        </div>
      </div>
    </div>

    <!-- ガントチャートカード -->
    <div class="content-card">
      <%= render 'shared/gantt_chart', 
                 cultivation_plan: @cultivation_plan,
                 show_crop_palette: true,
                 plan_type: 'private',
                 data_url: data_api_v1_plans_cultivation_plan_path(@cultivation_plan),
                 adjust_url: adjust_api_v1_plans_cultivation_plan_path(@cultivation_plan),
                 add_field_url: add_field_api_v1_plans_cultivation_plan_path(@cultivation_plan),
                 remove_field_url: remove_field_api_v1_plans_cultivation_plan_path(id: @cultivation_plan.id, field_id: 'PLACEHOLDER'),
                 add_crop_url: add_crop_api_v1_plans_cultivation_plan_path(@cultivation_plan),
                 optimization_channel: 'PlansOptimizationChannel',
                 gantt_title: t('plans.show.gantt.title'),
                 detail_title: t('plans.show.detail.title'),
                 detail_loading: t('plans.show.detail.loading'),
                 crop_palette_toggle_label: t('plans.show.crop_palette.toggle', default: '作物を追加'),
                 crop_palette_title: t('plans.show.crop_palette.title', default: '作物を追加'),
                 crop_palette_in_use_label: t('plans.show.crop_palette.in_use', default: '使用中') %>
    </div>
  </div>
</div>

<!-- JavaScript is loaded from app/assets/javascripts/ -->
<% content_for :javascripts do %>
  <%# ガントチャートデータ変換ユーティリティ（最初に読み込み） %>
  <%= javascript_include_tag "gantt_data_utils", defer: true, "data-turbo-track": "reload" %>
  <%# 作物色管理システム %>
  <%= javascript_include_tag "crop_colors", defer: true, "data-turbo-track": "reload" %>
  <%# ガントチャート（色パレット管理を含む） %>
  <%= javascript_include_tag "custom_gantt_chart", defer: true, "data-turbo-track": "reload" %>
  <%# 作物パレットのドラッグ&ドロップ %>
  <%= javascript_include_tag "crop_palette_drag", defer: true, "data-turbo-track": "reload" %>
  <%# 作物パレットのスタイル適用 %>
  <%= javascript_include_tag "crop_palette_style", defer: true, "data-turbo-track": "reload" %>
  <%# その他の機能 %>
  <%= javascript_include_tag "plans_show", defer: true, "data-turbo-track": "reload" %>
<% end %>
