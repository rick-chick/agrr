<% content_for :title, "#{t('.title')} - AGRR" %>

<div class="page-header">
  <h1 class="page-title"><%= t('.title') %></h1>
  <%= link_to t('.new_agricultural_task'), new_agricultural_task_path, class: "btn btn-success" %>
</div>

<div class="agricultural-tasks-toolbar">
  <div class="agricultural-task-search">
    <%= form_with url: agricultural_tasks_path, method: :get, local: true, class: "agricultural-task-search-form" do |f| %>
      <%= f.label :query, t('.search_label'), class: "visually-hidden" %>
      <%= f.search_field :query,
                         id: 'agricultural-task-search',
                         value: @query,
                         placeholder: t('.search_placeholder'),
                         class: "form-control" %>
      <%= f.hidden_field :filter, value: @selected_filter if @selected_filter.present? %>
      <%= f.submit t('.actions.search'), class: "btn btn-primary" %>
    <% end %>
  </div>

  <% if admin_user? %>
    <div class="agricultural-task-filters">
      <%= form_with url: agricultural_tasks_path, method: :get, local: true, class: "agricultural-task-filters-form" do |f| %>
        <%= f.hidden_field :query, value: @query if @query.present? %>

        <%= button_tag t('.filters.user_tasks'),
                       type: :submit,
                       name: :filter,
                       value: 'user',
                       class: ["btn", "btn-outline-primary", ("is-active" if @selected_filter == 'user')].compact.join(' ') %>

        <%= button_tag t('.filters.reference_tasks'),
                       type: :submit,
                       name: :filter,
                       value: 'reference',
                       class: ["btn", "btn-outline-primary", ("is-active" if @selected_filter == 'reference')].compact.join(' ') %>

        <%= button_tag t('.filters.all_tasks'),
                       type: :submit,
                       name: :filter,
                       value: 'all',
                       class: ["btn", "btn-outline-primary", ("is-active" if @selected_filter == 'all')].compact.join(' ') %>
      <% end %>
    </div>
  <% end %>
</div>

<% if @agricultural_tasks.any? %>
  <div class="agricultural-tasks-grid">
    <% @agricultural_tasks.each do |task| %>
      <div class="agricultural-task-card" id="<%= dom_id(task) %>" data-undo-delete-record>
        <div class="agricultural-task-card__header">
          <h3 class="agricultural-task-name"><%= task.name %></h3>
          <% if admin_user? && task.is_reference %>
            <span class="agricultural-task-type reference"><%= t('.reference_task') %></span>
          <% elsif !task.is_reference %>
            <span class="agricultural-task-type user"><%= t('.user_task_tag') %></span>
          <% end %>
        </div>

        <% if task.description.present? %>
          <p class="agricultural-task-description"><%= truncate(task.description, length: 80) %></p>
        <% end %>

        <% if task.time_per_sqm.present? %>
          <div class="agricultural-task-meta">
            <span class="agricultural-task-meta__icon">⏱</span>
            <span class="agricultural-task-meta__label"><%= t('.time_per_sqm') %></span>
            <span class="agricultural-task-meta__value"><%= task.time_per_sqm %> h/㎡</span>
          </div>
        <% end %>

        <div class="agricultural-task-actions">
          <%= link_to t('.actions.show'), agricultural_task_path(task), class: "btn btn-info btn-sm" %>

          <% if task.is_reference %>
            <% if admin_user? %>
              <%= link_to t('.actions.edit'), edit_agricultural_task_path(task), class: "btn btn-secondary btn-sm" %>
              <%= link_to t('.actions.delete'), agricultural_task_path(task),
                          class: "btn btn-error btn-sm",
                          data: {
                            controller: "undo-delete",
                            action: "click->undo-delete#submit",
                            turbo_method: :delete,
                            undo_delete_url_value: agricultural_task_path(task),
                            undo_delete_message_value: t('agricultural_tasks.undo.toast', name: task.name),
                            undo_delete_redirect_url_value: agricultural_tasks_path
                          } %>
            <% end %>
          <% else %>
            <%= link_to t('.actions.edit'), edit_agricultural_task_path(task), class: "btn btn-secondary btn-sm" %>
            <%= link_to t('.actions.delete'), agricultural_task_path(task),
                        class: "btn btn-error btn-sm",
                        data: {
                          controller: "undo-delete",
                          action: "click->undo-delete#submit",
                          turbo_method: :delete,
                          undo_delete_url_value: agricultural_task_path(task),
                          undo_delete_message_value: t('agricultural_tasks.undo.toast', name: task.name),
                          undo_delete_redirect_url_value: agricultural_tasks_path
                        } %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-state">
    <div class="empty-state-icon"><%= t('.empty.icon') %></div>
    <h3><%= t('.empty.title') %></h3>
    <p><%= t('.empty.description') %></p>
    <%= link_to t('.empty.button'), new_agricultural_task_path, class: "btn btn-success" %>
  </div>
<% end %>








