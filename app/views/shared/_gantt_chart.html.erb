<%# app/views/shared/_gantt_chart.html.erb %>
<%# å…±é€šã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ %>
<%# 
  ä½¿ã„æ–¹:
  render 'shared/gantt_chart', 
         cultivation_plan: @cultivation_plan,
         show_crop_palette: true,
         plan_type: 'public'
  
  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  - cultivation_plan: CultivationPlanã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå¿…é ˆï¼‰
  - show_crop_palette: ä½œç‰©ãƒ‘ãƒ¬ãƒƒãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false)
  - plan_type: 'public' ã¾ãŸã¯ 'private' (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'public')
%>

<%
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
  show_crop_palette ||= false
  plan_type ||= 'public'
  
  # æ ½åŸ¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœŸé–“ã®è¨ˆç®—
  plan_start_date = cultivation_plan.planning_start_date || Date.current
  plan_end_date = cultivation_plan.planning_end_date
  
  # Frappe Ganttç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
  cultivation_data = cultivation_plan.field_cultivations.map do |fc|
    {
      id: fc.id,
      field_id: fc.cultivation_plan_field_id,
      field_name: fc.field_display_name,
      crop_id: fc.cultivation_plan_crop_id,
      crop_name: fc.crop_display_name,
      start_date: fc.start_date.to_s,
      completion_date: fc.completion_date.to_s,
      cultivation_days: fc.cultivation_days,
      area: fc.area,
      estimated_cost: fc.estimated_cost,
      profit: fc.optimization_result&.dig('profit')
    }
  end
  
  # åœƒå ´æƒ…å ±ã‚’æº–å‚™
  fields_data = cultivation_plan.cultivation_plan_fields.map do |field|
    {
      id: field.id,
      field_id: field.id,
      name: field.name,
      area: field.area
    }
  end
  
  
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
  gantt_title ||= t('plans.show.gantt.title', default: 'ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ')
  detail_title ||= t('plans.show.detail.title', default: 'æ ½åŸ¹è©³ç´°')
  detail_loading ||= t('plans.show.detail.loading', default: 'èª­ã¿è¾¼ã¿ä¸­...')
%>

<div class="gantt-section">
  <div class="gantt-header">
    <h2 class="gantt-title">
      <span class="gantt-title-icon">ğŸ“Š</span>
      <span class="gantt-title-text"><%= gantt_title %></span>
    </h2>
    <div class="gantt-header-actions">
      <%# ä½œç‰©ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆpublic_plansã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ %>
      <% if show_crop_palette %>
        <%= render 'shared/crop_palette', 
                   cultivation_plan: cultivation_plan,
                   crop_palette_toggle_label: crop_palette_toggle_label,
                   crop_palette_title: crop_palette_title,
                   crop_palette_in_use_label: crop_palette_in_use_label %>
      <% end %>
    </div>
  </div>

  <div id="gantt-chart-scroll-area" class="gantt-chart-scroll-area">
    <div class="gantt-chart-canvas">
      <div id="gantt-chart-container"
           data-cultivations="<%= cultivation_data.to_json %>"
           data-fields="<%= fields_data.to_json %>"
           data-plan-start-date="<%= plan_start_date.to_s %>"
           data-plan-end-date="<%= plan_end_date.to_s %>"
           data-cultivation-plan-id="<%= cultivation_plan.id %>"
           data-plan-type="<%= plan_type %>"
           <%# API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå‘¼ã³å‡ºã—å´ã§è¨­å®šï¼‰ %>
           data-data-url="<%= data_url %>"
           data-adjust-url="<%= adjust_url %>"
           data-add-field-url="<%= add_field_url %>"
           data-remove-field-url="<%= remove_field_url %>"
           data-add-crop-url="<%= add_crop_url %>"
           data-optimization-channel="<%= optimization_channel %>"
           data-api-endpoint-missing="<%= t('js.gantt.api_endpoint_missing') %>"
           data-data-url-missing="<%= t('js.gantt.data_url_missing') %>"
           data-adjust-url-missing="<%= t('js.gantt.adjust_url_missing') %>"
           data-prompt-field-name="<%= t('js.gantt.prompt_field_name') %>"
           data-prompt-field-area="<%= t('js.gantt.prompt_field_area') %>"
           data-adding-field="<%= t('js.gantt.adding_field') %>"
           data-deleting-field="<%= t('js.gantt.deleting_field') %>"
           data-error-occurred="<%= t('js.gantt.error_occurred') %>">
      </div>
    </div>
  </div>

  <div id="gantt-chart-fallback" class="gantt-chart-fallback" hidden>
    <span class="gantt-fallback-icon" aria-hidden="true">ğŸ“±</span>
    <span class="gantt-fallback-text"><%= t('plans.gantt.fallback.message') %></span>
  </div>
  
  <%# è©³ç´°ãƒ‘ãƒãƒ«ï¼ˆä½œç‰©ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è¡¨ç¤ºï¼‰ %>
  <div id="detail-panel" style="margin-top: var(--space-6); display: none;">
    <div style="background: var(--color-gray-50); border-radius: var(--radius-lg); padding: var(--space-6);">
      <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--text-primary); margin-bottom: var(--space-4);">
        <%= detail_title %>
      </h3>
      <div id="detail-content">
        <%= detail_loading %>
      </div>
    </div>
  </div>
  
  <%# Google AdSense åºƒå‘Šï¼ˆpublic_plansã®å ´åˆã®ã¿ï¼‰ %>
  <% if plan_type == 'public' %>
    <%= render 'shared/adsense_display_ad', ad_slot: '0000000000', ad_format: 'horizontal' %>
  <% end %>
</div>

